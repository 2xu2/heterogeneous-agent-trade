\documentclass[12pt,pdftex]{article}
\usepackage[pdftex]{graphicx,color}
\usepackage{setspace,palatino,multirow}
\usepackage{amsmath,amssymb}
\usepackage{titlesec}
\usepackage{lscape}
%\usepackage{subfigure}
\usepackage{threeparttable}
\usepackage{natbib}
\bibliographystyle{ecta}
\usepackage{cite}
\usepackage{booktabs}
\usepackage{subcaption}
\usepackage{pdflscape}
\usepackage{afterpage}
\usepackage{xcolor}
\usepackage{rotating}

\definecolor{nblue}{RGB}{0,0,128}

\usepackage[pdftex,colorlinks=true, bookmarks=false,
pdfstartview={XYZ null null 0.65},
pdftitle={Heterogeneous Agent Trade},
pdfauthor={ Michael E. Waugh},
pdfkeywords={economics, trade, dynamics, quant econ, consumption, data science, cars,
waugh, incomplete markets, inequality, Ricardo, julia, migration, China, trade war, tariffs, python, matplotlib,
auto, difference in difference },
colorlinks=true,linkcolor=darkgray,citecolor=darkgray,urlcolor=darkgray,
breaklinks]{hyperref}

\newcounter{saveeqni}%
\newcounter{saveeqn01i}%
\newcommand{\alpheqni}{\setcounter{saveeqni}{\value{section}}%
%\setcounter{saveeqn01i}{\value{subsectioni}}%
\renewcommand{\theequation}
    {\alph{saveeqni}\mbox{.\arabic{equation}}}}%
\newcommand{\reseteqni}{\setcounter{equation}{\value{saveeqni}}%
\renewcommand{\theequation}{\arabic{equation}}}%

\newtheorem{as}{Assumption}
\newtheorem{reg}{Regularity Condition}
\newtheorem{conjecture}{Conjecture}
\newtheorem{corr}{Corollary}
\newtheorem{df}{Definition}
\newtheorem{lemma}{Lemma}
\newtheorem{prp}{Proposition}
\newtheorem{rmk}{Remark}
\newenvironment{prf}{{\bf Proof}}{\hfill { }}

\DeclareMathOperator*{\plim}{plim}
\DeclareMathOperator*{\umax}{max}

\special{papersize=8.5in,11in}
\onehalfspacing
\setlength{\parindent}{0.1em}
\setlength{\parskip}{.09in}
\textwidth15.75cm
\evensidemargin 1.5in
\oddsidemargin 1.5in
\topmargin 8.5cm
\textheight 10in
\hyphenation{over-lapping}

\titleformat{\section}{\color{black}\large\bf}{\color{black}{\thesection.}}{.25cm}{}
\titleformat{\subsection}{\color{black}\normalsize\bf}{\thesubsection.}{.5em}{}
\titleformat{\subsubsection}{\color{black}\normalsize\bf}{\thesubsubsection.}{.5em}{}

\titlespacing{\section}{0pt}{*1.5}{*.5}
\titlespacing{\subsection}{0pt}{*1.5}{*.5}
\titlespacing{\subsubsection}{0pt}{*1.5}{*.5}

\def\thesection{\arabic{section}}
\def\thesubsection{\arabic{section}.\arabic{subsection}}
\def\thesubsubsection{\arabic{section}.\arabic{subsection}.\Alph{subsubsection}}

\def\citeapos#1{\citeauthor{#1}'s (\citeyear{#1})}

\renewcommand{\arraystretch}{1.1}
\usepackage[margin=2cm]{geometry}

\begin{document}

\begin{onehalfspacing}

{\large \textbf{Heterogeneous Agent Trade}}

\vspace{1cm}

%{\textbf{PRELIMINARY AND INCOMPLETE}}
%
%\vspace{1cm}

\href{http://www.waugheconomics.com/}{Michael E. Waugh} \\ Federal Reserve Bank of Minneapolis and NBER

\vspace{0.5cm}

April 2022

\vspace{1.5cm}


\normalsize

ABSTRACT ------------------------------------------------------------------------------------------------------------

This paper develops a model of heterogenous agents and international trade. Heterogenous agents are modeled as in the standard incomplete markets tradition with household's facing incomplete insurance against idiosyncratic productivity and taste shocks. Trade in goods follows the Armington tradition but is derived from the ``bottom up'' with micro-level heterogeneity shaping the aggregate pattern of trade. In the efficient allocation, I recover standard results regarding gravity and the gains from trade. In the decentralized allocation, the pattern of trade is distorted, the aggregate trade elasticity is non-constant and the benefits from globalization are distributed unequally. I use model to explore two issues: the ability of trade policy to improve outcomes and how financial globalization complements trade in goods.

------------------------------------------------------------------------------------------------------------------------------
%%\vspace{0.25cm}
%
%%JEL Classification:
%%
%%
%%Keywords:

\vspace{6.5cm}

\footnotesize Email: michael.e.waugh@gmail.com. The views expressed herein are those of the author and not necessarily those of the Federal
Reserve Bank of Minneapolis or the Federal Reserve System. This project was developed with research support from the National Science Foundation (NSF Award number 1948800).

\hspace{-0.05cm}



\thispagestyle{empty}
\newpage
\normalsize

\section{The Model}

The model is setup in a simple and transparent way. Trade is in the Armigton tradition with each country producing a nationally differentiated variety. Households follow the standard incomplete markets tradition. The key departure is that I lean into household heterogeneity and have households make a discrete choice over the varieties they consume. Aggregate trade flows between countries are, thus, given by the explicit aggregation of households and the choices they make.

\subsection{Trade and Production}\label{sec:trade}

There are $M$ locations which I will call a country. Each country produces a differentiated product as in the Armington tradition and these differentiated products. In country $i$, competitive firms have the following production technology to produce variety $i$:
\begin{align}
q_i = A_i N_i,
\label{eq:production}
\end{align}
where $N_i$ are the efficiency units of labor supplied by households in country $i$.

Trade faces several obstacles. There are iceberg trade costs $d_{ji}$ for a good to go from supplier $i$ to buyer $j$. Cross-border trade faces policy obstacles, i.e. tariffs $\tau_{ji}$. The notation here is such that $\tau_{ji}$ which is the ad-valorem tariff rate that country $j$ imposes on the commodity that county $i$ produces.

Profit maximization of the competitive goods producers in location $i$ results in the wage per efficiency unit reflecting the value of the marginal product of labor
\begin{align}
w_{i} = p_{i} A_{i}.
\label{eq:marginal-product}
\end{align}
Given iceberg trade costs and tariffs, the unit cost for country $j$ to purchase a good from location $i$ is
\begin{align}
p_{ji} = \frac{d_{ji}(1 +\tau_{ji})w_{i}}{A_{i}}.
\label{eq:marginal-product-ship}
\end{align}

\subsection{Households}

There is a mass of $L_i$ households in each location $i$. Households are immobile across countries. They are infinite lived and have time-sparable preferences over non-durable consumption varieties:
\begin{align}
\small
E_{0} \sum_{t = 0}^{\infty} \beta^{t} u( \{ c_{jt} \}_{M}),
\end{align}
where the notation $\{ c_{jt} \}_{M}$ means that the household has preferences over all $j$ varieties supplied by $M$ countries in the world. My focus is on the situation where households each period receive additive Type 1 extreme value shocks $\epsilon(j)$ with dispersion parameter $\sigma_{\epsilon}$ and then households make a discrete choice about which variety $j$ to each period and a continuous choice about how much. More specifically, the utility associated with the choice of variety $j$ and leisure is
\begin{align}
u( c(j)_t ) =  \frac{ c_{jt} ^{1-\gamma}}{1- \gamma} + \epsilon(j)_t. \label{eq:utility}
\end{align}
where consumption mapped into utils with a standard CRRA function, $\epsilon(j)$ is the taste shock.

A household's efficiency units are stochastic and they evolve according to a discrete state Markov chain. Mathematically, $z$ is a households efficiently units and $\mathcal{P}(z,z')$ describes the probability of a household with state $z$ efficiency units transiting to state $z'$.

Households can save and borrow in a non-state contingent asset $a$. The units of the asset are chosen to be the numeraire and pays out with gross interest rate $R$. I discuss this more in depth below, but the determination of $R_{i}$ is either exogenously given or the rate that clears the bond market (local or global). An country specific, exogenous debt limit $\phi_{i}$ constrains borrowing so:
\begin{align}
a_{t+1} \geq - \phi_{i}.
\label{eq:borrowing-constraint}
\end{align}
All these pieces come together in the household's budget constraint, conditional on choosing variety $j$ to consume, and focusing on a stationary setting where prices and transfers are constant:
\begin{align}
a_{t+1} + p_{ij}c_{jt}  \leq    R_{i} a_{t} + w_{i} z_{t} + T_{i,\tau}.\label{eq:trade-budget-constraint}
\end{align}
The value of asset purchases and consumption expenditures must be less than or equal to asset payments, labor earnings, and transfers arising from trade policy (the $T_{i,\tau}$).

\subsection{Recursive Formulation of the Household Problem}

The state variables of a individual household are it's asset holdings and efficiency units. The aggregate states (and outcomes in other countries) only matter through prices and transfers and thus I summarize the aggregate state in country $i$ as $S_i = (\{ w_i \}_{M}, T_i, R_{i})$ which is the collection of the wage per efficiency units, transfers, and interest rates. The wage vector $\{ w_i \}_{M}$ is sufficient here since they determine prices in (\ref{eq:marginal-product-ship}) and, thus, consumers can make the appropriate choice of commodities.

The value function of a household in country $i$ is
\begin{align}
v_{i}(a, z; S_i) = &  \max_{j} \big  \{ \  v_{ij}(a, z; S_i)  \ \big \}
\label{eq:valuefun}
\end{align}
which is the maximum across the discrete choices of different national varieties. The value function conditional on a choice of variety is
\begin{align}
v_{ij}(a, z;  S_i  ) = &  \max_{\ a' }\bigg  \{ u(c(j))  + \beta \, \mathbb{E} [v_{i}(a', z'; S_i' )]  \bigg\}
\label{eq:value_fun_option} \\
\nonumber \\
\mbox{subject to}  \ & (\ref{eq:trade-budget-constraint}) \  \mathrm{and} \ (\ref{eq:borrowing-constraint}) \nonumber
\end{align}
where households choose asset holdings and the level of consumption is residually determined through the budget constraint. The continuation value function is the expectation over (\ref{eq:valuefun}) where the expectation is taken with respect to $z'$ and taste shocks in the future. What this last point means is that households understand that their may be situations where, e.g., they really desire the high priced imported good and, hence, save accordingly.

As is well known, the Type 1 extreme value shocks give rise to the following choice probabilities for each differentiated good. So
\begin{align}
\pi_{ij}(a, z; S_i) = \exp \left( \frac{ v_{ij}(a, z;  S_i ) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ v_{ij'}(a, z;  S_i ) }{\sigma_{\epsilon}} \right) \label{eq:choice-prob}
\end{align}
which is the probability that a household with assets $a$ and efficiency units $z$ chooses country variety $j$. And then the expectation of (\ref{eq:valuefun}) with respect to the taste shocks takes the familiar log-sum form
\begin{align}
\mathbb{E}_{\epsilon} v_i(a, z; S_i) = \sigma_{\epsilon} \log \left\{ \sum_{j'} \exp \left( \frac{  v_{ij}(a, z;  S_i )}{\sigma_{\epsilon}} \right) \right\} \label{eq:log_sum}
\end{align}
Associated with the problem (\ref{eq:valuefun}) are an asset policy function $g_{ij}(a, z; S_i)$ which prescribes asset holdings given a state and variety choice, and then define $c_{ij}(a, z; S_i)$ as the consumption function which prescribes consumption given states and variety choice.

\subsection{Aggregation}

Define the probability distribution of households across individual states $\lambda_{i}(a, z; S_i )$ which is the probability measure of households with asset levels $a$ individual shock $z$ in country $i$. This distribution evolves according to
\begin{align}
\lambda_i(a', z', S_i') = \sum_{z}\sum_{j} \sum_{a: a' = g_{ij}(a, z; S_i)} \pi_{ij}(a, z; S_i) \mathcal{P}(z, z') \lambda_i(a, z; S_i).
\label{eq:law_motion}
\end{align}

\textbf{Aggregate Labor Supply.}  Aggregate efficiency units are
\begin{align}
N_i = L_{i}\sum_{z} \sum_{a}\ z \lambda_i(a, z; S_i) \label{eq:ag-labor-supply}
\end{align}
where the inner most term reflects efficiency units multiplied by the measure of households with that state. This is all multiplied by $L_i$ which is the mass of households in country $i$.

\textbf{Asset Holdings.} The aggregate quantity of asset holdings simply sums across the distribution conditional on choosing
\begin{align}
\mathrm{A}_i' = L_{i} \sum_{z}\sum_{j}\sum_{a}  g_{ij}(a, z; S_i) \pi_{ij}(a, z; S_i) \lambda_i(a, z; S_i).
\label{eq:aggregate_asset}
\end{align}

\textbf{National Income and Consumption} Starting from the production side of our economy, the value of aggregate production must equal aggregate payments to labor so
\begin{align}
p_{i} Y_{i} = p_{i} A_{i} N_{i} = L_i \sum_{z} \sum_{a} w_{i} \ z \ \lambda_i(a, z; S_i)
\label{eq:value_production}
\end{align}
where the last term sums over wage payments for each household type. Then by summing over individual consumers' budget constraint and substituting in (\ref{eq:value_production}), we arrive at the aggregated budget constraint:
\begin{align}
p_{i} Y_{i}  = \widetilde{P_{i} C_i}  + \bigg[-R_i\mathrm{A_i} +  \mathrm{A_i'} \bigg] - T_{i,\tau},
\label{eq:aggregate_budget_constraint}
\end{align}
where national income equals the value of aggregate consumption $\widetilde{P_{i} C_i}$, the country's the net asset position, all net of transfers. Here the value of aggregate consumption is
\begin{align}
\widetilde{P_{i} C_i} = L_{i} \sum_{z}\sum_{j}\sum_{a}  p_{ij} c_{ij}(a, z; S_i) \pi_{ij}(a, z; S_i) \lambda_i(a, z; S_i)
\end{align}
where one can see a bug and a feature of this model. Here there is an ``index number problem`` in the sense that there is not an ideal price index for which one can decompose aggregate values in to a price and quantity component. This is in contrast to, e.g., a model where households consume a CES bundle of goods.

\textbf{Trade Flows} It's first worth walking though imports for a given set of states. So for households with states $a$ and $z$ we have
\begin{align}
M_{ij}(a, z; S_i) = p_{ij} c_{ij}(a, z; S_i).
\end{align}
Then aggregate imports from country $i$ to country $j$ sums over this weighted by the mass of households choosing variety $j$ and who in those states so
\begin{align}
M_{ij} = L_i \sum_{z}\sum_{a} M_{ij}(a, z; S_i) \pi_{ij}(a, z; S_i) \lambda_i(a, z; S_i).
\label{eq:imports}
\end{align}
The same can be done for a countries exports. Again, focusing on exports to a location given a set of states we have
\begin{align}
X_{ji}(a, z; S_j) = p_{ji} c_{ji}(a, z; S_j)
\end{align}
Then aggregate exports from country $i$ to country $j$
\begin{align}
X_{ji} = L_j \sum_{z}\sum_{a} X_{ji}(a, z; S_j) \pi_{ji}(a, z; S_j) \lambda_j(a, z; S_j)
\label{eq:exports}
\end{align}

\subsection{Market Clearing and the Decentralized Equilibrium}

Given the definitions above, I discuss the market clearing conditions than an equilibrium must respect.

\textbf{The Goods Market.} From here we can equate the value of production of commodity $i$ in country $i$ with global demand for country $i$'s commodity:
\begin{align}
p_{i} Y_{i} &= \sum_{j}^{M}  X_{ji} \label{eq:goods-supply},
\end{align}
where the left hand side is production and the right hand side is world demand for the commodity from (\ref{eq:exports}).

\textbf{The Bond Market.} The second market clearing condition is in the bond market. Two cases are considered ``financial globalization'' in which there is a global bond market with one real interest rate $R$. In this case the market clearing condition is
\begin{align}
\sum_{i}^{M} \mathrm{A_i'} = 0
\label{eq:bond-market-global}
\end{align}
which says that net asset demand must equal zero across all countries. The second case considerer is ``financial autarky'' in which there is a local bond market that facilitates within country risk-sharing, but not globally. In this case, there is an interest rate is $R_i$ for each country and the associated market clearing condition is
\begin{align}
\mathrm{A_i'} = 0 \ \ \forall i
\label{eq:bond-market-country}
\end{align}
Below is a formal definition of a Stationary Equilibrium when the aggregate state $S_i$ is constant and not changing.

\textbf{A Stationary Equilibrium.} A Stationary Equilibrium are asset policy functions and commodity choice probabilities $\{\  g_{ij}(a, z), \pi_{ij}(a, z) \ \}_{i}$, probability distributions $\lambda_i(a, z)$, and positive real numbers $\left \{w, p, R\right \}_{i}$ such that
\begin{itemize}
\vspace{-.4cm}
\item[i]  Prices ($w, p$) satisfy (\ref{eq:marginal-product}, \ref{eq:marginal-product-ship});
\item[ii] The policy functions and choice probabilities solve the household's optimization problem in (\ref{eq:value_fun});
\item[iv] The probability distribution $\lambda_i(a, z)$ induced by the policy functions, choice probabilities, and primitives satisfies (\ref{eq:law_motion}) and is a stationary distribution;
\item[v] Goods market clears:
\begin{align}
p_{i} Y_{i} - \sum_{j}^{M}  X_{ji} = 0, \ \ \forall i
\end{align}
\item[v] Bond market clears with either Financial Globalization with $R_i = R$ and
\begin{align}
\sum_{i}^{M} \mathrm{A_i'} = 0.
\label{eq:fg-condition}
\end{align}
Or Financial Autarky where
\begin{align}
\mathrm{A_i'} = 0, \ \ \forall i
\label{eq:fa-condition}
\end{align}
\end{itemize}

\subsection{The Centralized Equilibrium}

Before discussing some properties of the model, the Centralized (Efficient) Equilibrium is an important point of comparison. To characterize this equilibrium, I take a stand on the Social Welfare function and focus on a Utilitarian planner that places equal weight on all households in the global economy. Social welfare is:
\begin{align}
\mathcal{W} =\sum_{t=0}^{\infty}  \sum\limits_{z} \sum_{i} \sum_{j} \beta^{t} \  \bigg \{  u(c_{ij}(z, t) ) + \mathrm{E}[ \ \epsilon \ | \ \mu_{ij}(z,t) ] \bigg \}\mu_{ij}(z,t) L_{i} \lambda_{i}(z, t).
\label{eq:sp-social_welfare}
\end{align}
Working from the inside out, the inner most term is utility from consumption $c_{ij}(z, t)$ conditional on shock, country source and destination plus the expected value of the preference shocks conditional on shock-specific choice probabilities. The inner most term is weighted according to the measure of households in $i$ sourcing from $j$ $\mu_{ij}(z,t)$ times the total measure of households $L_{i}\lambda_{i}(z, t)$ in country $i$ with shock $z$ at date $t$. Then this is done at all dates $t$ and discounted at the same rate $\beta$ that households discount utility.

The Planner maximizes (\ref{eq:sp-social_welfare}) subject to several constraints. The first is the law of motion describing how the measure of households evolves across states
\begin{align}
\lambda_{i}(z', t+1)  & =   \sum_{z} \mathcal{P}(z, z') \lambda_{i}(z,  t).  \  \label{eq:planner_law_motion}
\end{align}
Given a distribution of households, the effective labor units in each country are
\begin{align}
N_{i,t} =&  L_i \sum_{z} z \lambda_{i}(z, t),
\label{eq:planner_labor_supply}
\end{align}
and then aggregate production of the final good is
\begin{align}
Y_{it} = A_i N_{i,t}.
\label{eq:planner_value_production}
\end{align}
Combining the amount of resources available in (\ref{eq:planner_value_production}) with the consumption and sourcing decisions yields the following resource constraint:
\begin{align}
Y_{it}\  \geq \ & \sum_{j} \sum_{z} d_{ji} c_{ji}(z, t) \mu_{ji}(z,t) L_{j}\lambda_{j}(z, t)
\label{eq:planner_rc}
\end{align}
which says that production must be greater than or equal to world consumption of variety $i$ inclusive of trade costs $d_{ji}$.

Given the social welfare function in \ref{eq:sp-social_welfare} and the constraints discussed above, the \textbf{Centralized Planner's Problem} is the following:
{\small
\begin{align}
\mathcal{W}^{*} = & \max\limits_{c_{i,j}(z, t),\ \mu_{i,j}(z, t)} \ \sum_{t=0}^{\infty}  \sum\limits_{z} \sum_{i} \sum_{j} \beta^{t} \  \bigg \{  u(c_{ij}(z, t) ) + \mathrm{E}[ \ \epsilon \ | \ \mu_{i,j}(z,t) ] \bigg \}\mu_{i,j}(z,t) L_{i} \lambda_{i}(z, t) \ \ \nonumber \\
\nonumber \\
& \ \ \mbox{subject to} \ \ (\ref{eq:planner_law_motion}) \ \ (\ref{eq:planner_value_production}) \ \ \mbox{and} \ \ (\ref{eq:planner_rc}) \ \ \mbox{and an inital condition} \ \ \lambda_i(z, 0).
\label{eq:planner_problem}
\end{align}
}

\textbf{A Stationary Centralized Planner Allocation.}  A Stationary Centralized Planner Allocation are time invariant policy functions $\{\ c_{i,j}(z),\ \mu_{i,j}(z) \ \}$, a probability distribution $\lambda_{i}(z)$, and positive real numbers $N_{i}$ for each country $i$ where:
\begin{itemize}
\item[i] The policy functions solve the Centralized Planner's Problem in (\ref{eq:planner_problem});
\item[ii] The probability distribution $\lambda_{i}(z)$ associated with (\ref{eq:planner_law_motion}) is a stationary distribution;
\item[iii] Effective labor units satisfy (\ref{eq:planner_labor_supply}).
\end{itemize}


\newpage




\appendix

\clearpage
\newpage

\begin{center}
\textbf{\Large Appendix}
\end{center}

\addcontentsline{toc}{section}{Appendices}




\section{The Generalized Trade Elasticity}

My definition of the trade elasticity is the partial equilibrium response of imports from $j$ relative to domestic consumption due to a permanent change in trade costs between steady states. By partial equilibrium, I mean that wages and interest rates as fixed at their initial equilibrium values. By permanent, I work this out under the heuristic of a ``steady-state to steady-state comparison'' where I factor in how the stationary distribution changes due to changes in behavior. This definition is consistent with the broad terminology used in the trade literature, e.g. \citet{arkolakis2012new} and \citet{simonovska2014elasticity}. Consistent with this discussion and the notation below, I compute the partial derivatives (not total) of objects with respect to trade costs.

Mathematically, the trade elasticity equals the difference between the elasticities for how trade between $i$ and $j$ change minus how home trade changes:
\begin{align}
\frac{\partial ( M_{ij} / M_{ii} )}{\partial d_{ij}} \times \frac{d_{ij}}{( M_{ij} / M_{ii} )} =& \frac{\partial ( M_{ij} / M_{ij} )}{\partial d_{ij} / d_{ij}}  - \frac{\partial ( M_{ij} / M_{ii} )}{\partial d_{ij} / d_{ij}}.
\label{eq:def_trade_elasticity}
\end{align}
The change in imports between $i$ and $j$ with respect to a change in trade costs is:
\begin{align}
\frac{\partial  M_{ij}}{\partial d_{ij}} = \sum_{a,z} \bigg \{ \frac{\partial p_{ij}c_{ij}(a,z)}{\partial d_{ij}} \pi_{ij}(a,z)\lambda_{i}(a,z) +
 \frac{\partial \pi_{ij}(a,z)}{\partial d_{ij}} p_{ij}c_{ij}(a,z)\lambda_{i}(a,z)  +
\frac{\partial \lambda_{i}(a,z)}{\partial d_{ij}} p_{ij}c_{ij}(a,z)\pi_{ij}(a,z) \bigg \}.
\end{align}
Divide the stuff on the inside of the brackets by household level imports $p_{ij}c_{ij}(a,z)\pi_{ij}(a,z) \lambda_{i}(a,z)$ and multiply on the outside giving,
\begin{align}
\frac{\partial  M_{ij}}{\partial d_{ij}} = \sum_{a,z} \bigg \{ \frac{\partial p_{ij}c_{ij}(a,z)/ p_{ij}c_{ij}(a,z)}{\partial d_{ij}} +
 \frac{\partial \pi_{ij}(a,z) / \pi_{ij}(a,z)}{\partial d_{ij}}  +
\frac{\partial \lambda_{i}(a,z) / \lambda_{i}(a,z)}{\partial d_{ij}} \bigg \} p_{ij}c_{ij}(a,z)\pi_{ij}(a,z) \lambda_{i}(a,z).
\end{align}
Define the following weight which is the share of goods that those with states $a,z$ account for in total expenditures from $j$ as
\begin{align}
\omega_{ij}(a,z) = \frac{p_{ij}c_{ij}(a,z)\pi_{ij}(a,z) \lambda_{i}(a,z)}{M_{ij}}.
\end{align}
where the sum of $\omega_{ij}(a,z)$ equals total imports $M_{ij}$. This gives a nice expression for the import elasticity
\begin{align}
\frac{\partial  M_{ij} / M_{ij}}{\partial d_{ij} / d_{ij}} = \sum_{a,z} \bigg \{ \underbrace{ \frac{\partial p_{ij}c_{ij}(a,z)/ p_{ij}c_{ij}(a,z)}{\partial d_{ij} / d_{ij}} }_{\theta_{ij}(a,z)^{I}}+
\underbrace{\frac{\partial \pi_{ij}(a,z) / \pi_{ij}(a,z)}{\partial d_{ij} / d_{ij}} }_{\theta_{ij}(a,z)^{E}} +
\underbrace{\frac{\partial \lambda_{i}(a,z) / \lambda_{i}(a,z)}{\partial d_{ij} / d_{ij}}}_{\theta_{ij}(a,z)^{D}} \bigg \} \omega_{ij}(a,z)
\end{align}
or more succinctly as
\begin{align}
\frac{\partial  M_{ij} / M_{ij}}{\partial d_{ij} / d_{ij}} = \sum_{a,z} \bigg \{ \theta_{ij}(a,z)^{I} + \theta_{ij}(a,z)^{E} + \theta_{ij}(a,z)^{D} \bigg \}\omega_{ij}(a,z)
\end{align}
where the elasticity of aggregate imports into $i$ from $j$ is a weighted average of three different micro-level elasticities. The micro-level elasticities are:
\begin{itemize}
\item[\textbf{(i)}] An intensive margin trade elasticity $\theta_{ij}(a,z)^{I}$ which reflects the change in spending by a household on variety from $j$ as trade costs decline.

\item[\textbf{(ii)}]  The next term is the extensive margin trade elasticity $\theta(a,z)_{ij}^{E}$ which reflects how households substitute across varieties as trade costs decline. As I show below in Section \ref{}, this takes the place as the standard trade elasticity in, e.g., \citet{eaton2002technology}.

\item[\textbf{(iii)}] The distribution elasticity $\theta(a,z)_{ij}^{D}$ so how the mass of agents change across household states $a,z$. This last elasticity may seem a bit odd as being present in a partial equilibrium elasticity. But I include it hear because the flip side of changes in the intensive and extensive margin is that household saving behavior (even at fixed wages and interest rates) generally will change with the commodity choice. It's in this sense that it's a relevant margin to keep track of.
\end{itemize}

Given the expression in (\ref{eq:def_trade_elasticity}), Proposition \ref{apx-prp:GET} follows:

\begin{prp}[\textbf{The Generalized Trade Elasticity}] \label{apx-prp:GET} The trade elasticity between country $i$ and country $j$ is:
{\footnotesize
\begin{align}
\theta_{ij} = \sum_{a,z} \bigg \{ \theta_{ij}(a,z)^{I} + \theta_{ij}(a,z)^{E} + \theta_{ij}(a,z)^{D} \bigg \}\omega_{ij}(a,z) - \bigg \{ \theta_{ii}(a,z)^{I} + \theta_{ii}(a,z)^{E} + \theta_{ii}(a,z)^{D} \bigg \}\omega_{ii}(a,z)
\label{eq:apx-trade-elasticity}
\end{align}
}which is the difference in expenditure weighted micro-level elasticities. The micro-level elasticities for households with states $a,z$ are decomposed into an intensive, extensive, and distributional elasticity
{\footnotesize
\begin{align}
\nonumber
\theta_{ij}(a,z)^{I} = \frac{\partial p_{ij}c_{ij}(a,z)/ p_{ij}c_{ij}(a,z)}{\partial d_{ij} / d_{ij}}, \ \ \ \ \ \ \theta_{ij}(a,z)^{E} = \frac{\partial \pi_{ij}(a,z) / \pi_{ij}(a,z)}{\partial d_{ij} / d_{ij}}, \ \ \ \ \
\theta_{ij}(a,z)^{D} = \frac{\partial \lambda_{i}(a,z) / \lambda_{i}(a,z)}{\partial d_{ij} / d_{ij}}
\end{align}
}
and the expenditure weights are defined as
{\footnotesize
\begin{align}
\nonumber
\omega_{ij}(a,z) = \frac{p_{ij}c_{ij}(a,z)\pi_{ij}(a,z) \lambda_{i}(a,z)}{M_{ij}}
\end{align}
}
\end{prp}
An interesting feature of Proposition \ref{apx-prp:GET} is that it's derived only off the aggregation of imports at the micro level|no market clearing, functional forms, etc. However, by using the households budget constraint and the Type 1 extreme value distributional assumption more can be said about these elasticities and illustrate how the household's consumption-savings problem matters.

\textbf{The Intensive Margin Trade Elasticity.} By using the households budget constraint one can express the intensive margin elasticity as
\begin{align}
\underbrace{\frac{\partial p_{ij}c_{ij}(a,z)/ p_{ij}c_{ij}(a,z)}{\partial d_{ij} / d_{ij}}}_{\theta_{ij}(a,z)^{I}} &= -\frac{\partial g_{ij}(a,z)}{\partial p_{ij}/ p_{ij}} \frac{ \partial p_{ij}/ p_{ij}}{\partial d_{ij}/ d_{ij}} \times \frac{1}{p_{ij}c_{ij}(a,z)}, \\
\nonumber \\
&= -\frac{\partial g_{ij}(a,z)}{\partial p_{ij}/ p_{ij}} \times \frac{1}{p_{ij}c_{ij}(a,z)},
\label{eq:apx-intensive-margin}
\end{align}
where recall that $g_{ij}(a,z)$ is the policy function mapping states into asset holdings next period $a'$ and the last line follows from $\frac{ \partial p_{ij}/ p_{ij}}{\partial d_{ij}/ d_{ij}} = 1$. What this means is that the intensive margin elasticity is about a households consumption-savings behavior, i.e., how a household adjusts assets given a change in the price $p_{ij}$.

To be concrete, the way this works is that a reduction in trade costs lowers prices and relaxes the budget constraint, and then the intensive margin elasticity depends on how the new resources available to spend are dived between assets and consumption. In the static case where assets are not held, then any change in the price $p_{ij}$ is offset by a change in consumption and this elasticity is zero.

\textbf{The Extensive Margin Trade Elasticity.} The Type 1 extreme value distributional assumption allows for a sharp characterization of the choice probability and, hence, how the choice probabilities change. As a first step, define the denominator of the choice probability as:
\begin{align}
\Phi_{i}(a,z) = \sum_{j'} \exp \left( \frac{ v_{ij'}(a, z) }{\sigma_{\epsilon}} \right).
\end{align}
The elasticity of the choice probability with respect to a change in trade costs is
\begin{align}
\underbrace{ \frac{\partial \pi_{ij}(a,z) / \pi_{ij}(a,z)}{\partial d_{ij} / d_{ij}} }_{\theta_{ij}(a,z)^{E}} &= \frac{1}{\sigma_{\epsilon}}\frac{\partial v_{ij}(a,z)}{\partial d_{ij}/d_{ij}} -  \frac{\partial \Phi_{i}(a,z) / \Phi_{i}(a,z)}{\partial d_{ij}/d_{ij}}.
\label{eq:apx-extensive-margin}
\end{align}
The first term reflects how the choice specific value function changes with trade costs. In other words, how much more valuable does choice $j$ become when it's cheaper to import variety $j$. The second term reflects the fact that the change choice $j$ depends upon a comparison relative to the overall change in the value of options across variety, i.e., how $\Phi_{i}$ changes.

Admittedly, the terms in (\ref{eq:apx-extensive-margin}) are complicated objects: their state dependent and forward looking with the value functions showing up. More subtle is the fact that the household's income fluctuations problem imposes a cross-equation restriction between the intensive margin elasticity in and extensive margin given how assets and consumption are responding to changes in prices via changes in trade costs. This last point becomes more transparent when looking at the distribution margin trade elasticity.

\textbf{The Distribution Trade Elasticity.} I can connect the intensive and extensive margin trade elasticities with how the distribution changes in the following way. First, notice that the mass of households $\lambda_{i}(a,z)$ depends if a function of the asset policy function $g_{ij}(a,z)$ and the choice probability $\pi_{ij}(a,z)$. Represent this function as
\begin{align}
%why does this only dependon i,j%
\lambda_{i}(a,z) = f_{\lambda}(\pi_{ij}(a,z),g_{ij}(a,z)),
\end{align}
Then we can express how the distribution changes
\begin{align}
\frac{\partial \lambda_{i}(a,z)/\lambda_{i}(a,z)}{\partial d_{ij}/d_{ij}}  = \frac{\partial f_{\lambda, 1} / f_{\lambda} }{\partial d_{ij}/d_{ij}} \frac{\partial \pi_{ij}(a,z)}{\partial d_{ij}} +
\frac{\partial f_{\lambda, 2} / f_{\lambda} }{\partial d_{ij}/d_{ij}} \frac{\partial g_{ij}(a,z)}{\partial d_{ij}}
\label{eq:apx-distribution-margin}
\end{align}
which emphasizes the point that how the distribution changes is fundamentally interlinked to the behaviorial responses of households through how they substitute across products and how they substitute across time.

\section{The Welfare Gains from Trade}

This section derives the gains from a permanent change in trade costs, across steady states. Like the discussion above, the idea here is that I'm thinking a situation where the change is small and there is an immediate jump to the new steady state. Unlike the trade elasticity, I'm going to take total derivatives that will encompass general equilibrium changes in wages and interest rates.

The analysis proceeds in several steps.

First, I'm going to focus on country $i$ and study a change in trade costs $d_{ij}$. To simplify the algebra, I'm going to choose $w_i$ to be the numeraire. Then I'm going to normalize $A_i = 1$. What this implies is that $p_{ii} = \frac{w_i}{A_i}$ equals one and it's derivative with respect to things is zero.

Second, To compute how social welfare changes, I focus on a utilitarian social welfare function (Pareto weights across households, within a country, are the same):
\begin{align}
W_{i} = \sum_{a,z} v_{i}(a,z)\lambda_{i}(a,z)
\label{eq:apx-social-welfare}
\end{align}
Then the total change in total welfare is
\begin{align}
\frac{\mathrm{d} W_{i}}{\mathrm{d} d_{ij} / d_{ij}} = \sum_{a,z} \bigg \{ \frac{\mathrm{d} v_i(a, z)}{\mathrm{d} d_{ij} / d_{ij}}  + v_{i}(a,z) \frac{\mathrm{d} \lambda_{i}(a,z)/ \lambda_{i}(a,z)}{\mathrm{d} d_{ij} / d_{ij}}  \bigg \} \lambda_{i}(a,z).
\label{eq:apx-social-welfare-change}
\end{align}
What illustrates is that the gains from trade come through two forces. The first component reflects changes in household-level welfare. So conditional on a distribution of households across states, are households better or worse off. The second component is about reallocation, i.e., if|at the old $v$'s|does the distribution change so that social welfare gets better or worse. The change in social welfare is then the weighted average of these two forces with the weights being those at the initial distribution.

How does household-level welfare change? With the Type 1 extreme value distribution some progress can be made in several steps. First, notice that I can express everything relative to the home country $i$. Recall that the value function (with the expectation taken over the different preference shocks) is
\begin{align}
v_i(a, z) =  \sigma_{\epsilon} \log \left\{ \sum_{j'} \exp \left( \frac{  v_{ij'}(a, z)}{\sigma_{\epsilon}} \right) \right\},
\label{eq:apx-epsilon-vfun}
\end{align}
and then I'm going to make the observation that I can substitute out the sum part (\ref{eq:apx-epsilon-vfun} with the exp of the home value function relative to the micro-level ``home choice'' so
\begin{align}
\pi_{ii}(a, z) = \exp \left( \frac{ v_{ii}(a, z) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ v_{ij'}(a, z) }{\sigma_{\epsilon}} \right), \\
\nonumber \\
\pi_{ii}(a, z) \times \sum_{j'} \exp \left( \frac{ v_{ij'}(a, z) }{\sigma_{\epsilon}} \right) = \exp \left( \frac{ v_{ii}(a, z) }{\sigma_{\epsilon}} \right), \\
\nonumber \\
\sum_{j'} \exp \left( \frac{ v_{ij'}(a, z) }{\sigma_{\epsilon}} \right) = \exp \left( \frac{ v_{ii}(a, z) }{\sigma_{\epsilon}} \right) \Bigg / \pi_{ii}(a, z).
\label{eq:apx-homeshare-vfun}
\end{align}
Then substituting (\ref{eq:apx-homeshare-vfun}) into the value function in (\ref{eq:apx-epsilon-vfun}) gives:
\begin{align}
v_i(a, z) =  \sigma_{\epsilon} \log \left\{ \frac{ \exp \left( \frac{  v_{ii}(a, z)}{\sigma_{\epsilon}}\right )}{\pi_{ii}(a,z)}  \right\}
\label{eq:apx-homeshare-vfun2}
\end{align}
and recall that the home choice value function is
\begin{align}
v_{ii}(a, z) = u(c_{ii}(a,z)) + \beta \mathbb{E} v_{i}(g_{ii}(a,z),z)
\end{align}
where the expectation operator is over the $z$s and the $v_{i}$ is the same value function as in (\ref{eq:apx-epsilon-vfun}) so the taste shocks are integrated out. Taking logs and exp's of (\ref{eq:apx-homeshare-vfun2}) allows for the $v_i$ value function to be represented as
\begin{align}
v_i(a, z) = -\sigma_{\epsilon} \log \pi_{ii}(a,z) + u(c_{ii}(a,z)) + \beta \mathbb{E} v_{i}(g_{ii}(a,z),z).
\label{eq:apx-home-valuefun}
\end{align}
The key innovation here is that now everything is written with respect to the home choice. Where are the taste shocks? What is going on is that the home choice $\pi_{ii}$ summarizes the expected value of those shocks and their benefits. No need to explicitly carry around the $v_{ij}$s. This is essentially the dynamic analog to Equation (15), Footnote 42 of \citet{eaton2002technology} and \citet{arkolakis2012new} and I explicitly show this in the example section below.

Now the strategy is to totally differentiate (\ref{eq:apx-home-valuefun}) with respect to trade costs and use the recursive structure to iterate forward and construct the change across time.  One more detail, to facilitate interpretation, it will be useful to compute the Euler equation associated with asset holdings when the borrowing constraint does not bind. This euler equation is:
\begin{align}
-u'(c_{ii}(a,z)) = \beta \mathbb{E} \bigg \{ -\sigma_{\epsilon} \frac{\partial \pi_{ii}(a',z') / \pi_{ii}(a',z')}{\partial a'} + u'(c_{ii}(a',z'))R \bigg \},
\end{align}
which says that the agent should be indifferent between the marginal utility of consumption forgone to hold some more assets and two components (i) the benefit from how a change in assets changes in their variety choice and (ii) the direct benefit of the returns on the assets evaluated at the marginal utility of consumption.

\hrulefill

Redo. Digression on chain rule. I'm going to
\begin{align}
v(a',z') = v(g(a,z,d), z')
\end{align}
where I substitute in the policy function for $a'$. Then first term inside indicates that $v$ depends upon the choice of $a'$ and this works through the policy function. And the dependence of $v$ on $d$ (and not through assets) is implicit. Then the total derivative of this is
\begin{align}
\frac{\mathrm{d} v(g(a,z,d), z')}{\mathrm{d} d} =& \frac{\partial v}{\partial a'}\frac{\mathrm{d}g}{\mathrm{d}d} +  \frac{\partial v(\overline{g(a,z,d)},z')}{\partial d}
\end{align}
So the first term is the partial change of $v$ with respect to $a'$ times how the policy function totally changes with respect to $d$. The second term is the partial change of $v$ with respect to $d$, \textbf{holding fixed assets} at their chosen level. That's why I'm emphasizing the bar on top. Now what is confusing to me is that this has partial, not total derivatives. But this term is mathematically the same as
\begin{align}
\frac{\partial v(\overline{g(a,z,d)},z')}{\partial d} = \frac{\mathrm{d} v(a', z')}{\mathrm{d} d }
\end{align}
where the RHS is the total derivative of $v$ treating $a'$ as a parameter. In other words, the LHS says, how does $v$ change (everything else) holding fixed assets. The RHS says how does everything else change holding fixed assets. There the same. And the RHS is the value function evaluated at the new states $a'$, $z'$.

\hrulefill

Totally differentiating the value function gives
\begin{align}
\frac{\mathrm{d} v_i(a, z)}{\mathrm{d} d_{ij} / d_{ij}} =& \nonumber  \\
\nonumber \\
 -\sigma_{\epsilon} & \frac{\mathrm{d} \pi_{ii}(a,z) / \pi_{ii}(a,z)}{\mathrm{d}d_{ij} / d_{ij}}  + u'(c_{ii}(a,z))\frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}a - u'(c_{ii}(a,z))\frac{\mathrm{d} g_{ii}(a,z)}{\mathrm{d} d_{ij} / d_{ij}}
+ \beta E \frac{\mathrm{d} v_i(g_{ii}(a,z), z')}{\mathrm{d} d_{ij} / d_{ij}}
\end{align}
Then the derivative of the continuation value function is:
\begin{align}
& \frac{\mathrm{d} v_i(g(a,z), z')}{\mathrm{d} d_{ij} / d_{ij}} = \underbrace{\bigg [-\sigma_{\epsilon} \frac{\partial \pi_{ii}(a',z') / \pi_{ii}(a',z')}{\partial a'} + u'(c_{ii}(a',z'))R \bigg ]}_{\frac{\partial v_i(g_{ii}(a,z), z')}{\partial a}}\frac{\mathrm{d} g_{ii}(a,z)}{\mathrm{d} d_{ij} / d_{ij}} \ \ + \\
\nonumber \\
& -\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a',z') / \pi_{ii}(a',z')}{\mathrm{d}d_{ij} / d_{ij}}   + u'(c_{ii}(a',z'))\frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}a' - u'(c_{ii}(a',z'))\frac{\mathrm{d} g_{ii}(a',z')}{\mathrm{d} d_{ij} / d_{ij}}
+ \beta E \frac{\mathrm{d} v_i(g_{ii}(a',z'), z'')}{\mathrm{d} d_{ij} / d_{ij}}
\end{align}
And now combine and collect terms so
\begin{align}
\frac{\mathrm{d} v_i(a, z)}{\mathrm{d} d_{ij} / d_{ij}} =& -\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a,z) / \pi_{ii}(a,z)}{\mathrm{d}d_{ij} / d_{ij}} \\
\nonumber \\
& + \underbrace{u'(c_{ii}(a,z))\frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}a}_{\gamma_{ii}(a,z)}  \\
\nonumber \\
& + \underbrace{\bigg \{- u'(c_{ii}(a,z)) + \beta \mathbb{E} \big [-\sigma_{\epsilon} \frac{\partial \pi_{ii}(a',z') / \pi_{ii}(a',z')}{\partial a'} + u'(c_{ii}(a',z'))R \big ] \bigg \}\frac{\mathrm{d} g_{ii}(a,z)}{\mathrm{d} d_{ij} / d_{ij}}}_{\delta_{ii}(a,z)} \\
\nonumber \\
& + \beta \mathbb{E} \bigg \{ -\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a,z) / \pi_{ii}(a,z)}{\mathrm{d}d_{ij} / d_{ij}} +  u'(c_{ii}(a',z'))\frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}a' \ \  \ldots
\label{eq:apx-welfare-vterms}
\end{align}
Let me walk through the interpretation of each term:
\begin{itemize}
\item $-\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a,z) / \pi_{ii}(a,z)}{\mathrm{d}d_{ij} / d_{ij}}$ is the standard gains from trade term reflecting the idea that gains work through changes in expenditures across different varieties. With static logit, this is exactly the ACR formula.

\item $u'(c_{ii}(a,z))\frac{\partial R}{\partial d_{ij} / d_{ij}}a$ or what I'm labeling as $\gamma_{ii}(a,z)$ is what I would call how trade facilitates more risk sharing. I think as trade costs decline the amount of resources available for risk sharing expands and this changes the interest rate. Which way does it go?

\item The third term which I'm labeling as $\delta_{ii}(a,z)$  is the Euler equation for assets. Honestly, it's pretty cool the way this shows up here. The idea is that if the household is unconstrained, then this term is zero as there is no gain through changes in asset behavior. Asset holdings are already chosen optimally so that margins are equated, thus, on the margin any benefit of lower trade costs on changes in asset behavior is zero. Essentially an application of the Envelope Theorem.

    Now in this economy, this term may not be zero because of borrowing constrained households, thus this term is positive and may (see below) represent a gain from trade. What this is picking up is that a change in trade costs are relaxing the constraints on some households and get's them back on their euler equation.

    Finally, notice how the outside brackets is multiplied by the change in the asset policy function. Again, this is super cool. What this picks up is that if the household is still constrained, then assets can't change so the outside term is zero and, thus, overall the second term is zero. So the only people that benefit and contribute to social welfare through these effects are those on the margin between constrained and not-constrained.

\item The final term is about this continuing on into the infinite future.
\end{itemize}
Iterating on (\ref{eq:apx-welfare-vterms}) into the future, the gains from trade for a household with states $a,z$ today are
\begin{align}
\frac{\partial v_i(a, z)}{\partial d_{ij} / d_{ij}} = \mathbb{E} \sum_{t = 0}^{\infty} \beta^{t} \bigg \{ -\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a_{t},z_{t}) / \pi_{ii}(a_{t},z_{t})}{\mathrm{d}d_{ij} / d_{ij}} + \gamma_{ii}(a_{t},z_{t}) + \delta_{ii}(a_{t},z_{t}) \bigg \}
\label{eq:apx-welfare-v}
\end{align}
Where the first component is the expected discounted gains from substitution, gains from risk sharing and the relaxation of borrowing constraints. Combining (\ref{eq:apx-welfare-v}) and (\ref{eq:apx-social-welfare-change}) yields the following proposition for the gains from trade

\begin{prp}[\textbf{The Welfare Gains from Trade}] \label{apx-prp:gains-trade} The welfare gains from trade are given by
{\footnotesize
\begin{align}
\frac{\mathrm{d} W_{i}}{\mathrm{d} d_{ij} / d_{ij}} = \sum_{a,z} \bigg \{ \frac{\mathrm{d} v_i(a, z)}{\mathrm{d} d_{ij} / d_{ij}}  + v_{i}(a,z) \frac{\mathrm{d} \lambda_{i}(a,z)/ \lambda_{i}(a,z)}{\mathrm{d} d_{ij} / d_{ij}}  \bigg \} \lambda_{i}(a,z).
\nonumber
\end{align}
}which reflects the change in household level gains and how the distribution of households changes. Household level gains are given by
{\footnotesize
\begin{align}
\nonumber
\frac{\partial v_i(a, z)}{\partial d_{ij} / d_{ij}} = \mathbb{E} \sum_{t = 0}^{\infty} \beta^{t} \bigg \{ -\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a_{t},z_{t}) / \pi_{ii}(a_{t},z_{t})}{\mathrm{d}d_{ij} / d_{ij}} + \gamma_{ii}(a_{t},z_{t}) + \delta_{ii}(a_{t},z_{t}) \bigg \}
\end{align}
}where each term represents:
\begin{itemize}
\item Gains from substitution: $-\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a,z) / \pi_{ii}(a,z)}{\mathrm{d}d_{ij} / d_{ij}}$.

\item Gains from risk sharing: $\gamma_{ij}(a,z) = u'(c_{ii}(a,z))\frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}a$

\item Gains from relaxing borrowing constraints:
\begin{align}
\nonumber
\delta_{ii}(a,z) = \bigg \{- u'(c_{ii}(a,z)) + \beta \mathbb{E} \big [-\sigma_{\epsilon} \frac{\partial \pi_{ii}(a',z') / \pi_{ii}(a',z')}{\partial a'} + u'(c_{ii}(a',z'))R \big ] \bigg \}\frac{\mathrm{d} g_{ii}(a,z)}{\mathrm{d} d_{ij} / d_{ij}}
\end{align}
\end{itemize}
\end{prp}
Proposition \ref{apx-prp:gains-trade} nests several interesting cases that connect with the literature and further illustrate the mechanics.

\subsection{Static, Log Preferences}

The first is the non-assets, static, log preference case. This delivers the benchmark gains from trade formula in \citet{arkolakis2012new}. The first step is to derive the trade elasticity. A couple observations are necessary.
\begin{itemize}
\item From the formula for the intensive margin elasticity (\ref{eq:apx-intensive-margin}) and because there is no asset choice then $\theta_{ij}(z)^I$ is zero, so any change in prices are fully offset by a change in consumption. 
\item Second, because there is no asset choice and household level shocks are exogenously specified, then the distribution elasticity is zero. 

\item Third, the choice probabilities become independent of household level productivity, so
\begin{align}
\nonumber \pi_{ij}(z) &= \exp \left( \frac{ \log\left( \frac{w_{i}z}{p_{ij}} \right) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{  \log\left( \frac{w_{i}z}{p_{ij'}} \right) }{\sigma_{\epsilon}} \right) \\
\nonumber \\
\nonumber \pi_{ij} &= \exp \left( \frac{ -\log\left( p_{ij} \right) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{  -\log\left( p_{ij'} \right) }{\sigma_{\epsilon}} \right).
\end{align}
And thus, the $\Phi_{i}(z)$ showing up in the extensive margin calculation (\ref{eq:apx-extensive-margin}) is independent of $z$.  

\item Then the final observation is that the partial derivative of the $i,j$ choice value function $\frac{\partial v_{ij}(z)}{\partial d_{ij}/d_{ij}} = -1$ and zero everywhere else. 
\end{itemize}
Then following Proposition \ref{apx-prp:GET} and (\ref{eq:apx-trade-elasticity}) the trade elasticity is
\begin{align}
\nonumber
\theta_{ij} =& \sum_{z} \bigg \{ 0 + -\frac{1}{\sigma_{\epsilon}} - \frac{\partial \Phi_{i} / \Phi_{i}}{\partial d_{ij}/d_{ij}} \ + 0 \bigg \}\omega_{ij}(z) - \sum_{z} \bigg \{  0 - \frac{\partial \Phi_{i} / \Phi_{i}}{\partial d_{ij}/d_{ij}} + 0 \bigg \}\omega_{ii}(z) \\
\nonumber \\
\theta =& -\frac{1}{\sigma_{\epsilon}} \nonumber
\end{align}
where the second line follows because the terms inside the brackets are independent of $z$ and thus can be pulled outside and the weights $\omega_{ij}(z)$ sum to one. What this means is the trade elasticity is constant and parameterized by the dispersion in tastes. I think the feature delivering this is that the elasticities at the micro-level are constant, so then the aggregate elasticity simply follows because I don't need to say anything about what is going on with the weights. 

Now combining these observations and mechanically following Proposition \ref{apx-prp:gains-trade} the gains from trade are
\begin{align}
\frac{\mathrm{d} W_{i}}{\mathrm{d} d_{ij} / d_{ij}} = -\frac{1}{\theta} \times \frac{\mathrm{d} \pi_{ii} / \pi_{ii}}{\mathrm{d}d_{ij} / d_{ij}}
\end{align}.
which is exactly the \citet{arkolakis2012new} formula. The change in welfare gains from equal the inverse of trade elasticity multiplied by how much the home trade share changes.

\begin{corr}[\textbf{ACR 2012}] In the static heterogenous agent trade model the trade elasticity is
\begin{align}
\theta = -\frac{1}{\sigma_{\epsilon}} \nonumber
\end{align}
and the gains from trade are given by
\begin{align}
\frac{\mathrm{d} W_{i}}{\mathrm{d} d_{ij} / d_{ij}} = -\frac{1}{\theta} \times \frac{\mathrm{d} \pi_{ii} / \pi_{ii}}{\mathrm{d}d_{ij} / d_{ij}}.
\end{align}
\end{corr}

\subsection{Dynamic, Log Preferences}

This example is interesting because it retains an aggregate constant trade elasticity, but at the micro-level it is not quite with things canceling in a way during aggregation. Second, the welfare gains from trade formula looks like ACR kind of thing. Because this is a bit more involved I'm going to be super systematic about this. 

\textbf{Step 1: Individual Choices.} With log preferences the $j$ choice value function is
\begin{align}
v_{ij}(a, z) = &  \max_{\ a' \in \mathcal{A} }\bigg  \{ \log\left (\frac{Ra + wz - a'}{p_{ij}} \right )  + \beta \, \mathbb{E} [v_{i}(a', z')]  \bigg\}
\end{align}
which is then
\begin{align}
v_{ij}(a, z) = &  \max_{\ a' \in \mathcal{A} }\bigg  \{ \log(Ra + wz - a' )  + \beta \, \mathbb{E} [v_{i}(a', z' )]  \bigg\} - \log p_{ij}
\label{eq:value_fun_option_log_p}
\end{align}
which then leads to the observation that the optimal $a'$ conditional on a choice $j$ is \textbf{independent} of the price and the choice $j$. So what is going on is if you consume an expensive or cheap good, then consumption simply scales up or down so that assets next period are exactly the same. This observation has the implication that expenditures on consumption are the same across choices. Compare households expenditures with the same state $a,z$ but different choices. Equation (\ref{eq:value_fun_option_log_p}) implies
\begin{align}
p_{ij}c_{ij}(a,z) = p_{ii}c_{ii}(a,z)
\label{eq:apx-same-spending}
\end{align}
so within states, people always spend the same amount. This fact will be useful below.

Finally, this observation implies that the choice probabilities are independent of the state only prices matter so
\begin{align}
\pi_{ij}(a, z) = & \exp \left( \frac{ v_{ij}(a, z) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ v_{ij'}(a, z ) }{\sigma_{\epsilon}} \right) \\
\nonumber\\
\pi_{ij} = & \exp \left( \frac{  -\log p_{ij} }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ -\log p_{ij'} }{\sigma_{\epsilon}} \right)
\end{align}
which is exactly the same as discussed above in the static model. These observations are all consistent with the Generalized Euler Equation below. To see this
\begin{align}
\frac{u'(c_{ij}(a, z))}{p_{ij}} = \max \left\{ \beta R_{i} \mathbb{E} \left[ \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))}{p_{ij}} \right] \ , \  u' \left( \frac{R_i a + w_i - \phi_{i}}{p_{ij}} \right) \right \}
\end{align}
and then impose log preferences and notice that
\begin{align}
(Ra + wz - a')^{-1} = \max \left\{ \beta R \mathbb{E} \left[ \sum_{j'} \pi_{ij}(a', z') (Ra' + wz - a'')^{-1} \right] \ , \   (R a + w - \phi_{i})^{-1} \right \}
\end{align}
and then because the term multiplying the $\pi_{ij}$'s does not depend upon $j$ it can be pulled out and
\begin{align}
(Ra + wz - a')^{-1} = \max \bigg \{ \beta R \mathbb{E} (Ra' + wz' - a'')^{-1}  \ , \   (R a + w - \phi_{i})^{-1}  \bigg \}
\end{align}
and thus the asset choice is independent from the variety choice $j$. 

\textbf{Step 2: Micro Trade Elasticities.} I'm going to be super systematic about this:
\begin{itemize}
\item Starting with (\ref{eq:apx-intensive-margin}) and because the asset choice is independent of prices,  the intensive margin elasticity $\theta_{ij}(a,z)^I$ is zero. This is not obvious actually because of how prices would enter into $v_{i}$. I do think one can expand out and completely separate out the effects of prices. 

\item The distribution elasticity is zero from (\ref{eq:apx-distribution-margin}) because assets are not responding to changes in prices and what about $\pi$s (but these are independent of $a$ and $z$ so there is no differential change? This is not clear from formula. Need to articulate this better.

\item The extensive margin elasticity is:
\begin{align}
\theta_{ij}(a,z)^E =& \frac{1}{\sigma_{\epsilon}}\frac{\partial v_{ij}(a,z)}{\partial d_{ij}/d_{ij}} -  \frac{\partial \Phi_{i} / \Phi_{i}}{\partial d_{ij}/d_{ij}}\\
\nonumber \\
=& -\frac{1}{\sigma_{\epsilon}}\frac{\partial p_{ij} / p_{ij}}{\partial d_{ij}/d_{ij}} + \beta \mathbb{E} \frac{\partial v_{i}(a',z')}{\partial d_{ij}/d_{ij}} -  \frac{\partial \Phi_{i}(z) / \Phi_{i}(z)}{\partial d_{ij}/d_{ij}} \\
\nonumber \\
=& -\frac{1}{\sigma_{\epsilon}} + \beta \mathbb{E} \frac{\partial v_{i}(a',z')}{\partial d_{ij}/d_{ij}} -  \frac{\partial \Phi_{i} / \Phi_{i}}{\partial d_{ij}/d_{ij}}
\label{eq:apx-log-partial-valuefun}
\end{align}
where the first line removes the $a,z$ indexing of $\Phi_i$ because they don't shape the choice probabilities. The next line then partially differentiates the value function with respect to the change in trade costs and I'm exploiting how with log preferences one can pull out the price term. And then the final line notes that the price elasticity is minus one. One more fact that:
\begin{align}
\theta_{ii}(a,z)^E =&  \beta \mathbb{E} \frac{\partial v_{i}(a',z')}{\partial d_{ij}/d_{ij}} -  \frac{\partial \Phi_{i} / \Phi_{i}}{\partial d_{ij}/d_{ij}}
\end{align}
where a key thing to notice is that the $i,i$ elasticity is the same as the second and third terms above in (\ref{eq:apx-log-partial-valuefun}).
\end{itemize}
It's worth emphasizing that the micro trade elasticities are \textbf{not} constant across states $a,z$. Unlike the static model with log preferences, they are varying by income and assets as the derivative of the value function is showing up. But what \textbf{is} occurring is that across different destinations, within states, they are varying in the same exact way. This is one aspect of this case that facilitates aggregation. However, the necessary aspect is that the expenditure weights work out in the right way, I show this next. 

\textbf{Step 3: Expenditure Weights.} Recall that the micro level trade elasticities when aggregated are weighted by
\begin{align}
\omega_{ij}(a,z) = \frac{p_{ij}c_{ij}(a,z)\pi_{ij}(a,z) \lambda_{i}(a,z)}{M_{ij}}.
\end{align}
and note that we can relabel $p_{ij}c_{ij}(a,z) = x(a,z)$ given (\ref{eq:apx-same-spending}), that expenditures are independent of the destination. With the choice probabilities independent of $a,z$ the weights become
\begin{align}
\omega_{ij}(a,z) =& \frac{x(a,z)\pi_{ij} \lambda_{i}(a,z)}{\sum_{a,z}x(a,z)\pi_{ij} \lambda_{i}(a,z)}, \\
\nonumber \\
=& \frac{x(a,z) \lambda_{i}(a,z)}{\sum_{a,z} x(a,z) \lambda_{i}(a,z)}
\end{align}
which are independent of source $j$. This is the second important observation that will facilitate aggregation.

\textbf{Step 4: The Trade Elasticity.} Now just mechanically follow Proposition \ref{apx-prp:GET}:
\begin{align}
\nonumber
\theta_{ij} =& \sum_{a,z} \bigg \{ 0 + -\frac{1}{\sigma_{\epsilon}} + \beta \mathbb{E} \frac{\partial v_{i}(a',z')}{\partial d_{ij}/d_{ij}} -  \frac{\partial \Phi_{i} / \Phi_{i}}{\partial d_{ij}/d_{ij}} \ + 0 \bigg \}\omega_{i}(a,z) \\
\nonumber \\
& - \sum_{z} \bigg \{  0 + \beta \mathbb{E} \frac{\partial v_{i}(a',z')}{\partial d_{ij}/d_{ij}} -  \frac{\partial \Phi_{i} / \Phi_{i}}{\partial d_{ij}/d_{ij}} + 0 \bigg \}\omega_{i}(a,z) \\
\nonumber \\
= & -\frac{1}{\sigma_{\epsilon}} \nonumber
\end{align}
where the last line follows because the $a,z$ terms in the micro level trade elasticities exactly cancel given that expenditure weights are source independent. And the aggregate trade elasticity is constant and parameterized by the dispersion in tastes.

\textbf{Step 5: The Grains From Trade.} Then from here I can just follow Proposition \ref{apx-prp:gains-trade}. First the individual gains are
{\footnotesize
\begin{align}
\nonumber
\frac{\partial v_i(a, z)}{\partial d_{ij} / d_{ij}} = \underbrace{-\frac{1}{\theta (1-\beta)} \times \frac{\mathrm{d} \pi_{ii} / \pi_{ii}}{\mathrm{d}d_{ij} / d_{ij}}}_{ACR} \ \ + \ \  
\mathbb{E} \sum_{t = 0}^{\infty} \beta^{t} \bigg \{ \gamma_{ii}(a_{t},z_{t}) + \delta_{ii}(a_{t},z_{t}) \bigg \}
\end{align}
}where the first term is exactly in the static model except for the discounting bit. But what facilitates this is that the choice probabilities are independent of $a,z$ and it can be pulled out of the expected discounted sum stuff. Then the subsequent terms take a slightly cleaner form:
\begin{itemize}
\item Gains from risk sharing: $\gamma_{ij}(a,z) = \frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}\frac{a}{c_{ii}(a,z)}$
\item Gains from relaxing borrowing constraints:
\begin{align}
\nonumber
\delta_{ii}(a,z) = \bigg \{- c_{ii}(a,z)^{-1} + \beta \mathbb{E} \big [ c_{ii}(a',z')^{-1}R \big ] \bigg \}\frac{\mathrm{d} g_{ii}(a,z)}{\mathrm{d} d_{ij} / d_{ij}}
\end{align}
\end{itemize}
One final step. Claim is that because the asset policy function $g$ is independent of the price of varieties, then any change in trade costs will not affect $R$ and thus the total derivative $\frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}$ equals zero and then the total derivative $\frac{\mathrm{d} g_{ii}(a,z)}{\mathrm{d} d_{ij} / d_{ij}}$ on the asset policy function is zero. And then $\frac{\mathrm{d} \lambda_{i}(a,z)/ \lambda_{i}(a,z)}{\mathrm{d} d_{ij} / d_{ij}}$ is zero as well. 

So there is a super strong result:
\begin{corr}[\textbf{Separation of Trade and Heterogeneity}] In the dynamic heterogenous agent trade model the trade elasticity is
\begin{align}
\theta = -\frac{1}{\sigma_{\epsilon}} \nonumber
\end{align}
and the gains from trade are given by
\begin{align}
\frac{\mathrm{d} W_{i}}{\mathrm{d} d_{ij} / d_{ij}} = -\frac{1}{\theta (1-\beta)} \times \frac{\mathrm{d} \pi_{ii} / \pi_{ii}}{\mathrm{d}d_{ij} / d_{ij}}.
\end{align}
\end{corr}


Should check this stuff on computer. 





\newpage


\section{Appendix: Endogenous Grid Method}

First, I'm going to derive the Euler equation for this model. I'll abstract from the situation in which the HH is at the borrowing constraint.

Focus on the within a variety choice component, the households value function can be written as:
\begin{align}
v_{ij}(a, z) = \max_{a'} u \left( \frac{R_i a + w_i z - a'}{p_{ij}} \right) + \beta  \mathrm{E} v(a', z')
\end{align}
then the first order condition associated with this problem is:
\begin{align}
\frac{u'(c_{ij}(a, z))}{p_{ij}} = \beta \mathrm{E} \frac{\partial v(a', z')}{\partial a'}
\end{align}
which is saying that, conditional on a variety choice the left hand side is the loss in consumption units which is $1 / p_{ij}$ evaluated at the marginal utility of consumption and then this is set equal to the marginal gain from saving a bit more which is how the value function changes with respect to asset holdings. Now we can arrive at the $\frac{\partial v(a', z')}{\partial a'}$ in the following way, so start from the log-sum expression for the expected value function
\begin{align}
\mathbb{E}_{\epsilon} v(a', z') =  \sigma_{\epsilon} \log \left\{ \sum_{j'} \exp \left( \frac{  v_{ij}(a', z')}{\sigma_{\epsilon}} \right) \right\}
\end{align}
and then differentiate this with respect to asset holdings which gives:
\begin{align}
\frac{\partial \mathbb{E}_{\epsilon} v(a', z')}{\partial a'} = \left( \frac{\sigma_{\epsilon}}{\sum_{j'} \exp \left( \frac{  v_{ij}(a', z')}{\sigma_{\epsilon}}\right)} \right)
\left[ \sum_{j'} \exp \left( \frac{  v_{ij}(a', z')}{\sigma_{\epsilon}}\right) \frac{1}{\sigma_{\epsilon}} \frac{\partial v_{ij}(a', z')}{\partial a'}  \right]
\end{align}
Then if you look at this carefully and notices how the choice probabilities from (\ref{eq:choice-prob}) are embedded in here, we have:
\begin{align}
\frac{\partial \mathbb{E}_{\epsilon} v(a', z')}{\partial a'} = \sum_{j'} \pi_{ij}(a', z) \frac{\partial v_{ij}(a', z')}{\partial a'}
\end{align}
and then we can just apply the Envelop theorem to the value functions associated with the discrete choices across the options:
\begin{align}
\frac{\partial \mathbb{E}_{\epsilon} v(a', z')}{\partial a'} = \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))R_{i}}{p_{ij}}
\end{align}
So then putting everything together we have:
\begin{align}
\frac{u'(c_{ij}(a, z))}{p_{ij}} = \beta R_{i} \mathrm{E}_{z'} \left[ \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))}{p_{ij}} \right]
\end{align}
where this has a very natural form: you set the marginal utility of consumption today equal to the marginal utility of consumption tomorrow adjusted by the return on delaying consumption, and the expected value of the marginal utility of consumption which reflects how the uncertainty over both ones' preference over different varieties and shocks to efficiency units. Taking into account the borrowing constraint then gives the generalized Euler equation from which the endogenous grid method will exploit:
\begin{align}
\frac{u'(c_{ij}(a, z))}{p_{ij}} = \max \left\{ \beta R_{i} \mathrm{E}_{z'} \left[ \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))}{p_{ij}} \right] \ , \  u' \left( \frac{R_i a + w_i - \phi_{i}}{p_{ij}} \right) \right \}
\label{eq:euler_equation}
\end{align}

\subsection{EGM-Discrete Choice Algorithm}

Here is a proposed approach. This focuses on just the consumer side in one country $i$.
\begin{itemize}
\item[\textbf{0.}] Set up an asset grid as usual. Then guess (i) a consumption function $g_{c,ij}(a,z)$ for each $a$, $z$, and product choice $j$ and (ii) choice specific value function $v_{ij}(a,z)$.

\item[\textbf{1.}] Compute the choice probabilities from (\ref{eq:choice-prob}) for each $(a,z)$ combination, given the guessed value functions.

\item[\textbf{1.}] Given the consumption function and choice probabilities compute the RHS of (\ref{eq:euler_equation}) first.

\item[\textbf{2.}] Then invert to find the new updated consumption choice so
\begin{align}
c_{ij}(\tilde a, z) = u^{' -1}\left\{ p_{ij} \max \left\{ \beta R_{i} \mathrm{E}_{z'} \left[ \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))}{p_{ij}} \right] \ , \  u' \left( \frac{R_i a + w_i - \phi_{i}}{p_{ij}} \right) \right \} \right \}
\end{align}
where $u^{' -1}$ is the inverse function of the marginal utility of consumption.

Side note: One of the interesting things about this equation is that the direct $j$ component on the RHS that only affects the consumption choice is through the price. Can this be exploited? We also know the choice probabilities need to sum to one, so is there a way to map the consumption choice into the choice probabilities? Also, can interpolation be done once how $p$ scales things...

\item[\textbf{3.}] The key issue in this method is that we have found  $c_{ij}(\tilde a, z)$ where the consumption function is associated with some asset level that is not necessarily on the grid. The solution is to (i) use the budget constraint and infer $\tilde a$ given that $a'$ was chosen above (that's where we started), $z$, and $c_{ij}(\tilde a, z)$. Now we have a map from $\tilde a$ to $a'$ for which one can use interpolation to infer the $a'$ chosen given $a$ where $a$ is on the grid.

\item Do steps \textbf{2.} and \textbf{3.} for each $j$ variety choice. This then makes the function $g_{a,ij}(a,z)$ mapping each state and $j$ choice (today) into $a', z'$ states and then from the budget constraint we have an associated consumption function $g_{c,ij}(a,z)$

\item[\textbf{4.}] Compute the $\mathrm{E}\left[ v(g_{a,ij}(a,z), z') \right]$. This is performed in the {\tt{make\_Tv\_upwind!}} function. It fixes a country $j$, then works through shocks and asset states today and from the policy function $g_{a,ij}(a,z)$ figures out the asset choice tomorrow. Then the $\mathrm{E}\left[ v(g_{a,ij}(a,z), z') \right]$ is (\ref{eq:log_sum}) over the different variety choices tomorrow (this is the integration over $\epsilon$) multiplied by the probability of $z'$ occurring (this is the integration over $z$).

\item[\textbf{5.}] Given \textbf{4.} update the value function using the bellman equation evaluated at the optimal policies:
\begin{align}
Tv_{ij}(a, z) = u(g_{c,ij}(a,z)) + \beta \mathrm{E}\left[ v(g_{a,ij}(a,z), z') \right]
\end{align}

\item[\textbf{6.}] Compare old and new policy functions, old and new value functions, and then update accordingly.


%\item[\textbf{5.}] Given the structure of $Q$, then just line (\ref{eq:utility_azj}) with $Q$ and invert to find value functions that are associated with each $(a,z,j)$ state. This takes the form where
%\begin{align}
%\vec{v} = (\mathbb{I} - \beta Q) \ / \  \vec{u} \label{eq:v_inversion}
%\end{align}
%where, again, each entry in $\vec{u}$ is an $(a,z,j)$ state and it conforms with the analogues entries in $Q$ of the $(a,z,j)$ states and then the resulting output $\vec{v}$ are the value functions corresponding with $(a,z,j)$ state.
%
%\item[\textbf{6.}] Given $v_{ij}(a,z)$ computed from (\ref{eq:v_inversion}), now compute choice probabilities using (\ref{eq:choice-prob}) for each $(a,z)$ combination.
\end{itemize}

\section{Appendix: The Planning Problem}
The Lagrangian associated with the Centralized Planning problem is:
\begin{align}
\mathcal{L}  = & \sum_{t=0}^{\infty}  \sum\limits_{z} \sum_{i} \sum_{j} \beta^{t} \  \bigg \{  u(c_{ij}(z, t) ) + \mathrm{E}[ \ \epsilon \ | \ \mu_{ij}(z,t) ] \bigg \}\mu_{ij}(z,t) L_{i} \lambda_{i}(z, t), \\
\nonumber \\
&+ \sum_{t=0}^{\infty} \sum_{i} \chi_{i}(t) \bigg \{ Y_{it} \  - \ \sum_{j} \sum_{z} d_{ji} c_{ji}(z, t) \mu_{ji}(z,t) L_{j}\lambda_{j}(z, t) \bigg \} \nonumber \\
\nonumber \\
&+ \sum_{t=0}^{\infty} \sum_{i} \chi_{2i}(t) \bigg \{1 - \sum_{j}\mu_{ij}(z,t) \bigg \} L_{i} \lambda_{i}(z, t) \nonumber
\label{eq:pp}
\end{align}
Then associated with this problem are two first order conditions. The first one is consumption in $i$ with respect to variety $j$ so:
\begin{align}
\frac{\partial \mathcal{L} }{\partial c_{ij}(z, t)} &=  \beta^{t} u'(c_{ij}(z, t)) \mu_{ij}(z,t) L_{i} \lambda_{i}(z, t) - \chi_{j}(t) d_{ij} \mu_{ij}(z,t) L_{i} \lambda_{i}(z, t) = 0 \\
\nonumber \\
& \Rightarrow \ \ \beta^{t} u'(c_{ij}(z, t) ) = \chi_{j}(t) d_{ij},
\end{align}
which says that the marginal utility of consumption of ($i$ consuming variety $j$) should equal $j$'s multiplier adjusted by the trade cost $d_{ij}$. Then notice that the right hand size is independent of $z$, thus within variety choice we have the result that $u'(c_{ij}(z, t)) = u'(c_{ij}(z', t)) = u'(\bar c_{ij}(t))$ for all $z, z'$ combinations. Then the ratio of marginal utility across variety $j$ is:
\begin{align}
\frac{u'(\bar c_{ij}(t))}{u'(\bar c_{ij'}(t))} = \frac{\chi_{j}(t) d_{ij}}{\chi_{j'}(t) d_{ij'}}
\end{align}
which is starting to look like a gravity type regression where the $\chi$'s are related to the price index in the source countries, adjusted by the iceberg trade costs (e.g. equation (5) in SW for example). To be more concrete, compare $i,j$ purchases from $i,i$ purchases and with log utility one has
\begin{align}
\frac{\bar c_{ij} }{ \bar c_{ii}} = \frac{\chi_{i}(t)}{\chi_{j}(t)}d_{ij}^{-1}
\end{align}
which is quite close to a gravity equation where relative consumption equals a source and destination effect adjusted by the trade costs. Key differences are that this is in quantities, not expenditure; this does not reflect the extensive margin; and related to this last point is that the elasticity is $\gamma$.

%\section{Appendix: Dynamic Log-Logit Trade Model}
%
%This section explores the following problem:
%\begin{align}
%v_{i}(a, z; S_i) = &  \max_{ij} \big  \{ \  v_{ij}(a, z; S_i)  \ \big \}
%\label{eq:valuefun_log}
%\end{align}
%which is the maximum across the discrete choices of different national varieties. The value function conditional on a choice of variety is
%\begin{align}
%v_{ij}(a, z;  S_i  ) = &  \max_{\ a' }\bigg  \{ \log(c_{ij})  + \beta \, \mathbb{E} [v_{i}(a', z'; S_i' )]  \bigg\}
%\label{eq:value_fun_option_log} \\
%\nonumber \\
%\mbox{subject to}  \ & (\ref{eq:trade-budget-constraint}) \  \mathrm{and} \ (\ref{eq:borrowing-constraint}) \nonumber
%\end{align}
%where the only restriction now is that preferences are restricted to be $\log$. A couple of observations is that the choice specific value function can be written as
%\begin{align}
%v_{ij}(a, z;  S_i  ) = &  \max_{\ a' }\bigg  \{ \log\left (\frac{Ra + wz - a'}{p_{ij}} \right )  + \beta \, \mathbb{E} [v_{i}(a', z'; S_i' )]  \bigg\}
%\end{align}
%which is then
%\begin{align}
%v_{ij}(a, z;  S_i  ) = &  \max_{\ a' }\bigg  \{ \log(Ra + wz - a' )  + \beta \, \mathbb{E} [v_{i}(a', z'; S_i' )]  \bigg\} - \log p_{ij}
%\label{eq:value_fun_option_log_p}
%\end{align}
%which then leads to the observation that the optimal $a'$ conditional on a choice $j$ is \textbf{independent} of the price of the consumption good. So what is going on is if you consume an expensive or cheap good, then consumption simply scales up or down so that assets next period are exactly the same. This was verified on the computer. Another approach is to conjecture this policy function and plug it into the euler equation above and show that it respects it.
%
%Then the choice probability becomes
%\begin{align}
%\pi_{ij}(a, z; S_i) = & \exp \left( \frac{ v_{ij}(a, z;  S_i ) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ v_{ij'}(a, z;  S_i ) }{\sigma_{\epsilon}} \right) \\
%\nonumber\\
%\pi_{ij} = & \exp \left( \frac{  -\log p_{ij} }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ -\log p_{ij} }{\sigma_{\epsilon}} \right)\\
%\nonumber \\
%\pi_{ij} = & \frac{p_{ij}^{\frac{-1}{\sigma_{\epsilon}}}}{\sum_{j'} p_{ij'}^{\frac{-1}{\sigma_{\epsilon}}}}
%\end{align}
%where the second line follows from (\ref{eq:value_fun_option_log_p}) which is exactly the same as discussed above in the static model.

%With that said, there are a couple of illustrative cases.
%\begin{itemize}
%  \item \textbf{Static Logit}: Here there is no asset choice and forward looking component
%  \begin{align}
%  \theta_{ij}(z)^{E}  = & \ \frac{u'(c_{ij}(z))}{\sigma}\frac{\partial c_{ij}(z)}{\partial d_{ij}/d_{ij}} -  \frac{\partial \Phi_{i}(z) / \Phi_{i}(z)}{\partial d_{ij}/d_{ij}} \\
%  \nonumber \\
%     = & \ \frac{u'(c_{ij}(z))c_{ij}(z)}{\sigma} -  \frac{\partial \Phi_{i}(z) / \Phi_{i}(z)}{\partial d_{ij}/d_{ij}}
%  \end{align}
%  and focusing on the first part says that the extensive margin trade elasticity is related to the marginal utility of consumption multiplied by the level of consumption (does this have a meaning?). Even in the static case, there is a sense in which the trade elasticity would depend upon income via the state $z$.
%
%  In the case of log preferences, these issues partially disappear with the extensive margin elasticity becoming
%  \begin{align}
%       = & \ \frac{1}{\sigma} -  \frac{\partial \Phi_{i} / \Phi_{i}}{\partial d_{ij}/d_{ij}}
%  \end{align}
%  and it's this result in that would deliver a constant, aggregate trade elasticity the second term cancels (shown below).
%
%  \item \textbf{Dynamic Log-Logit}: Interestingly, this case collapses to something that is similar to the Static Log-Logit. The insight is the because the asset policy function does not depend upon the variety choice, then the continuation value function is common across choices and, thus, it cancels in the numerator and denominator of the choice probabilities. Thus the extensive margin trade elasticity becomes
%        \begin{align}
%       \theta_{ij}(a, z)^{E} = & \ \frac{1}{\sigma} -  \frac{\partial \hat \Phi_{i} / \hat \Phi_{i}}{\partial d_{ij}/d_{ij}}
%     \end{align}
%     where the $\hat \Phi$ is the value of the denominator after continuation value functions and period utility functions are canaled out.
%\end{itemize}
%\textbf{Distribution Elasticity} This is where the asset dimension comes into play and it picks up the idea that a change in trade costs would shift the distribution across states. Per the discussion above, it is only relevant in the non-log, dynamic case. Changes in the distribution of households across asset states arise primarily because the intensive margin elasticity is not zero.
%
%
%Then from here one can see how things collapse or are generalized depending upon the case. First, let's look at each elasticity state by state. Also note that these are partial equilibrium elasticities, they don't take into account how wages or interest rates change in response to clear the goods or asset market.
%
% Here are two special cases:
%\begin{itemize}
%  \item \textbf{Static Discrete Choice}: Here there is no asset choice and thus the intensive margin trade elasticity is
%  \begin{align}
%  \theta_{ij}(z)^{I} = 0
%  \end{align}
%  which means that any change in prices via a change in trade costs maps one for one into a change in consumption and hence $p_{ij}c_{ij}(z)$ is constant.
%  \item \textbf{Dynamic Log + Discrete Choice:} This cases is interesting because assets are being held, but as argued above in (\ref{eq:value_fun_option_log_p}) asset holdings are independent of the variety choice $j$. Hence they are independent of the change in trade costs $d_{ij}$ and we have
%  \begin{align}
%  \theta_{ij}(a,z)^{I} = 0
%  \end{align}
%  so what is happening here is that with log preferences is that the price elasticity of consumption is minus one. A one percent decrease in prices leads to a one percent increase in consumption and when viewed through the budget constraint, this implies that assets are not changing with respect to prices. This result has a second implication that the distribution elasticity $\theta(a,z)_{ij}^{D}$ is unchanging even though assets are being held. That is in the log preference case there is not a reshuffling of households across states in the stationary distribution.
%\end{itemize}
%\bigskip
%
%\textbf{The Aggregate Trade Elasticity} Recall that my definition of the aggregate trade elasticity is the change in relative trade and home consumption or
%\begin{align}
%&\frac{\partial ( M_{ij} / M_{ii} )}{\partial d_{ij}}  \times \frac{d_{ij}}{( M_{ij} / M_{ii} )} = \\
%\nonumber \\
%& \sum_{a,z} \bigg \{ \theta_{ij}(a,z)^{I} + \theta_{ij}(a,z)^{E} + \theta_{ij}(a,z)^{D} \bigg \}\omega_{ij}(a,z) - \bigg \{ \theta_{ii}(a,z)^{I} + \theta_{ii}(a,z)^{E} + \theta_{ii}(a,z)^{D} \bigg \}\omega_{ii}(a,z)
%\end{align}
%and again we can collapse this into several well known cases.
%\begin{itemize}
%  \item \textbf{Static Logit}:
%  \begin{align}
%\frac{\partial ( M_{ij} / M_{ii} )}{\partial d_{ij}}  \times \frac{d_{ij}}{( M_{ij} / M_{ii} )} =& \ \ \sum_{z} \theta_{ij}(z)^{E}\omega_{ij}(z) - \theta_{ii}(z)^{E} \omega_{ii}(z)
%\end{align}
%where the aggregate trade elasticity is a expenditure weighted average of the micro extensive margin elasticities. Then with log preferences
%\begin{align}
% =& \sum_{z} \bigg \{ \underbrace{\frac{1}{\sigma} -  \frac{\partial \Phi_{i}(z) / \Phi_{i}(z)}{\partial d_{ij}/d_{ij}}}_{\theta_{ij}(z)^{E}}
%+ \ \ \underbrace{\frac{\partial \Phi_{i}(z) / \Phi_{i}(z)}{\partial d_{ij}/d_{ij}}}_{\theta_{ii}(z)^{E}} \bigg \} \frac{z\lambda(z)}{\sum_{z}z\lambda(z)}
%\nonumber \\
% =& \ \ \frac{1}{\sigma}
%\end{align}
%where the first line follows from the definition of the micro elasticities and then that with log preferences $\omega_{ij}(z) = \lambda(z)$ because the level of consumption and
%
%
%
%\end{itemize}

\newpage

\bibliography{./bibtex/micro_price_bibtex}

\end{onehalfspacing}

\end{document} 