\documentclass[12pt,pdftex]{article}
\usepackage[pdftex]{graphicx,color}
\usepackage{setspace,palatino,multirow}
\usepackage{amsmath,amssymb}
\usepackage{titlesec}
\usepackage{lscape}
%\usepackage{subfigure}
\usepackage{threeparttable}
\usepackage{natbib}
\bibliographystyle{ecta}
\usepackage{cite}
\usepackage{booktabs}
\usepackage{subcaption}
\usepackage{pdflscape}
\usepackage{afterpage}
\usepackage{xcolor}
\usepackage{rotating}

\definecolor{nblue}{RGB}{0,0,128}

\usepackage[pdftex,colorlinks=true, bookmarks=false,
pdfstartview={XYZ null null 0.65},
pdftitle={The Consumption Response to Trade Shocks: Evidence from the US-China Trade War},
pdfauthor={ Michael E. Waugh},
pdfkeywords={economics, trade, dynamics, quant econ, consumption, data science, cars,
waugh, incomplete markets, inequality, Ricardo, julia, migration, China, trade war, tariffs, python, matplotlib,
auto, difference in difference },
colorlinks=true,linkcolor=darkgray,citecolor=darkgray,urlcolor=darkgray,
breaklinks]{hyperref}

\newcounter{saveeqni}%
\newcounter{saveeqn01i}%
\newcommand{\alpheqni}{\setcounter{saveeqni}{\value{section}}%
%\setcounter{saveeqn01i}{\value{subsectioni}}%
\renewcommand{\theequation}
    {\alph{saveeqni}\mbox{.\arabic{equation}}}}%
\newcommand{\reseteqni}{\setcounter{equation}{\value{saveeqni}}%
\renewcommand{\theequation}{\arabic{equation}}}%

\newtheorem{as}{Assumption}
\newtheorem{reg}{Regularity Condition}
\newtheorem{conjecture}{Conjecture}
\newtheorem{corr}{Corollary}
\newtheorem{df}{Definition}
\newtheorem{lemma}{Lemma}
\newtheorem{prp}{Proposition}
\newtheorem{rmk}{Remark}
\newenvironment{prf}{{\bf Proof}}{\hfill { }}

\DeclareMathOperator*{\plim}{plim}
\DeclareMathOperator*{\umax}{max}

\special{papersize=8.5in,11in}
\onehalfspacing
\setlength{\parindent}{0.1em}
\setlength{\parskip}{.09in}
\textwidth15.75cm
\evensidemargin 1.5in
\oddsidemargin 1.5in
\topmargin 8.5cm
\textheight 10in
\hyphenation{over-lapping}

\titleformat{\section}{\color{black}\large\bf}{\color{black}{\thesection.}}{.25cm}{}
\titleformat{\subsection}{\color{black}\normalsize\bf}{\thesubsection.}{.5em}{}
\titleformat{\subsubsection}{\color{black}\normalsize\bf}{\thesubsubsection.}{.5em}{}

\titlespacing{\section}{0pt}{*1.5}{*.5}
\titlespacing{\subsection}{0pt}{*1.5}{*.5}
\titlespacing{\subsubsection}{0pt}{*1.5}{*.5}

\def\thesection{\arabic{section}}
\def\thesubsection{\arabic{section}.\arabic{subsection}}
\def\thesubsubsection{\arabic{section}.\arabic{subsection}.\Alph{subsubsection}}

\def\citeapos#1{\citeauthor{#1}'s (\citeyear{#1})}

\renewcommand{\arraystretch}{1.1}
\usepackage[margin=2cm]{geometry}

\begin{document}

\begin{onehalfspacing}

{\large \textbf{HA-T: Heterogeneous Agent Trade}}

\vspace{1cm}

%{\textbf{PRELIMINARY AND INCOMPLETE}}
%
%\vspace{1cm}

\href{http://www.waugheconomics.com/}{Michael E. Waugh} \\ Federal Reserve Bank of Minneapolis and NBER

\vspace{0.5cm}

March 2022

\vspace{1.5cm}


\normalsize

ABSTRACT ------------------------------------------------------------------------------------------------------------

This paper develops a model of heterogenous agents and international trade. Heterogenous agents are modeled as in the standard incomplete markets tradition with household's facing incomplete insurance against idiosyncratic productivity and taste shocks. Trade in goods follows the Armington tradition but is derived from the ``bottom up'' with micro-level heterogeneity shaping the aggregate pattern of trade. In the efficient allocation, I recover standard results regarding gravity and the gains from trade. In the decentralized allocation, the pattern of trade is distorted, the aggregate trade elasticity is non-constant and the benefits from globalization are distributed unequally. I use model to explore two issues: the ability of trade policy to improve outcomes and how financial globalization complements globalization in goods trade.

------------------------------------------------------------------------------------------------------------------------------
%%\vspace{0.25cm}
%
%%JEL Classification:
%%
%%
%%Keywords:

\vspace{6.5cm}

\footnotesize Email: michael.e.waugh@gmail.com. The views expressed herein are those of the author and not necessarily those of the Federal
Reserve Bank of Minneapolis or the Federal Reserve System. This project was developed with research support from the National Science Foundation (NSF Award number 1948800).

\hspace{-0.05cm}



\thispagestyle{empty}
\newpage
\normalsize

\section{The Model}

The model is setup in a simple and transparent way. Trade is in the Armigton tradition with each country producing a nationally differentiated variety. Households follow the standard incomplete markets tradition. The key departure is that I lean into household heterogeneity and have households make a discrete choice over the varieties they consume. Aggregate trade flows between countries are, thus, given by the explicit aggregation of households and the choices they make.

\subsection{Trade and Production}\label{sec:trade}

There are $M$ locations which I will call a country. Each country produces a differentiated product as in the Armington tradition and these differentiated products. In country $i$, competitive firms have the following production technology to produce variety $i$:
\begin{align}
q_i = A_i N_i,
\label{eq:production}
\end{align}
where $N_i$ are the efficiency units of labor supplied by households in country $i$.

Trade faces several obstacles. There are iceberg trade costs $d_{ji}$ for a good to go from supplier $i$ to buyer $j$. Cross-border trade faces policy obstacles, i.e. tariffs $\tau_{ji}$. The notation here is such that $\tau_{ji}$ which is the ad-valorem tariff rate that country $j$ imposes on the commodity that county $i$ produces.

Profit maximization of the competitive goods producers in location $i$ results in the wage per efficiency unit reflecting the value of the marginal product of labor
\begin{align}
w_{i} = p_{i} A_{i}.
\label{eq:marginal-product}
\end{align}
Given iceberg trade costs and tariffs, the unit cost for country $j$ to purchase a good from location $i$ is
\begin{align}
p_{ji} = \frac{d_{ji}(1 +\tau_{ji})w_{i}}{A_{i}}.
\label{eq:marginal-product-ship}
\end{align}

\subsection{Households}

There is a mass of $L_i$ households in each location $i$. Households are immobile across countries. They are infinite lived and have time-sparable preferences over non-durable consumption varieties:
\begin{align}
\small
E_{0} \sum_{t = 0}^{\infty} \beta^{t} u( \{ c(j)_t \}_{M}),
\end{align}
where the notation $\{ c(j)_t \}_{M}$ means that the household has preferences over all $j$ varieties supplied by $M$ countries in the world. My focus is on the situation where households each period receive additive Type 1 extreme value shocks $\epsilon(j)$ with dispersion parameter $\sigma_{\epsilon}$ and then households make a discrete choice about which variety $j$ to each period and a continuous choice about how much. More specifically, the utility associated with the choice of variety $j$ and leisure is
\begin{align}
u( c(j)_t ) =  \frac{ c(j)_t ^{1-\gamma}}{1- \gamma} + \epsilon(j)_t. \label{eq:utility}
\end{align}
where consumption mapped into utils with a standard CRRA function, $\epsilon(j)$ is the taste shock.

A household's efficiency units are stochastic and they evolve according to a discrete state Markov chain. Mathematically, $z$ is a households efficiently units and $\mathcal{P}(z,z')$ describes the probability of a household with state $z$ efficiency units transiting to state $z'$.

Households can save and borrow in a non-state contingent asset $a$. The units of the asset are chosen to be the numeraire and pays out with gross interest rate $R$. I discuss this more in depth below, but the determination of $R_{i}$ is either exogenously given or the rate that clears the bond market (local or global). An country specific, exogenous debt limit $\phi_{i}$ constrains borrowing so:
\begin{align}
a_{t+1} \geq - \phi_{i}.
\label{eq:borrowing-constraint}
\end{align}
All these pieces come together in the household's budget constraint, conditional on choosing variety $j$ to consume, and focusing on a stationary setting where prices and transfers are constant:
\begin{align}
a_{t+1} + p_{ij}c(j)_{t}  \leq    R_{i} a_{t} + w_{i} z_{t} + T_{i,\tau}.\label{eq:trade-budget-constraint}
\end{align}
The value of asset purchases and consumption expenditures must be less than or equal to asset payments, labor earnings, and transfers arising from trade policy (the $T_{i,\tau}$).

\subsection{Recursive Formulation of the Household Problem}

The state variables of a individual household are it's asset holdings and efficiency units. The aggregate states (and outcomes in other countries) only matter through prices and transfers and thus I summarize the aggregate state in country $i$ as $S_i = (\{ w_i \}_{M}, T_i, R_{i})$ which is the collection of the wage per efficiency units, transfers, and interest rates. The wage vector $\{ w_i \}_{M}$ is sufficient here since they determine prices in (\ref{eq:marginal-product-ship}) and, thus, consumers can make the appropriate choice of commodities.

The value function of a household in country $i$ is
\begin{align}
v_{i}(a, z; S_i) = &  \max_{ij} \big  \{ \  v_{ij}(a, z; S_i)  \ \big \}
\label{eq:valuefun}
\end{align}
which is the maximum across the discrete choices of different national varieties. The value function conditional on a choice of variety is
\begin{align}
v_{ij}(a, z;  S_i  ) = &  \max_{\ a' }\bigg  \{ u(c(j))  + \beta \, \mathbb{E} [v_{i}(a', z'; S_i' )]  \bigg\}
\label{eq:value_fun_option} \\
\nonumber \\
\mbox{subject to}  \ & (\ref{eq:trade-budget-constraint}) \  \mathrm{and} \ (\ref{eq:borrowing-constraint}) \nonumber
\end{align}
where households choose asset holdings and the level of consumption is residually determined through the budget constraint. The continuation value function is the expectation over (\ref{eq:valuefun}) where the expectation is taken with respect to $z'$ and taste shocks in the future. What this last point means is that households understand that their may be situations where, e.g., they really desire the high priced imported good and, hence, save accordingly.

As is well known, the Type 1 extreme value shocks give rise to the following choice probabilities for each differentiated good. So
\begin{align}
\pi_{ij}(a, z; S_i) = \exp \left( \frac{ v_{ij}(a, z;  S_i ) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ v_{ij'}(a, z;  S_i ) }{\sigma_{\epsilon}} \right) \label{eq:choice-prob}
\end{align}
which is the probability that a household with assets $a$ and efficiency units $z$ chooses country variety $j$. And then the expectation of (\ref{eq:valuefun}) with respect to the taste shocks takes the familiar log-sum form
\begin{align}
\mathbb{E}_{\epsilon} v_i(a, z; S_i) = \sigma_{\epsilon} \log \left\{ \sum_{j'} \exp \left( \frac{  v_{ij}(a, z;  S_i )}{\sigma_{\epsilon}} \right) \right\} \label{eq:log_sum}
\end{align}
Associated with the problem (\ref{eq:valuefun}) are an asset policy function $g_{ij}(a, z; S_i)$ which prescribes asset holdings given a state and variety choice, and then define $c_{ij}(a, z; S_i)$ as the consumption function which prescribes consumption given states and variety choice.

\subsection{Aggregation}

Define the probability distribution of households across individual states $\lambda_{i}(a, z; S_i )$ which is the probability measure of households with asset levels $a$ individual shock $z$ in country $i$. This distribution evolves according to
\begin{align}
\lambda_i(a', z', S_i') = \sum_{z}\sum_{j} \sum_{a: a' = g_{ij}(a, z; S_i)} \pi_{ij}(a, z; S_i) \mathcal{P}(z, z') \lambda_i(a, z; S_i).
\label{eq:law_motion}
\end{align}

\textbf{Aggregate Labor Supply.}  Aggregate efficiency units are
\begin{align}
N_i = L_{i}\sum_{z} \sum_{a}\ z \lambda_i(a, z; S_i) \label{eq:ag-labor-supply}
\end{align}
where the inner most term reflects efficiency units multiplied by the measure of households with that state. This is all multiplied by $L_i$ which is the mass of households in country $i$.

\textbf{Asset Holdings.} The aggregate quantity of asset holdings simply sums across the distribution conditional on choosing
\begin{align}
\mathrm{A}_i' = L_{i} \sum_{z}\sum_{j}\sum_{a}  g_{ij}(a, z; S_i) \pi_{ij}(a, z; S_i) \lambda_i(a, z; S_i).
\label{eq:aggregate_asset}
\end{align}

\textbf{National Income and Consumption} Starting from the production side of our economy, the value of aggregate production must equal aggregate payments to labor so
\begin{align}
p_{i} Y_{i} = p_{i} A_{i} N_{i} = L_i \sum_{z} \sum_{a} w_{i} \ z \ \lambda_i(a, z; S_i)
\label{eq:value_production}
\end{align}
where the last term sums over wage payments for each household type. Then by summing over individual consumers' budget constraint and substituting in (\ref{eq:value_production}), we arrive at the aggregated budget constraint:
\begin{align}
p_{i} Y_{i}  = \widetilde{P_{i} C_i}  + \bigg[-R_i\mathrm{A_i} +  \mathrm{A_i'} \bigg] - T_{i,\tau},
\label{eq:aggregate_budget_constraint}
\end{align}
where national income equals the value of aggregate consumption $\widetilde{P_{i} C_i}$, the country's the net asset position, all net of transfers. Here the value of aggregate consumption is
\begin{align}
\widetilde{P_{i} C_i} = L_{i} \sum_{z}\sum_{j}\sum_{a}  p_{ij} c_{ij}(a, z; S_i) \pi_{ij}(a, z; S_i) \lambda_i(a, z; S_i)
\end{align}
where one can see a bug and a feature of this model. Here there is an ``index number problem`` in the sense that there is not an ideal price index for which one can decompose aggregate values in to a price and quantity component. This is in contrast to, e.g., a model where households consume a CES bundle of goods.

\textbf{Trade Flows} It's first worth walking though imports for a given set of states. So for households with states $a$ and $z$ we have
\begin{align}
M_{ij}(a, z; S_i) = p_{ij} c_{ij}(a, z; S_i) \ \pi_{ij}(a, z; S_i).
\end{align}
Then aggregate imports from country $i$ to country $j$ sums over this weighted by the mass of households in those states so
\begin{align}
M_{ij} = L_i \sum_{z}\sum_{a} M_{ij}(a, z; S_i) \lambda_i(a, z; S_i).
\label{eq:imports}
\end{align}
The same can be done for a countries exports. Again, focusing on exports to a location given a set of states we have
\begin{align}
X_{ji}(a, z; S_j) = p_{ji} c_{ji}(a, z; S_j) \pi_{ji}(a, z; S_j)
\end{align}
Then aggregate exports from country $i$ to country $j$
\begin{align}
X_{ji} = L_j \sum_{z}\sum_{a} X_{ji}(a, z; S_j) \lambda_j(a, z; S_j)
\label{eq:exports}
\end{align}

\subsection{Market Clearing and the Decentralized Equilibrium}

Given the definitions above, I discuss the market clearing conditions than an equilibrium must respect.

\textbf{The Goods Market.} From here we can equate the value of production of commodity $i$ in country $i$ with global demand for country $i$'s commodity:
\begin{align}
p_{i} Y_{i} &= \sum_{j}^{M}  X_{ji} \label{eq:goods-supply},
\end{align}
where the left hand side is production and the right hand side is world demand for the commodity from (\ref{eq:exports}).

\textbf{The Bond Market.} The second market clearing condition is in the bond market. Two cases are considered ``financial globalization'' in which there is a global bond market with one real interest rate $R$. In this case the market clearing condition is
\begin{align}
\sum_{i}^{M} \mathrm{A_i'} = 0
\label{eq:bond-market-global}
\end{align}
which says that net asset demand must equal zero across all countries. The second case considerer is ``financial autarky'' in which there is a local bond market that facilitates within country risk-sharing, but not globally. In this case, there is an interest rate is $R_i$ for each country and the associated market clearing condition is
\begin{align}
\mathrm{A_i'} = 0 \ \ \forall i
\label{eq:bond-market-country}
\end{align}
Below is a formal definition of a Stationary Equilibrium when the aggregate state $S_i$ is constant and not changing.

\textbf{A Stationary Equilibrium.} A Stationary Equilibrium are asset policy functions and commodity choice probabilities $\{\  g_{ij}(a, z), \pi_{ij}(a, z) \ \}_{i}$, probability distributions $\lambda_i(a, z)$, and positive real numbers $\left \{w, p, R\right \}_{i}$ such that
\begin{itemize}
\vspace{-.4cm}
\item[i]  Prices ($w, p$) satisfy (\ref{eq:marginal-product}, \ref{eq:marginal-product-ship});
\item[ii] The policy functions and choice probabilities solve the household's optimization problem in (\ref{eq:value_fun});
\item[iv] The probability distribution $\lambda_i(a, z)$ induced by the policy functions, choice probabilities, and primitives satisfies (\ref{eq:law_motion}) and is a stationary distribution;
\item[v] Goods market clears:
\begin{align}
p_{i} Y_{i} - \sum_{j}^{M}  X_{ji} = 0, \ \ \forall i
\end{align}
\item[v] Bond market clears with either Financial Globalization with $R_i = R$ and
\begin{align}
\sum_{i}^{M} \mathrm{A_i'} = 0.
\label{eq:fg-condition}
\end{align}
Or Financial Autarky where
\begin{align}
\mathrm{A_i'} = 0, \ \ \forall i
\label{eq:fa-condition}
\end{align}
\end{itemize}

\subsection{The Centralized Equilibrium}

Here is the planning problem:
\begin{align}
\mathcal{W^{SP}} =\sum_{t=0}^{\infty}  \sum_{i} \sum\limits_{z} \beta^{t} \ \int\limits_{\epsilon} u_{j}(c_{i}(z, \epsilon, t), \ell_{i}(z, \epsilon, t), \epsilon) L_{i} \lambda_{i}(z, t).
\label{eq:sp-social_welfare}
\end{align}
Here social welfare is the average value of households utility across countries $j$, productivity states $z$ and preference shocks $\epsilon$. The average is computed with respect to the measure of households $L_{j}\lambda_{j}(z, \epsilon, t)$ with those shock states and preference shocks at date all dates $t$. Utility depends directly upon the consumption allocation $c_{j}(z, \epsilon, t)$, labor supply decision $\ell_{j}(z, \epsilon, t)$, but also directly on the idiosyncratic preference shock to buying other countries goods.

We cast the Planners Problem in terms of the planner choosing consumption, labor supply allocations, and goods choice probabilities for each state and date. To cast the problem in terms of choice probabilities, we integrate out the preference shocks conditional on a set of choice probabilities for each household state. These choice probabilities prescribe an assignment of those households with the largest relative preference shock to eat that good or not. So given set of states $j, z, t$, utility is
\begin{align}
u(c_{i,j}(z, t), \ell_{i,j}(z, t) ) + \mathrm{E}[ \ \epsilon \ | \ \mu_{i,j}(z,t) ].
\label{eq:utility-shocks}
\end{align}
\textbf{THIS IS NOT RIGHT.} C

\textbf{Law of Motion.} The law of motion describing how the measure of households evolves across states and locations is
\begin{align}
\lambda_{i}(z', t+1)  & =   \sum_{z} \mathcal{P}(z, z') \lambda_{i}(z,  t)  \  \label{eq:planner_law_motion} .
\end{align}
Given a distribution of households, the effective labor units in the urban and rural area are
\begin{align}
N_{i,t} =& z \sum_{z} \sum_{j} \ell_{ij}(z, t) \lambda_{i}(z, t)\nonumber
\end{align}
Aggregate production of the final good is
\begin{align}
Y_{it} = A_i N_{i,t} .
\label{eq:planner_value_production}
\end{align}
Combining the amount of resources available in (\ref{eq:planner_value_production}) with the consumption and moving decisions we have the following resource constraint:
\begin{align}
Y_{it}\  \geq \ & \sum_{j} \sum_{z} d_{j,i} c_{j,i}(z, t) L_{j}\lambda_{j}(z, t)
\end{align}
which says that production must be greater than or equal to consumption which is the first term on the righthand side of (\ref{eq:planner_income_side_gdp}) and the moving costs associated with the migration of households across locations which is the second term on the righthand side. Here we compactly sum across all $j'$ and $j$ location pairs and reminding ourselves that the moving cost for staying in a location is zero, i.e., $m_{j,j} = 0$.

The \textbf{Centralized Planner's Problem} is the following:
{\small
\begin{align}
\mathcal{W}^{*} = & \max\limits_{c_{i,j}(z, t),\ \mu_{i,j}(z, t)} \ \sum_{t=0}^{\infty}\sum_{i} \sum_{j} \beta^{t} \bigg \{ u(c_{i,j}(z, t)) + E[ \ \epsilon \ | \ \mu_{i,j}(z,t)]  \bigg \} \mu_{i,j}(z,t) L_{i}\lambda_{i}(z, t) \ \ \nonumber \\
\nonumber \\
& \ \ \mbox{subject to} \ \ (\ref{eq:planner_value_production}) \ \ (\ref{eq:planner_income_side_gdp}) \ \ \mbox{and} \ \ (\ref{eq:planner_law_motion}) \ \ \mbox{and an inital condition} \ \ \lambda_i(z, 0).
\label{eq:planner_problem}
\end{align}}

\textbf{A Stationary Centralized Planner Allocation.}  A Stationary Centralized Planner Allocation are time invariant policy functions $\{\ c_{i,j}(z),\ \mu_{i,j}(z) \ \}$, a probability distribution $\lambda_{ij}(z)$, and positive real numbers $N_{i}$ where:
\begin{itemize}
\item[i] The policy functions solve the Centralized Planner's Problem in (\ref{eq:planner_problem});
\item[ii] The probability distribution $\lambda_{j}(z, s, x, i)$ associated with $\{\ \mu_{j',j}(z, s, x, i), \ \pi(s',s), \ \varphi(x',x, j), \ \phi(\nu) \ \}$ is a stationary distribution;
\item[iii] Effective labor units in the rural and urban areas satisfy (\ref{eq:planner_labor_supply}).
\end{itemize}





\subsection{Special Cases / Running Examples}

There are two special cases that I will refer back to repeatedly in the text. One is what I will call the CES case in which I mean that the household has access to a constant elasticity aggregator over the different varieties. The second case is the ``hand-to-mouth'' case in which households have no access to borrowing or lending.

\textbf{CES case.} This case is relatively familiar and standard. Here there is an aggregator over national varieties of the CES class, so
\begin{align}
c = \bigg \{ \sum_{j}^{M}  c_{j}^{\frac{\theta - 1}{\theta}} \bigg \}^{\frac{\theta}{\theta - 1}},
\label{eq:ces-armington}
\end{align}
where $\theta$ controls the elasticity of substitution across products. Then each household has the following demand curve for a region's variety:
\begin{align}
c_{ij}(a,z; S_i) & = \left(\frac{p_{ij}}{P_i}\right)^{-\theta}c_{i}(a,z; S_i).
\label{eq:ces-demand-curve}
\end{align}
which is given the total amount of consumption $c_{i}(a,z; S_i)$ a household chooses given their states and $P_i$ is the CES price index:
\begin{align}
P_{i} &= \bigg \{ \sum_{j}^{M} p_{ij}^{1 - \theta} \ \bigg \}^{\frac{1}{1-\theta}}.
\label{eq:ces-price-index}
\end{align}
what is unique about this setting is that household expenditure shares on different goods are independent of their state. So the expenditure share of a household in location $i$ with state $a$ and $z$ is
\begin{align}
\frac{p_{ij}c_{ij}(a,z; S_i)}{P_i c_{i}(a,z; S_i)} & = \left(\frac{p_{ij}}{P_i}\right)^{1-\theta},
\label{eq:ces-expenditure-share}
\end{align}
which depends only on prices that all households face. What is happening here is that the CES aggregator is homothetic in total consumption. So while households are choosing different levels of total consumption to solve their income-fluctuations problem, how that demand is divided up is always the same. From here, one can aggregate and arrive at a ``gravity-like'' import demand system with
households with states $a$ and $z$ importing
\begin{align}
M_{ij}(a, z; S_i) = p_{ij} \left(\frac{p_{ij}}{P_i}\right)^{-\theta} c_{i}(a,z; S_i).
\end{align}
Then aggregate imports from country $i$ to country $j$ sums over this weighted by the mass of households in those states which gives
\begin{align}
M_{ij} =  \left(\frac{p_{ij}}{P_i}\right)^{1-\theta} \times P_{i} C_{i}
\end{align}
where the last term follows by noting that the sum of $c_{i}(a,z; S_i)$ across the distribution is aggregate consumption and then this is put in value terms by multiplying and dividing by the CES price index.

\textbf{Hand-to-Mouth, No Labor Supply,Log Households.} This case focuses on the situation described|so there does not exist a risk free asset to smooth consumption, nor can households adjust their labor supply. The value function of a household contemplating the purchase of national variety $j$ is:
\begin{align}
v_{ij}(a, z;  S_i  ) = &   u\left( \frac{w_{i}z}{p_{ij}} \right) + \epsilon(j)  + \beta \, \mathbb{E} [v_{i}(z'; S_i' )]
\end{align}
and then the choice probability becomes
\begin{align}
\pi_{ij}(z; S_i) = & \exp \left( \frac{ v_{ij}(z;  S_i ) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ v_{ij'}(z;  S_i ) }{\sigma_{\epsilon}} \right) \\
\nonumber\\
\pi_{ij}(z; S_i) = & \exp \left( \frac{ u\left( \frac{w_{i}z}{p_{ij}} \right) ) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ u\left( \frac{w_{i}z}{p_{ij}} \right) }{\sigma_{\epsilon}} \right)
\end{align}
where the last line follows from the properties of the $\exp$ function and that the continuation value function is exactly the same independent of the good chosen. Two more steps. With the CRRA utility speciation, a houeholds efficiency units drops out and thus the choice probability does not depend upon $z$. Then with $\log$ this expression collapses to
\begin{align}
\pi_{ij}(S_i) = \frac{p_{ij}^{-\sigma_{\epsilon}}}{\sum_{j'} p_{ij'}^{-\sigma_{\epsilon}}}
\end{align}
where here we recover the well known ``ces-logit-isomorphisim'' between the logit demand system and the CES aggregator in \ref{eq:ces-armington} above by setting $\sigma_\epsilon = 1 - \theta$.

Like in the CES case, a similar aggregate gravity type relationship can be recovered. Individual imports are
\begin{align}
M_{ij}(z; S_i) = p_{ij} \frac{w_{i}z}{p_{ij}} \pi_{ij}(S_i).
\end{align}
then aggregate imports from country $i$ to country $j$ sums over this weighted by the mass of households in those states which gives
\begin{align}
M_{ij} =  \frac{p_{ij}^{-\sigma_{\epsilon}}}{\sum_{j'} p_{ij'}^{-\sigma_{\epsilon}}} \times \widetilde{P_{i} C_{i}}
\end{align}
where the last term follows from imposing the aggregated budget constraint with aggregate labor income equalling aggregate expenditure.

%\section{When Household Heterogeneity Does Not Matter?}
%
%Before studying computational results. It's worth thinking about when and when not the household heterogeneity may not matter. In the first couple of remarks below, I abstract from issues related to tariffs
%
%\subsection{Issue \# 1: Trade Imbalance}
%
%To see how this works, let's connecting trade and financial flows. The trade side of the model in (\ref{sec:trade}) determines how aggregate demand in each country is sourced across different countries:
%\begin{align}
%P_{i}C_i  = p_{i}\bigg \{ \left(\frac{p_{i}}{P_i}\right)^{-\theta}C_i  \bigg \} +  \underbrace{\sum_{j \neq i}^{M}  p^{cif}_{ij}\bigg \{ \left(\frac{p_{ij}}{P_i}\right)^{-\theta}C_i
%\bigg \}}_{IM_{i}} + \underbrace{\sum_{j \neq i}^{M}  \tau_{ij} p^{cif}_{ij} \bigg \{ \left( \frac{p_{ij}}{P_{j}} \right)^{-\theta}C_i \bigg \}}_{T_{i,\tau}}.
%\label{eq:goods-supply-imports}
%\end{align}
%where $p^{cif}_{ij} = \frac{d_{ji} w_{i}}{A_{i}}$, so these prices including shipping costs, but exclude tariffs. Imports here are defined as ``customs value'' per NIPA guidelines, i.e., the price paid for foreign goods excluding tariffs. Substituting in (\ref{eq:goods-supply-imports}) into the (\ref{eq:goods-supply-exports}) and then into the aggregated budget constraint (\ref{eq:aggregate_budget_constraint}) implies the following relation:
%\begin{align}
%\underbrace{\sum_{j \neq i}^{M}  p_{ji}\bigg \{ \left(\frac{p_{ji}}{P_j}\right)^{-\theta}\big [ C_j \big ]\bigg \}}_{EX_{i}} \ - \ \underbrace{\sum_{j \neq i}^{M}  p_{ij}\bigg \{ \left(\frac{p_{ij}}{P_i}\right)^{-\theta}[ C_i  \big ] \bigg \}}_{IM_{i}}  = \bigg[-R\mathrm{A_i} +  \mathrm{A_i'} \bigg]
%\label{eq:imbalance}
%\end{align}
%that is the trade imbalance must equal the net asset position of a country.
%
%From this condition, one can show how this reduces to standard relationships exploited in the trade literature. First, consider the case of Financial Autarky, so that condition (\ref{eq:fa-condition}) holds. Net asset holdings in each country are zero (though recall, gross asset positions for individual households within a country may be non-zero). This implies
%\begin{align}
%\underbrace{\sum_{j \neq i}^{M}  p_{ji}\bigg \{ \left(\frac{p_{ji}}{P_j}\right)^{-\theta}\big [ C_j \big ]\bigg \}}_{EX_{i}} \ = \ \underbrace{\sum_{j \neq i}^{M}  p_{ij}\bigg \{ \left(\frac{p_{ij}}{P_i}\right)^{-\theta}[ C_i  \big ] \bigg \}}_{IM_{i}},
%\label{eq:imbalance_v2}
%\end{align}
%or balanced trade. There is one more step, however, what shows up in (\ref{eq:imbalance}) is demand $C_i$, not supply or income. But from the aggregated budget constraint, and abstracting from tariffs, condition (\ref{eq:fa-condition}), implies that the value of output (and labor income) must equal the value of consumption
%\begin{align}
%p_{i} Y_{i}  = P_{i}  C_i ,
%\end{align}
%and after substituting in the relationship between wages and prices we have
%\begin{align}
%\underbrace{\sum_{j \neq i}^{M}  p_{ji}\bigg \{ \left(\frac{p_{ji}}{P_j}\right)^{-\theta} \left( \frac{ w_j N_j }{P_j} \right) \bigg \}}_{EX_{i}} \ = \ \underbrace{\sum_{j \neq i}^{M}  p_{ij}\bigg \{ \left(\frac{p_{ij}}{P_i}\right)^{-\theta}\left( \frac{w_i N_i}{P_i}  \right) \bigg \}}_{IM_{i}},
%\label{eq:imbalance_v3}
%\end{align}
%which is the same exact system of equations explored in canonical trade models. Alvarez Lucas is probably best example. What else?
%
%There is one more issue which is addressed next. In this system of equations is $N_i$ shows up ant it's labor supply.
%
%\subsection{Issue \# 2: Labor Supply and Market Incompleteness}
%
%Obviously set N exogenous recovers everything.
%
%Work out efficient allocation. N is different? What about $\frac{dw}{d\tau}$?
%
%\subsection{Issue \# 3: Tariffs and Insurance}
%
%When lump-sum rebated, the implied distribution of potential labor earnings contracts? easy to show? This is like some of the tax progressivity stuff.




\newpage

\section{Endogenous Grid Method}

First, I'm going to derive the Euler equation for this model. I'll abstract from the situation in which the HH is at the borrowing constraint.

Focus on the within a variety choice component, the households value function can be written as:
\begin{align}
v_{ij}(a, z) = \max_{a'} u \left( \frac{R_i a + w_i z - a'}{p_{ij}} \right) + \beta  \mathrm{E} v(a', z')
\end{align}
then the first order condition associated with this problem is:
\begin{align}
\frac{u'(c_{ij}(a, z))}{p_{ij}} = \beta \mathrm{E} \frac{\partial v(a', z')}{\partial a'}
\end{align}
which is saying that, conditional on a variety choice the left hand side is the loss in consumption units which is $1 / p_{ij}$ evaluated at the marginal utility of consumption and then this is set equal to the marginal gain from saving a bit more which is how the value function changes with respect to asset holdings. Now we can arrive at the $\frac{\partial v(a', z')}{\partial a'}$ in the following way, so start from the log-sum expression for the expected value function
\begin{align}
\mathbb{E}_{\epsilon} v(a', z') =  \sigma_{\epsilon} \log \left\{ \sum_{j'} \exp \left( \frac{  v_{ij}(a', z')}{\sigma_{\epsilon}} \right) \right\}
\end{align}
and then differentiate this with respect to asset holdings which gives:
\begin{align}
\frac{\partial \mathbb{E}_{\epsilon} v(a', z')}{\partial a'} = \left( \frac{\sigma_{\epsilon}}{\sum_{j'} \exp \left( \frac{  v_{ij}(a', z')}{\sigma_{\epsilon}}\right)} \right)
\left[ \sum_{j'} \exp \left( \frac{  v_{ij}(a', z')}{\sigma_{\epsilon}}\right) \frac{1}{\sigma_{\epsilon}} \frac{\partial v_{ij}(a', z')}{\partial a'}  \right]
\end{align}
Then if you look at this carefully and notices how the choice probabilities from (\ref{eq:choice-prob}) are embedded in here, we have:
\begin{align}
\frac{\partial \mathbb{E}_{\epsilon} v(a', z')}{\partial a'} = \sum_{j'} \pi_{ij}(a', z) \frac{\partial v_{ij}(a', z')}{\partial a'}
\end{align}
and then we can just apply the Envelop theorem to the value functions associated with the discrete choices across the options:
\begin{align}
\frac{\partial \mathbb{E}_{\epsilon} v(a', z')}{a'} = \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))R_{i}}{p_{ij}}
\end{align}
So then putting everything together we have:
\begin{align}
\frac{u'(c_{ij}(a, z))}{p_{ij}} = \beta R_{i} \mathrm{E}_{z'} \left[ \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))}{p_{ij}} \right]
\end{align}
where this has a very natural form: you set the marginal utility of consumption today equal to the marginal utility of consumption tomorrow adjusted by the return on delaying consumption, and the expected value of the marginal utility of consumption which reflects how the uncertainty over both ones' preference over different varieties and shocks to efficiency units. Taking into account the borrowing constraint then gives the generalized Euler equation from which the endogenous grid method will exploit:
\begin{align}
\frac{u'(c_{ij}(a, z))}{p_{ij}} = \max \left\{ \beta R_{i} \mathrm{E}_{z'} \left[ \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))}{p_{ij}} \right] \ , \  u \left( \frac{R_i a + w_i - \phi_{i}}{p_{ij}} \right) \right \}
\label{eq:euler_equation}
\end{align}

\subsection{EGM-Discrete Choice Algorithm}

Here is a proposed approach. This focuses on just the consumer side in one country $i$.
\begin{itemize}
\item[\textbf{0.}] Set up an asset grid as usual. Then guess (i) a consumption function $g_{c,ij}(a,z)$ for each $a$, $z$, and product choice $j$ and (ii) choice specific value function $v_{ij}(a,z)$.

\item[\textbf{1.}] Given the guessed value functions compute the choice probabilities from (\ref{eq:choice-prob}) for each $(a,z)$ combination.

\item[\textbf{1.}] Given the consumption function and choice probabilities compute the RHS of (\ref{eq:euler_equation}) first.

\item[\textbf{2.}] Then invert to find the new updated consumption choice so
\begin{align}
c_{ij}(\tilde a, z) = u^{' -1}\left\{ p_{ij} \max \left\{ \beta R_{i} \mathrm{E}_{z'} \left[ \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))}{p_{ij}} \right] \ , \  u \left( \frac{R_i a + w_i - \phi_{i}}{p_{ij}} \right) \right \} \right \}
\end{align}
where $u^{' -1}$ is the inverse function of the marginal utility of consumption.

Side note: One of the interesting things about this equation is that the direct $j$ component on the RHS that only affects the consumption choice is through the price. Can this be exploited? We also know the choice probabilities need to sum to one, so is there a way to map the consumption choice into the choice probabilities?

\item[\textbf{3.}] The key issue in this method is that we have found  $c_{ij}(\tilde a, z)$ where the consumption function is associated with some asset level that is not necessarily on the grid. The solution is to (i) use the budget constraint and infer $\tilde a$ given that $a'$ was chosen above (that's where we started), $z$, and $c_{ij}(\tilde a, z)$. Now we have a map from $\tilde a$ to $a'$ for which one can use interpolation to infer the $a'$ chosen given $a$ where $a$ is on the grid.

\item Do steps \textbf{2.} and \textbf{3.} for each $j$ variety choice. This then makes the function $g_{a,ij}(a,z)$ mapping each state and $j$ choice (today) into $a', z'$ states and then from the budget constraint we have an associated consumption function $g_{c,ij}(a,z)$

\item[\textbf{3.}] Compute utility for each $a,z,j$ state given consumption function excluding the logit shock (because the $v_{ij}(a,z)$ does not include and how it's used it is excludes the logit shock). 
\begin{align}
u(g_{c,ij}(a,z)), \label{eq:utility_azj}
\end{align}

\item[\textbf{4.}] Compute the $\mathrm{E}\left[ v(g_{a,ij}(a,z), z') \right]$. \textbf{I need to expand upon this, but this is includes the transition implied by the policy function, the shock, and then the logit shock (so the log sum thing would show up here).}

The new suggested approach is rather than first building the whole transition matrix across different all different states, this is computed ``on the fly'' where loops across states today then accumulate different possibilities and an $Ev$ is constructed. 

\item[\textbf{5.}] Given \textbf{3.} and \textbf{4.} we can update the value function using the bellman equation evaluated at the optimal policies:
\begin{align}
Tv_{ij}(a, z) = u(g_{c,ij}(a,z)) + \beta \mathrm{E}\left[ v(g_{a,ij}(a,z), z') \right]
\end{align}

\item[\textbf{6.}] Compare old and new policy functions, old and new value functions, and then update accordingly.

Note that $\textbf{4.}$ and $\textbf{5.}$ are trying to be smart about the time and memory intensive part which is finding the value function. This avoids the construction of the $Q$ matrix which is costly when it is done repeatedly and then inverting the $Q$ which is super costly especially when large. 

%\item[\textbf{5.}] Given the structure of $Q$, then just line (\ref{eq:utility_azj}) with $Q$ and invert to find value functions that are associated with each $(a,z,j)$ state. This takes the form where
%\begin{align}
%\vec{v} = (\mathbb{I} - \beta Q) \ / \  \vec{u} \label{eq:v_inversion}
%\end{align}
%where, again, each entry in $\vec{u}$ is an $(a,z,j)$ state and it conforms with the analogues entries in $Q$ of the $(a,z,j)$ states and then the resulting output $\vec{v}$ are the value functions corresponding with $(a,z,j)$ state.
%
%\item[\textbf{6.}] Given $v_{ij}(a,z)$ computed from (\ref{eq:v_inversion}), now compute choice probabilities using (\ref{eq:choice-prob}) for each $(a,z)$ combination.



\end{itemize}




\end{onehalfspacing}

\end{document} 