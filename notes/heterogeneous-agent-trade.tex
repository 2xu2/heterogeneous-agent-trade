\documentclass[12pt,pdftex]{article}
\usepackage[pdftex]{graphicx,color}
\usepackage{setspace,palatino,multirow}
\usepackage{amsmath,amssymb}
\usepackage{titlesec}
\usepackage{lscape}
%\usepackage{subfigure}
\usepackage{threeparttable}
\usepackage{natbib}
\bibliographystyle{ecta}
\usepackage{cite}
\usepackage{booktabs}
\usepackage{subcaption}
\usepackage{pdflscape}
\usepackage{afterpage}
\usepackage{xcolor}
\usepackage{rotating}

\definecolor{nblue}{RGB}{0,0,128}

\usepackage[pdftex,colorlinks=true, bookmarks=false,
pdfstartview={XYZ null null 0.65},
pdftitle={Heterogeneous Agent Trade},
pdfauthor={ Michael E. Waugh},
pdfkeywords={economics, trade, dynamics, quant econ, consumption, data science, cars,
waugh, incomplete markets, inequality, Ricardo, julia, migration, China, trade war, tariffs, python, matplotlib,
auto, difference in difference },
colorlinks=true,linkcolor=darkgray,citecolor=darkgray,urlcolor=darkgray,
breaklinks]{hyperref}

\newcounter{saveeqni}%
\newcounter{saveeqn01i}%
\newcommand{\alpheqni}{\setcounter{saveeqni}{\value{section}}%
%\setcounter{saveeqn01i}{\value{subsectioni}}%
\renewcommand{\theequation}
    {\alph{saveeqni}\mbox{.\arabic{equation}}}}%
\newcommand{\reseteqni}{\setcounter{equation}{\value{saveeqni}}%
\renewcommand{\theequation}{\arabic{equation}}}%

\newtheorem{as}{Assumption}
\newtheorem{reg}{Regularity Condition}
\newtheorem{conjecture}{Conjecture}
\newtheorem{corr}{Corollary}
\newtheorem{df}{Definition}
\newtheorem{lemma}{Lemma}
\newtheorem{prp}{Proposition}
\newtheorem{rmk}{Remark}
\newenvironment{prf}{{\bf Proof}}{\hfill { }}

\DeclareMathOperator*{\plim}{plim}
\DeclareMathOperator*{\umax}{max}

\special{papersize=8.5in,11in}
\onehalfspacing
\setlength{\parindent}{0.1em}
\setlength{\parskip}{.09in}
\textwidth15.75cm
\evensidemargin 1.5in
\oddsidemargin 1.5in
\topmargin 8.5cm
\textheight 10in
\hyphenation{over-lapping}

\titleformat{\section}{\color{black}\large\bf}{\color{black}{\thesection.}}{.25cm}{}
\titleformat{\subsection}{\color{black}\normalsize\bf}{\thesubsection.}{.5em}{}
\titleformat{\subsubsection}{\color{black}\normalsize\bf}{\thesubsubsection.}{.5em}{}

\titlespacing{\section}{0pt}{*1.5}{*.5}
\titlespacing{\subsection}{0pt}{*1.5}{*.5}
\titlespacing{\subsubsection}{0pt}{*1.5}{*.5}

\def\thesection{\arabic{section}}
\def\thesubsection{\arabic{section}.\arabic{subsection}}
\def\thesubsubsection{\arabic{section}.\arabic{subsection}.\Alph{subsubsection}}

\def\citeapos#1{\citeauthor{#1}'s (\citeyear{#1})}

\renewcommand{\arraystretch}{1.1}
\usepackage[margin=2cm]{geometry}

\begin{document}

\begin{onehalfspacing}

{\large \textbf{Heterogeneous Agent Trade}}

\vspace{1cm}

%{\textbf{PRELIMINARY AND INCOMPLETE}}
%
%\vspace{1cm}

\href{http://www.waugheconomics.com/}{Michael E. Waugh} \\ Federal Reserve Bank of Minneapolis and NBER

\vspace{0.5cm}

April 2022

\vspace{1.5cm}


\normalsize

ABSTRACT ------------------------------------------------------------------------------------------------------------

This paper develops a model of heterogenous agents and international trade. Heterogenous agents are modeled as in the standard incomplete markets tradition with household's facing incomplete insurance against idiosyncratic productivity and taste shocks. Trade in goods follows the Armington tradition but is derived from the ``bottom up'' with micro-level heterogeneity shaping the aggregate pattern of trade. In the efficient allocation, I recover standard results regarding gravity and the gains from trade. In the decentralized allocation, the pattern of trade is distorted, the aggregate trade elasticity is non-constant and the benefits from globalization are distributed unequally. I use model to explore two issues: the ability of trade policy to improve outcomes and how financial globalization complements trade in goods.

------------------------------------------------------------------------------------------------------------------------------
%%\vspace{0.25cm}
%
%%JEL Classification:
%%
%%
%%Keywords:

\vspace{6.5cm}

\footnotesize Email: michael.e.waugh@gmail.com. The views expressed herein are those of the author and not necessarily those of the Federal
Reserve Bank of Minneapolis or the Federal Reserve System. This project was developed with research support from the National Science Foundation (NSF Award number 1948800).

\hspace{-0.05cm}



\thispagestyle{empty}
\newpage
\normalsize

\section{The Model}

The model is setup in a simple and transparent way. Trade is in the Armigton tradition with each country producing a nationally differentiated variety. Households follow the standard incomplete markets tradition. The key departure is that I lean into household heterogeneity and have households make a discrete choice over the varieties they consume. Aggregate trade flows between countries are, thus, given by the explicit aggregation of households and the choices they make.

\subsection{Trade and Production}\label{sec:trade}

There are $M$ locations which I will call a country. Each country produces a differentiated product as in the Armington tradition and these differentiated products. In country $i$, competitive firms have the following production technology to produce variety $i$:
\begin{align}
q_i = A_i N_i,
\label{eq:production}
\end{align}
where $N_i$ are the efficiency units of labor supplied by households in country $i$.

Trade faces several obstacles. There are iceberg trade costs $d_{ji}$ for a good to go from supplier $i$ to buyer $j$. Cross-border trade faces policy obstacles, i.e. tariffs $\tau_{ji}$. The notation here is such that $\tau_{ji}$ which is the ad-valorem tariff rate that country $j$ imposes on the commodity that county $i$ produces.

Profit maximization of the competitive goods producers in location $i$ results in the wage per efficiency unit reflecting the value of the marginal product of labor
\begin{align}
w_{i} = p_{i} A_{i}.
\label{eq:marginal-product}
\end{align}
Given iceberg trade costs and tariffs, the unit cost for country $j$ to purchase a good from location $i$ is
\begin{align}
p_{ji} = \frac{d_{ji}(1 +\tau_{ji})w_{i}}{A_{i}}.
\label{eq:marginal-product-ship}
\end{align}

\subsection{Households}

There is a mass of $L_i$ households in each location $i$. Households are immobile across countries. They are infinite lived and have time-sparable preferences over non-durable consumption varieties:
\begin{align}
\small
E_{0} \sum_{t = 0}^{\infty} \beta^{t} u( \{ c_{jt} \}_{M}),
\end{align}
where the notation $\{ c_{jt} \}_{M}$ means that the household has preferences over all $j$ varieties supplied by $M$ countries in the world. My focus is on the situation where households each period receive additive Type 1 extreme value shocks $\epsilon(j)$ with dispersion parameter $\sigma_{\epsilon}$ and then households make a discrete choice about which variety $j$ to each period and a continuous choice about how much. More specifically, the utility associated with the choice of variety $j$ and leisure is
\begin{align}
u( c(j)_t ) =  \frac{ c_{jt} ^{1-\gamma}}{1- \gamma} + \epsilon(j)_t. \label{eq:utility}
\end{align}
where consumption mapped into utils with a standard CRRA function, $\epsilon(j)$ is the taste shock.

A household's efficiency units are stochastic and they evolve according to a discrete state Markov chain. Mathematically, $z$ is a households efficiently units and $\mathcal{P}(z,z')$ describes the probability of a household with state $z$ efficiency units transiting to state $z'$.

Households can save and borrow in a non-state contingent asset $a$. The units of the asset are chosen to be the numeraire and pays out with gross interest rate $R$. I discuss this more in depth below, but the determination of $R_{i}$ is either exogenously given or the rate that clears the bond market (local or global). An country specific, exogenous debt limit $\phi_{i}$ constrains borrowing so:
\begin{align}
a_{t+1} \geq - \phi_{i}.
\label{eq:borrowing-constraint}
\end{align}
All these pieces come together in the household's budget constraint, conditional on choosing variety $j$ to consume, and focusing on a stationary setting where prices and transfers are constant:
\begin{align}
a_{t+1} + p_{ij}c_{jt}  \leq    R_{i} a_{t} + w_{i} z_{t} + T_{i,\tau}.\label{eq:trade-budget-constraint}
\end{align}
The value of asset purchases and consumption expenditures must be less than or equal to asset payments, labor earnings, and transfers arising from trade policy (the $T_{i,\tau}$).

\subsection{Recursive Formulation of the Household Problem}

The state variables of a individual household are it's asset holdings and efficiency units. The aggregate states (and outcomes in other countries) only matter through prices and transfers and thus I summarize the aggregate state in country $i$ as $S_i = (\{ w_i \}_{M}, T_i, R_{i})$ which is the collection of the wage per efficiency units, transfers, and interest rates. The wage vector $\{ w_i \}_{M}$ is sufficient here since they determine prices in (\ref{eq:marginal-product-ship}) and, thus, consumers can make the appropriate choice of commodities.

The value function of a household in country $i$ is
\begin{align}
v_{i}(a, z; S_i) = &  \max_{j} \big  \{ \  v_{ij}(a, z; S_i)  \ \big \}
\label{eq:valuefun}
\end{align}
which is the maximum across the discrete choices of different national varieties. The value function conditional on a choice of variety is
\begin{align}
v_{ij}(a, z;  S_i  ) = &  \max_{\ a' }\bigg  \{ u(c(j))  + \beta \, \mathbb{E} [v_{i}(a', z'; S_i' )]  \bigg\}
\label{eq:value_fun_option} \\
\nonumber \\
\mbox{subject to}  \ & (\ref{eq:trade-budget-constraint}) \  \mathrm{and} \ (\ref{eq:borrowing-constraint}) \nonumber
\end{align}
where households choose asset holdings and the level of consumption is residually determined through the budget constraint. The continuation value function is the expectation over (\ref{eq:valuefun}) where the expectation is taken with respect to $z'$ and taste shocks in the future. What this last point means is that households understand that their may be situations where, e.g., they really desire the high priced imported good and, hence, save accordingly.

As is well known, the Type 1 extreme value shocks give rise to the following choice probabilities for each differentiated good. So
\begin{align}
\pi_{ij}(a, z; S_i) = \exp \left( \frac{ v_{ij}(a, z;  S_i ) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ v_{ij'}(a, z;  S_i ) }{\sigma_{\epsilon}} \right) \label{eq:choice-prob}
\end{align}
which is the probability that a household with assets $a$ and efficiency units $z$ chooses country variety $j$. And then the expectation of (\ref{eq:valuefun}) with respect to the taste shocks takes the familiar log-sum form
\begin{align}
\mathbb{E}_{\epsilon} v_i(a, z; S_i) = \sigma_{\epsilon} \log \left\{ \sum_{j'} \exp \left( \frac{  v_{ij}(a, z;  S_i )}{\sigma_{\epsilon}} \right) \right\} \label{eq:log_sum}
\end{align}
Associated with the problem (\ref{eq:valuefun}) are an asset policy function $g_{ij}(a, z; S_i)$ which prescribes asset holdings given a state and variety choice, and then define $c_{ij}(a, z; S_i)$ as the consumption function which prescribes consumption given states and variety choice.

\subsection{Aggregation}

Define the probability distribution of households across individual states $\lambda_{i}(a, z; S_i )$ which is the probability measure of households with asset levels $a$ individual shock $z$ in country $i$. This distribution evolves according to
\begin{align}
\lambda_i(a', z', S_i') = \sum_{z}\sum_{j} \sum_{a: a' = g_{ij}(a, z; S_i)} \pi_{ij}(a, z; S_i) \mathcal{P}(z, z') \lambda_i(a, z; S_i).
\label{eq:law_motion}
\end{align}

\textbf{Aggregate Labor Supply.}  Aggregate efficiency units are
\begin{align}
N_i = L_{i}\sum_{z} \sum_{a}\ z \lambda_i(a, z; S_i) \label{eq:ag-labor-supply}
\end{align}
where the inner most term reflects efficiency units multiplied by the measure of households with that state. This is all multiplied by $L_i$ which is the mass of households in country $i$.

\textbf{Asset Holdings.} The aggregate quantity of asset holdings simply sums across the distribution conditional on choosing
\begin{align}
\mathrm{A}_i' = L_{i} \sum_{z}\sum_{j}\sum_{a}  g_{ij}(a, z; S_i) \pi_{ij}(a, z; S_i) \lambda_i(a, z; S_i).
\label{eq:aggregate_asset}
\end{align}

\textbf{National Income and Consumption} Starting from the production side of our economy, the value of aggregate production must equal aggregate payments to labor so
\begin{align}
p_{i} Y_{i} = p_{i} A_{i} N_{i} = L_i \sum_{z} \sum_{a} w_{i} \ z \ \lambda_i(a, z; S_i)
\label{eq:value_production}
\end{align}
where the last term sums over wage payments for each household type. Then by summing over individual consumers' budget constraint and substituting in (\ref{eq:value_production}), we arrive at the aggregated budget constraint:
\begin{align}
p_{i} Y_{i}  = \widetilde{P_{i} C_i}  + \bigg[-R_i\mathrm{A_i} +  \mathrm{A_i'} \bigg] - T_{i,\tau},
\label{eq:aggregate_budget_constraint}
\end{align}
where national income equals the value of aggregate consumption $\widetilde{P_{i} C_i}$, the country's the net asset position, all net of transfers. Here the value of aggregate consumption is
\begin{align}
\widetilde{P_{i} C_i} = L_{i} \sum_{z}\sum_{j}\sum_{a}  p_{ij} c_{ij}(a, z; S_i) \pi_{ij}(a, z; S_i) \lambda_i(a, z; S_i)
\end{align}
where one can see a bug and a feature of this model. Here there is an ``index number problem`` in the sense that there is not an ideal price index for which one can decompose aggregate values in to a price and quantity component. This is in contrast to, e.g., a model where households consume a CES bundle of goods.

\textbf{Trade Flows} It's first worth walking though imports for a given set of states. So for households with states $a$ and $z$ we have
\begin{align}
M_{ij}(a, z; S_i) = p_{ij} c_{ij}(a, z; S_i).
\end{align}
Then aggregate imports from country $i$ to country $j$ sums over this weighted by the mass of households choosing variety $j$ and who in those states so
\begin{align}
M_{ij} = L_i \sum_{z}\sum_{a} M_{ij}(a, z; S_i) \pi_{ij}(a, z; S_i) \lambda_i(a, z; S_i).
\label{eq:imports}
\end{align}
The same can be done for a countries exports. Again, focusing on exports to a location given a set of states we have
\begin{align}
X_{ji}(a, z; S_j) = p_{ji} c_{ji}(a, z; S_j)
\end{align}
Then aggregate exports from country $i$ to country $j$
\begin{align}
X_{ji} = L_j \sum_{z}\sum_{a} X_{ji}(a, z; S_j) \pi_{ji}(a, z; S_j) \lambda_j(a, z; S_j)
\label{eq:exports}
\end{align}

\subsection{Market Clearing and the Decentralized Equilibrium}

Given the definitions above, I discuss the market clearing conditions than an equilibrium must respect.

\textbf{The Goods Market.} From here we can equate the value of production of commodity $i$ in country $i$ with global demand for country $i$'s commodity:
\begin{align}
p_{i} Y_{i} &= \sum_{j}^{M}  X_{ji} \label{eq:goods-supply},
\end{align}
where the left hand side is production and the right hand side is world demand for the commodity from (\ref{eq:exports}).

\textbf{The Bond Market.} The second market clearing condition is in the bond market. Two cases are considered ``financial globalization'' in which there is a global bond market with one real interest rate $R$. In this case the market clearing condition is
\begin{align}
\sum_{i}^{M} \mathrm{A_i'} = 0
\label{eq:bond-market-global}
\end{align}
which says that net asset demand must equal zero across all countries. The second case considerer is ``financial autarky'' in which there is a local bond market that facilitates within country risk-sharing, but not globally. In this case, there is an interest rate is $R_i$ for each country and the associated market clearing condition is
\begin{align}
\mathrm{A_i'} = 0 \ \ \forall i
\label{eq:bond-market-country}
\end{align}
Below is a formal definition of a Stationary Equilibrium when the aggregate state $S_i$ is constant and not changing.

\textbf{A Stationary Equilibrium.} A Stationary Equilibrium are asset policy functions and commodity choice probabilities $\{\  g_{ij}(a, z), \pi_{ij}(a, z) \ \}_{i}$, probability distributions $\lambda_i(a, z)$, and positive real numbers $\left \{w, p, R\right \}_{i}$ such that
\begin{itemize}
\vspace{-.4cm}
\item[i]  Prices ($w, p$) satisfy (\ref{eq:marginal-product}, \ref{eq:marginal-product-ship});
\item[ii] The policy functions and choice probabilities solve the household's optimization problem in (\ref{eq:value_fun});
\item[iv] The probability distribution $\lambda_i(a, z)$ induced by the policy functions, choice probabilities, and primitives satisfies (\ref{eq:law_motion}) and is a stationary distribution;
\item[v] Goods market clears:
\begin{align}
p_{i} Y_{i} - \sum_{j}^{M}  X_{ji} = 0, \ \ \forall i
\end{align}
\item[v] Bond market clears with either Financial Globalization with $R_i = R$ and
\begin{align}
\sum_{i}^{M} \mathrm{A_i'} = 0.
\label{eq:fg-condition}
\end{align}
Or Financial Autarky where
\begin{align}
\mathrm{A_i'} = 0, \ \ \forall i
\label{eq:fa-condition}
\end{align}
\end{itemize}

\subsection{The Centralized Equilibrium}

Before discussing some properties of the model, the Centralized (Efficient) Equilibrium is an important point of comparison. To characterize this equilibrium, I take a stand on the Social Welfare function and focus on a Utilitarian planner that places equal weight on all households in the global economy. Social welfare is:
\begin{align}
\mathcal{W} =\sum_{t=0}^{\infty}  \sum\limits_{z} \sum_{i} \sum_{j} \beta^{t} \  \bigg \{  u(c_{ij}(z, t) ) + \mathrm{E}[ \ \epsilon \ | \ \mu_{ij}(z,t) ] \bigg \}\mu_{ij}(z,t) L_{i} \lambda_{i}(z, t).
\label{eq:sp-social_welfare}
\end{align}
Working from the inside out, the inner most term is utility from consumption $c_{ij}(z, t)$ conditional on shock, country source and destination plus the expected value of the preference shocks conditional on shock-specific choice probabilities. The inner most term is weighted according to the measure of households in $i$ sourcing from $j$ $\mu_{ij}(z,t)$ times the total measure of households $L_{i}\lambda_{i}(z, t)$ in country $i$ with shock $z$ at date $t$. Then this is done at all dates $t$ and discounted at the same rate $\beta$ that households discount utility.

The Planner maximizes (\ref{eq:sp-social_welfare}) subject to several constraints. The first is the law of motion describing how the measure of households evolves across states
\begin{align}
\lambda_{i}(z', t+1)  & =   \sum_{z} \mathcal{P}(z, z') \lambda_{i}(z,  t).  \  \label{eq:planner_law_motion}
\end{align}
Given a distribution of households, the effective labor units in each country are
\begin{align}
N_{i,t} =&  L_i \sum_{z} z \lambda_{i}(z, t),
\label{eq:planner_labor_supply}
\end{align}
and then aggregate production of the final good is
\begin{align}
Y_{it} = A_i N_{i,t}.
\label{eq:planner_value_production}
\end{align}
Combining the amount of resources available in (\ref{eq:planner_value_production}) with the consumption and sourcing decisions yields the following resource constraint:
\begin{align}
Y_{it}\  \geq \ & \sum_{j} \sum_{z} d_{ji} c_{ji}(z, t) \mu_{ji}(z,t) L_{j}\lambda_{j}(z, t)
\label{eq:planner_rc}
\end{align}
which says that production must be greater than or equal to world consumption of variety $i$ inclusive of trade costs $d_{ji}$.

Given the social welfare function in \ref{eq:sp-social_welfare} and the constraints discussed above, the \textbf{Centralized Planner's Problem} is the following:
{\small
\begin{align}
\mathcal{W}^{*} = & \max\limits_{c_{i,j}(z, t),\ \mu_{i,j}(z, t)} \ \sum_{t=0}^{\infty}  \sum\limits_{z} \sum_{i} \sum_{j} \beta^{t} \  \bigg \{  u(c_{ij}(z, t) ) + \mathrm{E}[ \ \epsilon \ | \ \mu_{i,j}(z,t) ] \bigg \}\mu_{i,j}(z,t) L_{i} \lambda_{i}(z, t) \ \ \nonumber \\
\nonumber \\
& \ \ \mbox{subject to} \ \ (\ref{eq:planner_law_motion}) \ \ (\ref{eq:planner_value_production}) \ \ \mbox{and} \ \ (\ref{eq:planner_rc}) \ \ \mbox{and an inital condition} \ \ \lambda_i(z, 0).
\label{eq:planner_problem}
\end{align}
}

\textbf{A Stationary Centralized Planner Allocation.}  A Stationary Centralized Planner Allocation are time invariant policy functions $\{\ c_{i,j}(z),\ \mu_{i,j}(z) \ \}$, a probability distribution $\lambda_{i}(z)$, and positive real numbers $N_{i}$ for each country $i$ where:
\begin{itemize}
\item[i] The policy functions solve the Centralized Planner's Problem in (\ref{eq:planner_problem});
\item[ii] The probability distribution $\lambda_{i}(z)$ associated with (\ref{eq:planner_law_motion}) is a stationary distribution;
\item[iii] Effective labor units satisfy (\ref{eq:planner_labor_supply}).
\end{itemize}


\newpage



\subsection{Special Cases / Running Examples}

There are two special cases that I will refer back to repeatedly in the text. One is what I will call the CES case in which I mean that the household has access to a constant elasticity aggregator over the different varieties. The second case is the ``hand-to-mouth'' case in which households have no access to borrowing or lending.

\textbf{CES case.} This case is relatively familiar and standard. Here there is an aggregator over national varieties of the CES class, so
\begin{align}
c = \bigg \{ \sum_{j}^{M}  c_{j}^{\frac{\theta - 1}{\theta}} \bigg \}^{\frac{\theta}{\theta - 1}},
\label{eq:ces-armington}
\end{align}
where $\theta$ controls the elasticity of substitution across products. Then each household has the following demand curve for a region's variety:
\begin{align}
c_{ij}(a,z; S_i) & = \left(\frac{p_{ij}}{P_i}\right)^{-\theta}c_{i}(a,z; S_i).
\label{eq:ces-demand-curve}
\end{align}
which is given the total amount of consumption $c_{i}(a,z; S_i)$ a household chooses given their states and $P_i$ is the CES price index:
\begin{align}
P_{i} &= \bigg \{ \sum_{j}^{M} p_{ij}^{1 - \theta} \ \bigg \}^{\frac{1}{1-\theta}}.
\label{eq:ces-price-index}
\end{align}
what is unique about this setting is that household expenditure shares on different goods are independent of their state. So the expenditure share of a household in location $i$ with state $a$ and $z$ is
\begin{align}
\frac{p_{ij}c_{ij}(a,z; S_i)}{P_i c_{i}(a,z; S_i)} & = \left(\frac{p_{ij}}{P_i}\right)^{1-\theta},
\label{eq:ces-expenditure-share}
\end{align}
which depends only on prices that all households face. What is happening here is that the CES aggregator is homothetic in total consumption. So while households are choosing different levels of total consumption to solve their income-fluctuations problem, how that demand is divided up is always the same. From here, one can aggregate and arrive at a ``gravity-like'' import demand system with
households with states $a$ and $z$ importing
\begin{align}
M_{ij}(a, z; S_i) = p_{ij} \left(\frac{p_{ij}}{P_i}\right)^{-\theta} c_{i}(a,z; S_i).
\end{align}
Then aggregate imports from country $i$ to country $j$ sums over this weighted by the mass of households in those states which gives
\begin{align}
M_{ij} =  \left(\frac{p_{ij}}{P_i}\right)^{1-\theta} \times P_{i} C_{i}
\end{align}
where the last term follows by noting that the sum of $c_{i}(a,z; S_i)$ across the distribution is aggregate consumption and then this is put in value terms by multiplying and dividing by the CES price index.

\textbf{Hand-to-Mouth, No Labor Supply,Log Households.} This case focuses on the situation described|so there does not exist a risk free asset to smooth consumption, nor can households adjust their labor supply. The value function of a household contemplating the purchase of national variety $j$ is:
\begin{align}
v_{ij}(a, z;  S_i  ) = &   u\left( \frac{w_{i}z}{p_{ij}} \right) + \epsilon(j)  + \beta \, \mathbb{E} [v_{i}(z'; S_i' )]
\end{align}
and then the choice probability becomes
\begin{align}
\pi_{ij}(z; S_i) = & \exp \left( \frac{ v_{ij}(z;  S_i ) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ v_{ij'}(z;  S_i ) }{\sigma_{\epsilon}} \right) \\
\nonumber\\
\pi_{ij}(z; S_i) = & \exp \left( \frac{ u\left( \frac{w_{i}z}{p_{ij}} \right) ) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ u\left( \frac{w_{i}z}{p_{ij}} \right) }{\sigma_{\epsilon}} \right)
\end{align}
where the last line follows from the properties of the $\exp$ function and that the continuation value function is exactly the same independent of the good chosen. Two more steps. Then with $\log$ this expression collapses to
\begin{align}
\pi_{ij}(S_i) = \frac{p_{ij}^{-1 / \sigma_{\epsilon}}}{\sum_{j'} p_{ij'}^{-1 / \sigma_{\epsilon}}}
\end{align}
where here we recover the well known ``ces-logit-isomorphisim'' between the logit demand system and the CES aggregator in \ref{eq:ces-armington}.

%\section{When Household Heterogeneity Does Not Matter?}
%
%Before studying computational results. It's worth thinking about when and when not the household heterogeneity may not matter. In the first couple of remarks below, I abstract from issues related to tariffs
%
%\subsection{Issue \# 1: Trade Imbalance}
%
%To see how this works, let's connecting trade and financial flows. The trade side of the model in (\ref{sec:trade}) determines how aggregate demand in each country is sourced across different countries:
%\begin{align}
%P_{i}C_i  = p_{i}\bigg \{ \left(\frac{p_{i}}{P_i}\right)^{-\theta}C_i  \bigg \} +  \underbrace{\sum_{j \neq i}^{M}  p^{cif}_{ij}\bigg \{ \left(\frac{p_{ij}}{P_i}\right)^{-\theta}C_i
%\bigg \}}_{IM_{i}} + \underbrace{\sum_{j \neq i}^{M}  \tau_{ij} p^{cif}_{ij} \bigg \{ \left( \frac{p_{ij}}{P_{j}} \right)^{-\theta}C_i \bigg \}}_{T_{i,\tau}}.
%\label{eq:goods-supply-imports}
%\end{align}
%where $p^{cif}_{ij} = \frac{d_{ji} w_{i}}{A_{i}}$, so these prices including shipping costs, but exclude tariffs. Imports here are defined as ``customs value'' per NIPA guidelines, i.e., the price paid for foreign goods excluding tariffs. Substituting in (\ref{eq:goods-supply-imports}) into the (\ref{eq:goods-supply-exports}) and then into the aggregated budget constraint (\ref{eq:aggregate_budget_constraint}) implies the following relation:
%\begin{align}
%\underbrace{\sum_{j \neq i}^{M}  p_{ji}\bigg \{ \left(\frac{p_{ji}}{P_j}\right)^{-\theta}\big [ C_j \big ]\bigg \}}_{EX_{i}} \ - \ \underbrace{\sum_{j \neq i}^{M}  p_{ij}\bigg \{ \left(\frac{p_{ij}}{P_i}\right)^{-\theta}[ C_i  \big ] \bigg \}}_{IM_{i}}  = \bigg[-R\mathrm{A_i} +  \mathrm{A_i'} \bigg]
%\label{eq:imbalance}
%\end{align}
%that is the trade imbalance must equal the net asset position of a country.
%
%From this condition, one can show how this reduces to standard relationships exploited in the trade literature. First, consider the case of Financial Autarky, so that condition (\ref{eq:fa-condition}) holds. Net asset holdings in each country are zero (though recall, gross asset positions for individual households within a country may be non-zero). This implies
%\begin{align}
%\underbrace{\sum_{j \neq i}^{M}  p_{ji}\bigg \{ \left(\frac{p_{ji}}{P_j}\right)^{-\theta}\big [ C_j \big ]\bigg \}}_{EX_{i}} \ = \ \underbrace{\sum_{j \neq i}^{M}  p_{ij}\bigg \{ \left(\frac{p_{ij}}{P_i}\right)^{-\theta}[ C_i  \big ] \bigg \}}_{IM_{i}},
%\label{eq:imbalance_v2}
%\end{align}
%or balanced trade. There is one more step, however, what shows up in (\ref{eq:imbalance}) is demand $C_i$, not supply or income. But from the aggregated budget constraint, and abstracting from tariffs, condition (\ref{eq:fa-condition}), implies that the value of output (and labor income) must equal the value of consumption
%\begin{align}
%p_{i} Y_{i}  = P_{i}  C_i ,
%\end{align}
%and after substituting in the relationship between wages and prices we have
%\begin{align}
%\underbrace{\sum_{j \neq i}^{M}  p_{ji}\bigg \{ \left(\frac{p_{ji}}{P_j}\right)^{-\theta} \left( \frac{ w_j N_j }{P_j} \right) \bigg \}}_{EX_{i}} \ = \ \underbrace{\sum_{j \neq i}^{M}  p_{ij}\bigg \{ \left(\frac{p_{ij}}{P_i}\right)^{-\theta}\left( \frac{w_i N_i}{P_i}  \right) \bigg \}}_{IM_{i}},
%\label{eq:imbalance_v3}
%\end{align}
%which is the same exact system of equations explored in canonical trade models. Alvarez Lucas is probably best example. What else?
%
%There is one more issue which is addressed next. In this system of equations is $N_i$ shows up ant it's labor supply.
%
%\subsection{Issue \# 2: Labor Supply and Market Incompleteness}
%
%Obviously set N exogenous recovers everything.
%
%Work out efficient allocation. N is different? What about $\frac{dw}{d\tau}$?
%
%\subsection{Issue \# 3: Tariffs and Insurance}
%
%When lump-sum rebated, the implied distribution of potential labor earnings contracts? easy to show? This is like some of the tax progressivity stuff.




\appendix

\clearpage
\newpage

\begin{center}
\textbf{\Large Appendix}
\end{center}

\addcontentsline{toc}{section}{Appendices}


%\section{Appendix: Static Logit Trade Model}
%
%This case focuses on the most basic model of household heterogeneity: static, log preferences, logit shocks and is a key point of contact.  The value function of a household contemplating the purchase of national variety $j$ is:
%\begin{align}
%v_{ij}( z ) = &   \log\left( \frac{w_{i} z}{p_{ij}} \right) + \epsilon(j)
%\end{align}
%and then the choice probability becomes
%\begin{align}
%\pi_{ij}(z) = & \exp \left( \frac{ v_{ij}(z) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ v_{ij'}(z) }{\sigma_{\epsilon}} \right) \\
%\nonumber\\
%\pi_{ij}(z) = & \exp \left( \frac{ \log\left( \frac{w_{i}z}{p_{ij}} \right) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{  \log\left( \frac{w_{i}z}{p_{ij}} \right) }{\sigma_{\epsilon}} \right)
%\end{align}
%with the $\log$ specification this expression collapses to
%\begin{align}
%\pi_{ij} = \frac{p_{ij}^{\frac{-1}{\sigma_{\epsilon}}}}{\sum_{j'} p_{ij'}^{\frac{-1}{\sigma_{\epsilon}}}}
%\end{align}
%as wages an efficiency units cancel. To arrive at an expression for aggregate imports, note that individual imports are
%\begin{align}
%M_{ij}(z) = p_{ij} \frac{w_{i}z}{p_{ij}}.
%\end{align}
%then aggregate imports from country $i$ to country $j$ sums over this weighted by the mass of households in those states which gives
%\begin{align}
%M_{ij} = \sum_{z} p_{ij} \frac{w_{i}z}{p_{ij}} \pi_{ij} \lambda(z) \\
%\nonumber \\
%M_{ij} = \pi_{ij} \sum_{z} w_{i}z \lambda(z)\\
%\nonumber \\
%M_{ij} =  \frac{p_{ij}^{\frac{-1}{\sigma_{\epsilon}}}}{\sum_{j'} p_{ij'}^{\frac{-1}{\sigma_{\epsilon}}}} \times \widetilde{P_{i} C_{i}}
%\end{align}
%where the last term follows from imposing the aggregated budget constraint with aggregate labor income equalling aggregate expenditure. Then to get towards something that looks like \citet{eaton2002technology} substitute in the unit shipping costs from (\ref{eq:marginal-product-ship}) and set $-\theta = -1/ \sigma_{\epsilon}$ yielding:
%\begin{align}
%M_{ij} =  \frac{A_j^{\theta}(w_jd_{ij})^{-\theta}}{\sum_{j'} A_j^{\theta}(w_jd_{ij})^{-\theta}} \times \widetilde{P_{i} C_{i}}
%\end{align}
%and it becomes immediate that the trade share (imports divided by consumption) is $\pi_{ij}$.
%
%Given this representation of trade flows, I'm going to derive the ``trade elasticity'' and then welfare. I'll define the trade elasticity as the following:
%\begin{align}
%\frac{\partial \pi_{ij} / \pi_{ii}}{\partial d_{ij}} \times \frac{d_{ij}}{\pi_{ij} / \pi_{ii}}
%\end{align}
%or the percent change in trade relative to domestic trade due to a change in trade costs which is our labeling of the elasticity in \citet{simonovska2014elasticity}. In this setup the ``trade elasticity'' is:
%\begin{align}
%\frac{\partial \pi_{ij} / \pi_{ii}}{\partial d_{ij}} \times \frac{d_{ij}}{\pi_{ij} / \pi_{ii}} = -\theta
%\end{align}
%so it simply reflects the dispersion parameter $\sigma_{\epsilon}$.
%
%I can also derive the \citet{arkolakis2012new} sufficient statistic welfare result. Expected utility  prior to the realization of the tastes shocks is:
%\begin{align}
%\mathcal{W} = \sigma_{\epsilon} \log \bigg \{ \sum_{j'} \exp \left( \frac{ v_{ij'}(z) }{\sigma_{\epsilon}} \right) \bigg \}
%\end{align}
%which again with log preferences can be written as:
%\begin{align}
%\mathcal{W} = \sigma_{\epsilon} \log w_{i}^{\frac{1}{\sigma_{\epsilon}}} \ + \sigma_{\epsilon} \log \bigg \{ \sum_{j'} p_{ij'}^{\frac{-1}{\sigma_{\epsilon}}} \bigg \}
%\end{align}
%I'm always free to make one normalization on prices, so a convenient one is to set $w_i = 1.0$. This then implies from \ref{eq:marginal-product-ship} that $p_{ii} = 1 / A_{i}$ and then the countries home share is
%\begin{align}
%\pi_{ii} = \frac{A_i^{\frac{1}{\sigma_{\epsilon}}}}{\sum_{j'} p_{ij'}^{\frac{-1}{\sigma_{\epsilon}}}}
%\end{align}
%or
%\begin{align}
%\pi_{ii}^{-1}A_i^{\frac{1}{\sigma_{\epsilon}}} = \sum_{j'} p_{ij'}^{\frac{-1}{\sigma_{\epsilon}}}
%\end{align}
%And then substituting into the welfare expression gives
%\begin{align}
%\mathcal{W} = \log A_{i}  - \sigma_{\epsilon} \log \pi_{ii}
%\end{align}
%which is, essentially the \citet{arkolakis2012new} expression. The only substantive difference is that the expression above are in units of utils. To put this in consumption units, take the exponent and then swap into the $\theta$ notation and one has:
%\begin{align}
%\mathcal{\tilde W} = A_{i} \pi_{ii}^{\frac{-1}{\theta}}
%\end{align}
%which is exactly the \citet{arkolakis2012new} expression. The following proposition summarizes the result:
%
%\begin{prp}[\textbf{Static Heterogeneity: Gravity, and Welfare}] \label{apx-prp:static} In the static model with log preferences and logit preference shocks where $\theta = 1 / \sigma_{\epsilon}$, the decentralized allocation is characterized a Gravity equation for country $i$'s imports from country $j$:
%{\small
%\begin{align}
%M_{ij} =  \frac{A_j^{\theta}(w_jd_{ij})^{-\theta}}{\sum_{j'} A_j^{\theta}(w_jd_{ij})^{-\theta}} \times \widetilde{P_{i} C_{i}}
%\label{appendix-eq:static-gravity}
%\end{align}
%}
%where the trade elasticity defined as
%\begin{align}
%\frac{\partial ( M_{ij} / M_{ii} )}{\partial d_{ij}} \times \frac{d_{ij}}{( M_{ij} / M_{ii} )} = -\theta,
%\end{align}
%and is determined by the dispersion of the preferences shocks. Finally the welfare gains from trade in consumption units are summarized by
%\begin{align}
%\mathcal{\tilde W} = A_{i} \pi_{ii}^{\frac{-1}{\theta}}
%\end{align}
%where $\pi_{ii}$ a country $i$'s share of consumption expenditure on goods from itself.
%\end{prp}

\section{The Generalized Trade Elasticity}

My definition of the trade elasticity is the partial equilibrium response of imports from $j$ relative to domestic consumption due to a permanent change in trade costs between steady states. By partial equilibrium, I mean that wages and interest rates as fixed at their initial equilibrium values. By permanent, I work this out under the heuristic of a ``steady-state to steady-state comparison'' where I factor in how the stationary distribution changes due to changes in behavior. This definition is consistent with the broad terminology used in the trade literature, e.g. \citet{arkolakis2012new} and \citet{simonovska2014elasticity}. Consistent with this discussion and the notation below, I compute the partial derivatives (not total) of objects with respect to trade costs.

Mathematically, the trade elasticity equals the difference between the elasticities for how trade between $i$ and $j$ change minus how home trade changes:
\begin{align}
\frac{\partial ( M_{ij} / M_{ii} )}{\partial d_{ij}} \times \frac{d_{ij}}{( M_{ij} / M_{ii} )} =& \frac{\partial ( M_{ij} / M_{ij} )}{\partial d_{ij} / d_{ij}}  - \frac{\partial ( M_{ij} / M_{ii} )}{\partial d_{ij} / d_{ij}}.
\label{eq:def_trade_elasticity}
\end{align}
The change in imports between $i$ and $j$ with respect to a change in trade costs is:
\begin{align}
\frac{\partial  M_{ij}}{\partial d_{ij}} = \sum_{a,z} \bigg \{ \frac{\partial p_{ij}c_{ij}(a,z)}{\partial d_{ij}} \pi_{ij}(a,z)\lambda(a,z) +
 \frac{\partial \pi_{ij}(a,z)}{\partial d_{ij}} p_{ij}c_{ij}(a,z)\lambda(a,z)  +
\frac{\partial \lambda(a,z)}{\partial d_{ij}} p_{ij}c_{ij}(a,z)\pi_{ij}(a,z) \bigg \}.
\end{align}
Divide the stuff on the inside of the brackets by household level imports $p_{ij}c_{ij}(a,z)\pi_{ij}(a,z) \lambda(a,z)$ and multiply on the outside giving,
\begin{align}
\frac{\partial  M_{ij}}{\partial d_{ij}} = \sum_{a,z} \bigg \{ \frac{\partial p_{ij}c_{ij}(a,z)/ p_{ij}c_{ij}(a,z)}{\partial d_{ij}} +
 \frac{\partial \pi_{ij}(a,z) / \pi_{ij}(a,z)}{\partial d_{ij}}  +
\frac{\partial \lambda(a,z) / \lambda(a,z)}{\partial d_{ij}} \bigg \} p_{ij}c_{ij}(a,z)\pi_{ij}(a,z) \lambda(a,z).
\end{align}
Define the following weight which is the share of goods that those with states $a,z$ account for in total expenditures from $j$ as
\begin{align}
\omega_{ij}(a,z) = \frac{p_{ij}c_{ij}(a,z)\pi_{ij}(a,z) \lambda(a,z)}{M_{ij}}.
\end{align}
where the sum of $\omega_{ij}(a,z)$ equals total imports $M_{ij}$. This gives a nice expression for the import elasticity
\begin{align}
\frac{\partial  M_{ij} / M_{ij}}{\partial d_{ij} / d_{ij}} = \sum_{a,z} \bigg \{ \underbrace{ \frac{\partial p_{ij}c_{ij}(a,z)/ p_{ij}c_{ij}(a,z)}{\partial d_{ij} / d_{ij}} }_{\theta_{ij}(a,z)^{I}}+
\underbrace{\frac{\partial \pi_{ij}(a,z) / \pi_{ij}(a,z)}{\partial d_{ij} / d_{ij}} }_{\theta_{ij}(a,z)^{E}} +
\underbrace{\frac{\partial \lambda(a,z) / \lambda(a,z)}{\partial d_{ij} / d_{ij}}}_{\theta_{ij}(a,z)^{D}} \bigg \} \omega_{ij}(a,z)
\end{align}
or more succinctly as
\begin{align}
\frac{\partial  M_{ij} / M_{ij}}{\partial d_{ij} / d_{ij}} = \sum_{a,z} \bigg \{ \theta_{ij}(a,z)^{I} + \theta_{ij}(a,z)^{E} + \theta_{ij}(a,z)^{D} \bigg \}\omega_{ij}(a,z)
\end{align}
where the elasticity of aggregate imports into $i$ from $j$ is a weighted average of three different micro-level elasticities. The micro-level elasticities are:
\begin{itemize}
\item[\textbf{(i)}] An intensive margin trade elasticity $\theta_{ij}(a,z)^{I}$ which reflects the change in spending by a household on variety from $j$ as trade costs decline.

\item[\textbf{(ii)}]  The next term is the extensive margin trade elasticity $\theta(a,z)_{ij}^{E}$ which reflects how households substitute across varieties as trade costs decline. As I show below in Section \ref{}, this takes the place as the standard trade elasticity in, e.g., \citet{eaton2002technology}.

\item[\textbf{(iii)}] The distribution elasticity $\theta(a,z)_{ij}^{D}$ so how the mass of agents change across household states $a,z$. This last elasticity may seem a bit odd as being present in a partial equilibrium elasticity. But I include it hear because the flip side of changes in the intensive and extensive margin is that household saving behavior (even at fixed wages and interest rates) generally will change with the commodity choice. It's in this sense that it's a relevant margin to keep track of.
\end{itemize}

Given the expression in (\ref{eq:def_trade_elasticity}), Proposition \ref{apx-prp:GET} follows:

\begin{prp}[\textbf{The Generalized Trade Elasticity}] \label{apx-prp:GET} The trade elasticity between country $i$ and country $j$ is:
{\footnotesize
\begin{align}
\theta_{ij} = \sum_{a,z} \bigg \{ \theta_{ij}(a,z)^{I} + \theta_{ij}(a,z)^{E} + \theta_{ij}(a,z)^{D} \bigg \}\omega_{ij}(a,z) - \bigg \{ \theta_{ii}(a,z)^{I} + \theta_{ii}(a,z)^{E} + \theta_{ii}(a,z)^{D} \bigg \}\omega_{ii}(a,z)
\label{eq:apx-trade-elasticity}
\end{align}
}which is the difference in expenditure weighted micro-level elasticities. The micro-level elasticities for households with states $a,z$ are decomposed into an intensive, extensive, and distributional elasticity
{\footnotesize
\begin{align}
\nonumber
\theta_{ij}(a,z)^{I} = \frac{\partial p_{ij}c_{ij}(a,z)/ p_{ij}c_{ij}(a,z)}{\partial d_{ij} / d_{ij}}, \ \ \ \ \ \ \theta_{ij}(a,z)^{E} = \frac{\partial \pi_{ij}(a,z) / \pi_{ij}(a,z)}{\partial d_{ij} / d_{ij}}, \ \ \ \ \
\theta_{ij}(a,z)^{D} = \frac{\partial \lambda(a,z) / \lambda(a,z)}{\partial d_{ij} / d_{ij}}
\end{align}
}
and the expenditure weights are defined as
{\footnotesize
\begin{align}
\nonumber
\omega_{ij}(a,z) = \frac{p_{ij}c_{ij}(a,z)\pi_{ij}(a,z) \lambda(a,z)}{M_{ij}}
\end{align}
}
\end{prp}
An interesting feature of Proposition \ref{apx-prp:GET} is that it's derived only off the aggregation of imports at the micro level|no market clearing, functional forms, etc. However, by using the households budget constraint and the Type 1 extreme value distributional assumption more can be said about these elasticities and illustrate how the household's consumption-savings problem matters.

\textbf{The Intensive Margin Trade Elasticity.} By using the households budget constraint one can express the intensive margin elasticity as
\begin{align}
\underbrace{\frac{\partial p_{ij}c_{ij}(a,z)/ p_{ij}c_{ij}(a,z)}{\partial d_{ij} / d_{ij}}}_{\theta_{ij}(a,z)^{I}} &= -\frac{\partial g_{ij}(a,z)}{\partial p_{ij}/ p_{ij}} \frac{ \partial p_{ij}/ p_{ij}}{\partial d_{ij}/ d_{ij}} \times \frac{1}{p_{ij}c_{ij}(a,z)}, \\
\nonumber \\
&= -\frac{\partial g_{ij}(a,z)}{\partial p_{ij}/ p_{ij}} \times \frac{1}{p_{ij}c_{ij}(a,z)},
\label{eq:apx-intensive-margin}
\end{align}
where recall that $g_{ij}(a,z)$ is the policy function mapping states into asset holdings next period $a'$ and the last line follows from $\frac{ \partial p_{ij}/ p_{ij}}{\partial d_{ij}/ d_{ij}} = 1$. What this means is that the intensive margin elasticity is about a households consumption-savings behavior, i.e., how a household adjusts assets given a change in the price $p_{ij}$.

To be concrete, the way this works is that a reduction in trade costs lowers prices and relaxes the budget constraint, and then the intensive margin elasticity depends on how the new resources available to spend are dived between assets and consumption. In the static case where assets are not held, then any change in the price $p_{ij}$ is offset by a change in consumption and this elasticity is zero.

\textbf{The Extensive Margin Trade Elasticity.} The Type 1 extreme value distributional assumption allows for a sharp characterization of the choice probability and, hence, how the choice probabilities change. As a first step, define the denominator of the choice probability as:
\begin{align}
\Phi_{i}(a,z) = \sum_{j'} \exp \left( \frac{ v_{ij'}(a, z) }{\sigma_{\epsilon}} \right).
\end{align}
The elasticity of the choice probability with respect to a change in trade costs is
\begin{align}
\underbrace{ \frac{\partial \pi_{ij}(a,z) / \pi_{ij}(a,z)}{\partial d_{ij} / d_{ij}} }_{\theta_{ij}(a,z)^{E}} &= \frac{1}{\sigma_{\epsilon}}\frac{\partial v_{ij}(a,z)}{\partial d_{ij}/d_{ij}} -  \frac{\partial \Phi_{i}(a,z) / \Phi_{i}(a,z)}{\partial d_{ij}/d_{ij}}.
\label{eq:apx-extensive-margin}
\end{align}
The first term reflects how the choice specific value function changes with trade costs. In other words, how much more valuable does choice $j$ become when it's cheaper to import variety $j$. The second term reflects the fact that the change choice $j$ depends upon a comparison relative to the overall change in the value of options across variety, i.e., how $\Phi_{i}$ changes.

Admittedly, the terms in (\ref{eq:apx-extensive-margin}) are complicated objects: their state dependent and forward looking with the value functions showing up. More subtle is the fact that the household's income fluctuations problem imposes a cross-equation restriction between the intensive margin elasticity in and extensive margin given how assets and consumption are responding to changes in prices via changes in trade costs. This last point becomes more transparent when looking at the distribution margin trade elasticity.

\textbf{The Distribution Trade Elasticity.} I can connect the intensive and extensive margin trade elasticities with how the distribution changes in the following way. First, notice that the mass of households $\lambda(a,z)$ depends if a function of the asset policy function $g_{ij}(a,z)$ and the choice probability $\pi_{ij}(a,z)$. Represent this function as
\begin{align}
%why does this only dependon i,j%
\lambda(a,z) = f_{\lambda}(\pi_{ij}(a,z),g_{ij}(a,z)),
\end{align}
Then we can express how the distribution changes
\begin{align}
\frac{\partial \lambda(a,z)/\lambda(a,z)}{\partial d_{ij}/d_{ij}}  = \frac{\partial f_{\lambda, 1} / f_{\lambda} }{\partial d_{ij}/d_{ij}} \frac{\partial \pi_{ij}(a,z)}{\partial d_{ij}} +  
\frac{\partial f_{\lambda, 2} / f_{\lambda} }{\partial d_{ij}/d_{ij}} \frac{\partial g_{ij}(a,z)}{\partial d_{ij}} 
\label{eq:apx-distribution-margin}
\end{align}
which emphasizes the point that how the distribution changes is fundamentally interlinked to the behaviorial responses of households through how they substitute across products and how they substitute across time.

\section{The Welfare Gains from Trade}

This section derives the gains from a permanent change in trade costs, across steady states. Like the discussion above, the idea here is that I'm thinking a situation where the change is small and there is an immediate jump to the new steady state. Unlike the trade elasticity, I'm going to take total derivatives that will encompass general equilibrium changes in wages and interest rates.

The analysis proceeds in several steps. To compute how social welfare changes, I'll focus on a utilitarian social welfare function so:
\begin{align}
W_{i} = \sum_{a,z} v_{i}(a,z)\lambda(a,z)
\label{eq:apx-social-welfare}
\end{align}
Then the total change in total welfare is
\begin{align}
\frac{\mathrm{d} W_{i}}{\mathrm{d} d_{ij} / d_{ij}} = \sum_{a,z} \bigg \{ \frac{\mathrm{d} v_i(a, z)}{\mathrm{d} d_{ij} / d_{ij}}  + v_{i}(a,z) \frac{\mathrm{d} \lambda(a,z)/ \lambda(a,z)}{\mathrm{d} d_{ij} / d_{ij}}  \bigg \} \lambda(a,z).
\label{eq:apx-social-welfare-change}
\end{align}
What illustrates is that the gains from trade come through two forces. The first component reflects changes in household-level welfare. So conditional on a distribution of households across states, are housholds better or worse off. The second component is about reallocation, i.e., if|at the old $v$'s|does the distribution change so that social welfare gets better or worse. The change in social welfare is then the weighted average of these two forces with the weights being those at the initial distribution.

How does household-level welfare change? With the Type 1 extreme value distribution some progress can be made in several steps. First, notice that I can  express everything relative to the home country $i$. Recall that the value function is
\begin{align}
v_i(a, z) =  \sigma_{\epsilon} \log \left\{ \sum_{j'} \exp \left( \frac{  v_{ij}(a, z)}{\sigma_{\epsilon}} \right) \right\},
\end{align}
and then I'm going to make the observation that I can substitute out the sum part with the exp of the home value function relative to the micro-level ``home choice''
\begin{align}
v_i(a, z) =  \sigma_{\epsilon} \log \left\{ \frac{ \exp \left( \frac{  v_{ii}(a, z)}{\sigma_{\epsilon}}\right )}{\pi_{ii}(a,z)}  \right\}
\end{align}
and thus the value function can be represented as
\begin{align}
v_i(a, z) = -\sigma_{\epsilon} \log \pi_{ii}(a,z) + u(c_{ii}(a,z)) + \beta \mathbb{E} v_{i}(g_{ii}(a,z),z)
\label{eq:apx-home-valuefun}
\end{align}
The key innovation here is that now everything is written with respect to the home choice. This is essentially the dynamic analog to Equation (15), Footnote 42 of \citet{eaton2002technology} and \citet{arkolakis2012new} and I explicitly show this in the example section below.

Now the strategy is to totally differentiate (\ref{eq:apx-home-valuefun}) with respect to trade costs and use the recursive structure to iterate forward and construct the change across time. Furthermore, in all of this, I set $w_i$ to be the numeraire and $A_i = 1$ so $p_{ii}$ equals one and needs not be carried around. One more detail, to facilitate interpretation, it will be useful to compute the Euler equation associated with asset holdings when the borrowing constraint does not bind. This euler equation is:
\begin{align}
-u'(c_{ii}(a,z)) = \beta \mathbb{E} \bigg \{ -\sigma_{\epsilon} \frac{\partial \pi_{ii}(a',z') / \pi_{ii}(a',z')}{\partial a'} + u'(c_{ii}(a',z'))R \bigg \},
\end{align}
which says that the agent should be indifferent between the marginal utility of consumption forgone to hold some more assets and two components (i) the benefit from how a change in assets changes in their variety choice and (ii) the direct benefit of the returns on the assets evaluated at the marginal utility of consumption.

\hrulefill

Redo. Digression on chain rule. I'm going to 
\begin{align}
v(g(a,z,d), z')
\end{align}
so the first term inside indicates that $v$ depends upon the choice of $a$ and the dependence of $v$ on $d$ (and not through assets) is implicit. Then the total derivative of this nested function is
\begin{align}
\frac{\mathrm{d} v(g(a,z,d), z')}{\mathrm{d} d} =& \frac{\partial v}{\partial a}\frac{\mathrm{d}g}{\mathrm{d}d} +  \frac{\partial v(\overline{g(a,z,d)},z')}{\partial d}
\end{align}
So this says, the first term is the partial change of $v$ with respect to $z$ given how the policy function totally changes with respect to $d_{ij}$. The second term is the partial change of $v$, \textbf{holding fixed assets} at their chosen level. That's why I'm emphasizing the bar on top. Now what is confusing to me is that this has partial, not total derivatives. But this term is mathematically the same as
\begin{align}
\frac{\partial v(\overline{g(a,z,d)},z')}{\partial d} = \frac{\mathrm{d} v_i(a', z')}{\mathrm{d} d_{ij} / d_{ij}}
\end{align}
where the last line is the total derivative of $v$ treating $a'$ as a parameter. In other words, the LHS says, how does $v$ change (everything else) holding fixed assets. The RHS says how does everything else change holding fixed assets. 

\hrulefill

Totally differentiating the value function gives
\begin{align}
\frac{\mathrm{d} v_i(a, z)}{\mathrm{d} d_{ij} / d_{ij}} =& \nonumber  \\
\nonumber \\
 -\sigma_{\epsilon} & \frac{\mathrm{d} \pi_{ii}(a,z) / \pi_{ii}(a,z)}{\mathrm{d}d_{ij} / d_{ij}}  + u'(c_{ii}(a,z))\frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}a - u'(c_{ii}(a,z))\frac{\mathrm{d} g_{ii}(a,z)}{\mathrm{d} d_{ij} / d_{ij}}
+ \beta E \frac{\mathrm{d} v_i(g_{ii}(a,z), z')}{\mathrm{d} d_{ij} / d_{ij}}
\end{align}
Then the derivative of the continuation value function is:
\begin{align}
& \frac{\mathrm{d} v_i(g(a,z), z')}{\mathrm{d} d_{ij} / d_{ij}} = \underbrace{\bigg [-\sigma_{\epsilon} \frac{\partial \pi_{ii}(a',z') / \pi_{ii}(a',z')}{\partial a'} + u'(c_{ii}(a',z'))R \bigg ]}_{\frac{\partial v_i(g_{ii}(a,z), z')}{\partial a}}\frac{\mathrm{d} g_{ii}(a,z)}{\mathrm{d} d_{ij} / d_{ij}} \ \ + \\
\nonumber \\
& -\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a',z') / \pi_{ii}(a',z')}{\mathrm{d}d_{ij} / d_{ij}}   + u'(c_{ii}(a',z'))\frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}a' - u'(c_{ii}(a',z'))\frac{\mathrm{d} g_{ii}(a',z')}{\mathrm{d} d_{ij} / d_{ij}}
+ \beta E \frac{\mathrm{d} v_i(g_{ii}(a',z'), z'')}{\mathrm{d} d_{ij} / d_{ij}}
\end{align}
And now combine and collect terms so
\begin{align}
\frac{\mathrm{d} v_i(a, z)}{\mathrm{d} d_{ij} / d_{ij}} =& -\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a,z) / \pi_{ii}(a,z)}{\mathrm{d}d_{ij} / d_{ij}} \\
\nonumber \\
& + \underbrace{u'(c_{ii}(a,z))\frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}a}_{\gamma_{ii}(a,z)}  \\
\nonumber \\
& + \underbrace{\bigg \{- u'(c_{ii}(a,z)) + \beta \mathbb{E} \big [-\sigma_{\epsilon} \frac{\partial \pi_{ii}(a',z') / \pi_{ii}(a',z')}{\partial a'} + u'(c_{ii}(a',z'))R \big ] \bigg \}\frac{\mathrm{d} g_{ii}(a,z)}{\mathrm{d} d_{ij} / d_{ij}}}_{\delta_{ii}(a,z)} \\
\nonumber \\
& + \beta \mathbb{E} \bigg \{ -\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a,z) / \pi_{ii}(a,z)}{\mathrm{d}d_{ij} / d_{ij}} +  u'(c_{ii}(a',z'))\frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}a' \ \  \ldots
\label{eq:apx-welfare-vterms}
\end{align}
Let me walk through the interpretation of each term:
\begin{itemize}
\item $-\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a,z) / \pi_{ii}(a,z)}{\mathrm{d}d_{ij} / d_{ij}}$ is the standard gains from trade term reflecting the idea that gains work through changes in expenditures across different varieties. With static logit, this is exactly the ACR formula.
    
\item $u'(c_{ii}(a,z))\frac{\partial R}{\partial d_{ij} / d_{ij}}a$ or what I'm labeling as $\gamma_{ii}(a,z)$ is what I would call how trade facilitates more risk sharing. I think as trade costs decline the amount of resources available for risk sharing expands and this changes the interest rate. Which way does it go?

\item The third term which I'm labeling as $\delta_{ii}(a,z)$  is the Euler equation for assets. Honestly, it's pretty cool the way this shows up here. The idea is that if the household is unconstrained, then this term is zero as there is no gain through changes in asset behavior. Asset holdings are already chosen optimally so that margins are equated, thus, on the margin any benefit of lower trade costs on changes in asset behavior is zero. Essentially an application of the Envelope Theorem.

    Now in this economy, this term may not be zero because of borrowing constrained households, thus this term is positive and may (see below) represent a gain from trade. What this is picking up is that a change in trade costs are relaxing the constraints on some households and get's them back on their euler equation.

    Finally, notice how the outside brackets is multiplied by the change in the asset policy function. Again, this is super cool. What this picks up is that if the household is still constrained, then assets can't change so the outside term is zero and, thus, overall the second term is zero. So the only people that benefit and contribute to social welfare through these effects are those on the margin between constrained and not-constrained.

\item The final term is about this continuing on into the infinite future.
\end{itemize}
Iterating on (\ref{eq:apx-welfare-vterms}) into the future, the gains from trade for a household with states $a,z$ today are
\begin{align}
\frac{\partial v_i(a, z)}{\partial d_{ij} / d_{ij}} = \mathbb{E} \sum_{t = 0}^{\infty} \beta^{t} \bigg \{ -\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a_{t},z_{t}) / \pi_{ii}(a_{t},z_{t})}{\mathrm{d}d_{ij} / d_{ij}} + \gamma_{ii}(a_{t},z_{t}) + \delta_{ii}(a_{t},z_{t}) \bigg \}
\label{eq:apx-welfare-v}
\end{align}
Where the first component is the expected discounted gains from substitution, gains from risk sharing and the relaxation of borrowing constraints. Combining (\ref{eq:apx-welfare-v}) and (\ref{eq:apx-social-welfare-change}) yields the following proposition for the gains from trade

\begin{prp}[\textbf{The Welfare Gains from Trade}] \label{apx-prp:gains-trade} The welfare gains from trade are given by
{\footnotesize
\begin{align}
\frac{\mathrm{d} W_{i}}{\mathrm{d} d_{ij} / d_{ij}} = \sum_{a,z} \bigg \{ \frac{\mathrm{d} v_i(a, z)}{\mathrm{d} d_{ij} / d_{ij}}  + v_{i}(a,z) \frac{\mathrm{d} \lambda(a,z)/ \lambda(a,z)}{\mathrm{d} d_{ij} / d_{ij}}  \bigg \} \lambda(a,z).
\nonumber
\end{align}
}which reflects the change in household level gains and how the distribution of households changes. Household level gains are given by
{\footnotesize
\begin{align}
\nonumber
\frac{\partial v_i(a, z)}{\partial d_{ij} / d_{ij}} = \mathbb{E} \sum_{t = 0}^{\infty} \beta^{t} \bigg \{ -\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a_{t},z_{t}) / \pi_{ii}(a_{t},z_{t})}{\mathrm{d}d_{ij} / d_{ij}} + \gamma_{ii}(a_{t},z_{t}) + \delta_{ii}(a_{t},z_{t}) \bigg \}
\end{align}
}where each term represents:
\begin{itemize}
\item Gains from substitution: $-\sigma_{\epsilon} \frac{\mathrm{d} \pi_{ii}(a,z) / \pi_{ii}(a,z)}{\mathrm{d}d_{ij} / d_{ij}}$.

\item Gains from risk sharing: $\gamma_{ij}(a,z) = u'(c_{ii}(a,z))\frac{\mathrm{d} R}{\mathrm{d} d_{ij} / d_{ij}}a$

\item Gains from relaxing borrowing constraints:
\begin{align}
\nonumber
\delta_{ii}(a,z) = \bigg \{- u'(c_{ii}(a,z)) + \beta \mathbb{E} \big [-\sigma_{\epsilon} \frac{\partial \pi_{ii}(a',z') / \pi_{ii}(a',z')}{\partial a'} + u'(c_{ii}(a',z'))R \big ] \bigg \}\frac{\mathrm{d} g_{ii}(a,z)}{\mathrm{d} d_{ij} / d_{ij}}
\end{align}
\end{itemize}
\end{prp}
Proposition \ref{apx-prp:gains-trade} nests several interesting cases that connect with the literature and further illustrate the mechanics.

\subsection{Static, Log Preferences}

The first is the non-assets, static, log preference case. This delivers the benchmark gains from trade formula in \citet{arkolakis2012new}. The first step is to derive the trade elasticity. A couple insights are necessary. First, from (\ref{eq:apx-intensive-margin}) and because there is no asset choice the intensive margin elasticity $\theta_{ij}(z)^I$ is zero, i.e. any change in prices is fully offset by a change in consumption. Second, because there is no asset choice and household level shocks are exogenously specified, then the distribution elasticity is zero. Third, the choice probabilities become independent of household level productivity, so
\begin{align} 
\pi_{ij}(z) &= \exp \left( \frac{ \log\left( \frac{w_{i}z}{p_{ij}} \right) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{  \log\left( \frac{w_{i}z}{p_{ij'}} \right) }{\sigma_{\epsilon}} \right) \\
\nonumber \\
\pi_{ij} &= \exp \left( \frac{ \log\left( p_{ij} \right) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{  \log\left( p_{ij'} \right) }{\sigma_{\epsilon}} \right).
\end{align}
And thus, the $\Phi_{i}(z)$ showing up in the extensive margin calculation (\ref{eq:apx-extensive-margin}) is independent of $z$.  Then the final observation is that the partial derivative of the $i,j$ choice value function $\frac{\partial v_{ij}(a,z)}{\partial d_{ij}/d_{ij}} = -1$ and zero everywhere else. Then following Proposition \ref{apx-prp:GET} and (\ref{eq:apx-trade-elasticity}) the trade elasticity is
\begin{align}
\nonumber
\theta_{ij} =& \sum_{z} \bigg \{ 0 + -\frac{1}{\sigma_{\epsilon}} - \frac{\partial \Phi_{i} / \Phi_{i}}{\partial d_{ij}/d_{ij}} \ + 0 \bigg \}\omega_{ij}(z) - \sum_{z} \bigg \{  0 - \frac{\partial \Phi_{i} / \Phi_{i}}{\partial d_{ij}/d_{ij}} + 0 \bigg \}\omega_{ii}(z) \\
\nonumber \\
\theta =& -\frac{1}{\sigma_{\epsilon}} \nonumber
\end{align}
which just reflects the dispersion in tastes and it's independent of country pairs. In other words, the trade elasticity is constant and parameterized. Combining these observations and mechanically following Proposition \ref{apx-prp:gains-trade} the gains from trade are
\begin{align}
\frac{\mathrm{d} W_{i}}{\mathrm{d} d_{ij} / d_{ij}} = -\frac{1}{\theta} \times \frac{\mathrm{d} \pi_{ii} / \pi_{ii}}{\mathrm{d}d_{ij} / d_{ij}}
\end{align}
which is exactly the \citet{arkolakis2012new} formula. The change in welfare gains from equal the inverse of trade elasticity multiplied by how much the home trade share changes.

\begin{corr}[\textbf{ACR 2012}] In the static heterogenous agent trade model the trade elasticity is
\begin{align}
\theta = -\frac{1}{\sigma_{\epsilon}} \nonumber
\end{align}
and the gains from trade are given by
\begin{align}
\frac{\mathrm{d} W_{i}}{\mathrm{d} d_{ij} / d_{ij}} = -\frac{1}{\theta} \times \frac{\mathrm{d} \pi_{ii} / \pi_{ii}}{\mathrm{d}d_{ij} / d_{ij}}.
\end{align}
\end{corr}

\subsection{Dynamic, Log Preferences}


\newpage


\section{Appendix: Endogenous Grid Method}

First, I'm going to derive the Euler equation for this model. I'll abstract from the situation in which the HH is at the borrowing constraint.

Focus on the within a variety choice component, the households value function can be written as:
\begin{align}
v_{ij}(a, z) = \max_{a'} u \left( \frac{R_i a + w_i z - a'}{p_{ij}} \right) + \beta  \mathrm{E} v(a', z')
\end{align}
then the first order condition associated with this problem is:
\begin{align}
\frac{u'(c_{ij}(a, z))}{p_{ij}} = \beta \mathrm{E} \frac{\partial v(a', z')}{\partial a'}
\end{align}
which is saying that, conditional on a variety choice the left hand side is the loss in consumption units which is $1 / p_{ij}$ evaluated at the marginal utility of consumption and then this is set equal to the marginal gain from saving a bit more which is how the value function changes with respect to asset holdings. Now we can arrive at the $\frac{\partial v(a', z')}{\partial a'}$ in the following way, so start from the log-sum expression for the expected value function
\begin{align}
\mathbb{E}_{\epsilon} v(a', z') =  \sigma_{\epsilon} \log \left\{ \sum_{j'} \exp \left( \frac{  v_{ij}(a', z')}{\sigma_{\epsilon}} \right) \right\}
\end{align}
and then differentiate this with respect to asset holdings which gives:
\begin{align}
\frac{\partial \mathbb{E}_{\epsilon} v(a', z')}{\partial a'} = \left( \frac{\sigma_{\epsilon}}{\sum_{j'} \exp \left( \frac{  v_{ij}(a', z')}{\sigma_{\epsilon}}\right)} \right)
\left[ \sum_{j'} \exp \left( \frac{  v_{ij}(a', z')}{\sigma_{\epsilon}}\right) \frac{1}{\sigma_{\epsilon}} \frac{\partial v_{ij}(a', z')}{\partial a'}  \right]
\end{align}
Then if you look at this carefully and notices how the choice probabilities from (\ref{eq:choice-prob}) are embedded in here, we have:
\begin{align}
\frac{\partial \mathbb{E}_{\epsilon} v(a', z')}{\partial a'} = \sum_{j'} \pi_{ij}(a', z) \frac{\partial v_{ij}(a', z')}{\partial a'}
\end{align}
and then we can just apply the Envelop theorem to the value functions associated with the discrete choices across the options:
\begin{align}
\frac{\partial \mathbb{E}_{\epsilon} v(a', z')}{\partial a'} = \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))R_{i}}{p_{ij}}
\end{align}
So then putting everything together we have:
\begin{align}
\frac{u'(c_{ij}(a, z))}{p_{ij}} = \beta R_{i} \mathrm{E}_{z'} \left[ \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))}{p_{ij}} \right]
\end{align}
where this has a very natural form: you set the marginal utility of consumption today equal to the marginal utility of consumption tomorrow adjusted by the return on delaying consumption, and the expected value of the marginal utility of consumption which reflects how the uncertainty over both ones' preference over different varieties and shocks to efficiency units. Taking into account the borrowing constraint then gives the generalized Euler equation from which the endogenous grid method will exploit:
\begin{align}
\frac{u'(c_{ij}(a, z))}{p_{ij}} = \max \left\{ \beta R_{i} \mathrm{E}_{z'} \left[ \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))}{p_{ij}} \right] \ , \  u \left( \frac{R_i a + w_i - \phi_{i}}{p_{ij}} \right) \right \}
\label{eq:euler_equation}
\end{align}

\subsection{EGM-Discrete Choice Algorithm}

Here is a proposed approach. This focuses on just the consumer side in one country $i$.
\begin{itemize}
\item[\textbf{0.}] Set up an asset grid as usual. Then guess (i) a consumption function $g_{c,ij}(a,z)$ for each $a$, $z$, and product choice $j$ and (ii) choice specific value function $v_{ij}(a,z)$.

\item[\textbf{1.}] Compute the choice probabilities from (\ref{eq:choice-prob}) for each $(a,z)$ combination, given the guessed value functions.

\item[\textbf{1.}] Given the consumption function and choice probabilities compute the RHS of (\ref{eq:euler_equation}) first.

\item[\textbf{2.}] Then invert to find the new updated consumption choice so
\begin{align}
c_{ij}(\tilde a, z) = u^{' -1}\left\{ p_{ij} \max \left\{ \beta R_{i} \mathrm{E}_{z'} \left[ \sum_{j'} \pi_{ij}(a', z') \frac{u'(c_{ij}(a', z'))}{p_{ij}} \right] \ , \  u \left( \frac{R_i a + w_i - \phi_{i}}{p_{ij}} \right) \right \} \right \}
\end{align}
where $u^{' -1}$ is the inverse function of the marginal utility of consumption.

Side note: One of the interesting things about this equation is that the direct $j$ component on the RHS that only affects the consumption choice is through the price. Can this be exploited? We also know the choice probabilities need to sum to one, so is there a way to map the consumption choice into the choice probabilities? Also, can interpolation be done once how $p$ scales things...

\item[\textbf{3.}] The key issue in this method is that we have found  $c_{ij}(\tilde a, z)$ where the consumption function is associated with some asset level that is not necessarily on the grid. The solution is to (i) use the budget constraint and infer $\tilde a$ given that $a'$ was chosen above (that's where we started), $z$, and $c_{ij}(\tilde a, z)$. Now we have a map from $\tilde a$ to $a'$ for which one can use interpolation to infer the $a'$ chosen given $a$ where $a$ is on the grid.

\item Do steps \textbf{2.} and \textbf{3.} for each $j$ variety choice. This then makes the function $g_{a,ij}(a,z)$ mapping each state and $j$ choice (today) into $a', z'$ states and then from the budget constraint we have an associated consumption function $g_{c,ij}(a,z)$

\item[\textbf{4.}] Compute the $\mathrm{E}\left[ v(g_{a,ij}(a,z), z') \right]$. This is performed in the {\tt{make\_Tv\_upwind!}} function. It fixes a country $j$, then works through shocks and asset states today and from the policy function $g_{a,ij}(a,z)$ figures out the asset choice tomorrow. Then the $\mathrm{E}\left[ v(g_{a,ij}(a,z), z') \right]$ is (\ref{eq:log_sum}) over the different variety choices tomorrow (this is the integration over $\epsilon$) multiplied by the probability of $z'$ occurring (this is the integration over $z$).

\item[\textbf{5.}] Given \textbf{4.} update the value function using the bellman equation evaluated at the optimal policies:
\begin{align}
Tv_{ij}(a, z) = u(g_{c,ij}(a,z)) + \beta \mathrm{E}\left[ v(g_{a,ij}(a,z), z') \right]
\end{align}

\item[\textbf{6.}] Compare old and new policy functions, old and new value functions, and then update accordingly.


%\item[\textbf{5.}] Given the structure of $Q$, then just line (\ref{eq:utility_azj}) with $Q$ and invert to find value functions that are associated with each $(a,z,j)$ state. This takes the form where
%\begin{align}
%\vec{v} = (\mathbb{I} - \beta Q) \ / \  \vec{u} \label{eq:v_inversion}
%\end{align}
%where, again, each entry in $\vec{u}$ is an $(a,z,j)$ state and it conforms with the analogues entries in $Q$ of the $(a,z,j)$ states and then the resulting output $\vec{v}$ are the value functions corresponding with $(a,z,j)$ state.
%
%\item[\textbf{6.}] Given $v_{ij}(a,z)$ computed from (\ref{eq:v_inversion}), now compute choice probabilities using (\ref{eq:choice-prob}) for each $(a,z)$ combination.
\end{itemize}

\section{Appendix: The Planning Problem}
The Lagrangian associated with the Centralized Planning problem is:
\begin{align}
\mathcal{L}  = & \sum_{t=0}^{\infty}  \sum\limits_{z} \sum_{i} \sum_{j} \beta^{t} \  \bigg \{  u(c_{ij}(z, t) ) + \mathrm{E}[ \ \epsilon \ | \ \mu_{ij}(z,t) ] \bigg \}\mu_{ij}(z,t) L_{i} \lambda_{i}(z, t), \\
\nonumber \\
&+ \sum_{t=0}^{\infty} \sum_{i} \chi_{i}(t) \bigg \{ Y_{it} \  - \ \sum_{j} \sum_{z} d_{ji} c_{ji}(z, t) \mu_{ji}(z,t) L_{j}\lambda_{j}(z, t) \bigg \} \nonumber \\
\nonumber \\
&+ \sum_{t=0}^{\infty} \sum_{i} \chi_{2i}(t) \bigg \{1 - \sum_{j}\mu_{ij}(z,t) \bigg \} L_{i} \lambda_{i}(z, t) \nonumber
\label{eq:pp}
\end{align}
Then associated with this problem are two first order conditions. The first one is consumption in $i$ with respect to variety $j$ so:
\begin{align}
\frac{\partial \mathcal{L} }{\partial c_{ij}(z, t)} &=  \beta^{t} u'(c_{ij}(z, t)) \mu_{ij}(z,t) L_{i} \lambda_{i}(z, t) - \chi_{j}(t) d_{ij} \mu_{ij}(z,t) L_{i} \lambda_{i}(z, t) = 0 \\
\nonumber \\
& \Rightarrow \ \ \beta^{t} u'(c_{ij}(z, t) ) = \chi_{j}(t) d_{ij},
\end{align}
which says that the marginal utility of consumption of ($i$ consuming variety $j$) should equal $j$'s multiplier adjusted by the trade cost $d_{ij}$. Then notice that the right hand size is independent of $z$, thus within variety choice we have the result that $u'(c_{ij}(z, t)) = u'(c_{ij}(z', t)) = u'(\bar c_{ij}(t))$ for all $z, z'$ combinations. Then the ratio of marginal utility across variety $j$ is:
\begin{align}
\frac{u'(\bar c_{ij}(t))}{u'(\bar c_{ij'}(t))} = \frac{\chi_{j}(t) d_{ij}}{\chi_{j'}(t) d_{ij'}}
\end{align}
which is starting to look like a gravity type regression where the $\chi$'s are related to the price index in the source countries, adjusted by the iceberg trade costs (e.g. equation (5) in SW for example). To be more concrete, compare $i,j$ purchases from $i,i$ purchases and with log utility one has
\begin{align}
\frac{\bar c_{ij} }{ \bar c_{ii}} = \frac{\chi_{i}(t)}{\chi_{j}(t)}d_{ij}^{-1}
\end{align}
which is quite close to a gravity equation where relative consumption equals a source and destination effect adjusted by the trade costs. Key differences are that this is in quantities, not expenditure; this does not reflect the extensive margin; and related to this last point is that the elasticity is $\gamma$.

%\section{Appendix: Dynamic Log-Logit Trade Model}
%
%This section explores the following problem:
%\begin{align}
%v_{i}(a, z; S_i) = &  \max_{ij} \big  \{ \  v_{ij}(a, z; S_i)  \ \big \}
%\label{eq:valuefun_log}
%\end{align}
%which is the maximum across the discrete choices of different national varieties. The value function conditional on a choice of variety is
%\begin{align}
%v_{ij}(a, z;  S_i  ) = &  \max_{\ a' }\bigg  \{ \log(c_{ij})  + \beta \, \mathbb{E} [v_{i}(a', z'; S_i' )]  \bigg\}
%\label{eq:value_fun_option_log} \\
%\nonumber \\
%\mbox{subject to}  \ & (\ref{eq:trade-budget-constraint}) \  \mathrm{and} \ (\ref{eq:borrowing-constraint}) \nonumber
%\end{align}
%where the only restriction now is that preferences are restricted to be $\log$. A couple of observations is that the choice specific value function can be written as
%\begin{align}
%v_{ij}(a, z;  S_i  ) = &  \max_{\ a' }\bigg  \{ \log\left (\frac{Ra + wz - a'}{p_{ij}} \right )  + \beta \, \mathbb{E} [v_{i}(a', z'; S_i' )]  \bigg\}
%\end{align}
%which is then
%\begin{align}
%v_{ij}(a, z;  S_i  ) = &  \max_{\ a' }\bigg  \{ \log(Ra + wz - a' )  + \beta \, \mathbb{E} [v_{i}(a', z'; S_i' )]  \bigg\} - \log p_{ij}
%\label{eq:value_fun_option_log_p}
%\end{align}
%which then leads to the observation that the optimal $a'$ conditional on a choice $j$ is \textbf{independent} of the price of the consumption good. So what is going on is if you consume an expensive or cheap good, then consumption simply scales up or down so that assets next period are exactly the same. This was verified on the computer. Another approach is to conjecture this policy function and plug it into the euler equation above and show that it respects it.
%
%Then the choice probability becomes
%\begin{align}
%\pi_{ij}(a, z; S_i) = & \exp \left( \frac{ v_{ij}(a, z;  S_i ) }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ v_{ij'}(a, z;  S_i ) }{\sigma_{\epsilon}} \right) \\
%\nonumber\\
%\pi_{ij} = & \exp \left( \frac{  -\log p_{ij} }{\sigma_{\epsilon}} \right) \Bigg / \sum_{j'} \exp \left( \frac{ -\log p_{ij} }{\sigma_{\epsilon}} \right)\\
%\nonumber \\
%\pi_{ij} = & \frac{p_{ij}^{\frac{-1}{\sigma_{\epsilon}}}}{\sum_{j'} p_{ij'}^{\frac{-1}{\sigma_{\epsilon}}}}
%\end{align}
%where the second line follows from (\ref{eq:value_fun_option_log_p}) which is exactly the same as discussed above in the static model.

%With that said, there are a couple of illustrative cases.
%\begin{itemize}
%  \item \textbf{Static Logit}: Here there is no asset choice and forward looking component
%  \begin{align}
%  \theta_{ij}(z)^{E}  = & \ \frac{u'(c_{ij}(z))}{\sigma}\frac{\partial c_{ij}(z)}{\partial d_{ij}/d_{ij}} -  \frac{\partial \Phi_{i}(z) / \Phi_{i}(z)}{\partial d_{ij}/d_{ij}} \\
%  \nonumber \\
%     = & \ \frac{u'(c_{ij}(z))c_{ij}(z)}{\sigma} -  \frac{\partial \Phi_{i}(z) / \Phi_{i}(z)}{\partial d_{ij}/d_{ij}}
%  \end{align}
%  and focusing on the first part says that the extensive margin trade elasticity is related to the marginal utility of consumption multiplied by the level of consumption (does this have a meaning?). Even in the static case, there is a sense in which the trade elasticity would depend upon income via the state $z$.
%
%  In the case of log preferences, these issues partially disappear with the extensive margin elasticity becoming
%  \begin{align}
%       = & \ \frac{1}{\sigma} -  \frac{\partial \Phi_{i} / \Phi_{i}}{\partial d_{ij}/d_{ij}}
%  \end{align}
%  and it's this result in that would deliver a constant, aggregate trade elasticity the second term cancels (shown below).
%
%  \item \textbf{Dynamic Log-Logit}: Interestingly, this case collapses to something that is similar to the Static Log-Logit. The insight is the because the asset policy function does not depend upon the variety choice, then the continuation value function is common across choices and, thus, it cancels in the numerator and denominator of the choice probabilities. Thus the extensive margin trade elasticity becomes
%        \begin{align}
%       \theta_{ij}(a, z)^{E} = & \ \frac{1}{\sigma} -  \frac{\partial \hat \Phi_{i} / \hat \Phi_{i}}{\partial d_{ij}/d_{ij}}
%     \end{align}
%     where the $\hat \Phi$ is the value of the denominator after continuation value functions and period utility functions are canaled out.
%\end{itemize}
%\textbf{Distribution Elasticity} This is where the asset dimension comes into play and it picks up the idea that a change in trade costs would shift the distribution across states. Per the discussion above, it is only relevant in the non-log, dynamic case. Changes in the distribution of households across asset states arise primarily because the intensive margin elasticity is not zero.
%
%
%Then from here one can see how things collapse or are generalized depending upon the case. First, let's look at each elasticity state by state. Also note that these are partial equilibrium elasticities, they don't take into account how wages or interest rates change in response to clear the goods or asset market.
%
% Here are two special cases:
%\begin{itemize}
%  \item \textbf{Static Discrete Choice}: Here there is no asset choice and thus the intensive margin trade elasticity is
%  \begin{align}
%  \theta_{ij}(z)^{I} = 0
%  \end{align}
%  which means that any change in prices via a change in trade costs maps one for one into a change in consumption and hence $p_{ij}c_{ij}(z)$ is constant.
%  \item \textbf{Dynamic Log + Discrete Choice:} This cases is interesting because assets are being held, but as argued above in (\ref{eq:value_fun_option_log_p}) asset holdings are independent of the variety choice $j$. Hence they are independent of the change in trade costs $d_{ij}$ and we have
%  \begin{align}
%  \theta_{ij}(a,z)^{I} = 0
%  \end{align}
%  so what is happening here is that with log preferences is that the price elasticity of consumption is minus one. A one percent decrease in prices leads to a one percent increase in consumption and when viewed through the budget constraint, this implies that assets are not changing with respect to prices. This result has a second implication that the distribution elasticity $\theta(a,z)_{ij}^{D}$ is unchanging even though assets are being held. That is in the log preference case there is not a reshuffling of households across states in the stationary distribution.
%\end{itemize}
%\bigskip
%
%\textbf{The Aggregate Trade Elasticity} Recall that my definition of the aggregate trade elasticity is the change in relative trade and home consumption or
%\begin{align}
%&\frac{\partial ( M_{ij} / M_{ii} )}{\partial d_{ij}}  \times \frac{d_{ij}}{( M_{ij} / M_{ii} )} = \\
%\nonumber \\
%& \sum_{a,z} \bigg \{ \theta_{ij}(a,z)^{I} + \theta_{ij}(a,z)^{E} + \theta_{ij}(a,z)^{D} \bigg \}\omega_{ij}(a,z) - \bigg \{ \theta_{ii}(a,z)^{I} + \theta_{ii}(a,z)^{E} + \theta_{ii}(a,z)^{D} \bigg \}\omega_{ii}(a,z)
%\end{align}
%and again we can collapse this into several well known cases.
%\begin{itemize}
%  \item \textbf{Static Logit}:
%  \begin{align}
%\frac{\partial ( M_{ij} / M_{ii} )}{\partial d_{ij}}  \times \frac{d_{ij}}{( M_{ij} / M_{ii} )} =& \ \ \sum_{z} \theta_{ij}(z)^{E}\omega_{ij}(z) - \theta_{ii}(z)^{E} \omega_{ii}(z)
%\end{align}
%where the aggregate trade elasticity is a expenditure weighted average of the micro extensive margin elasticities. Then with log preferences
%\begin{align}
% =& \sum_{z} \bigg \{ \underbrace{\frac{1}{\sigma} -  \frac{\partial \Phi_{i}(z) / \Phi_{i}(z)}{\partial d_{ij}/d_{ij}}}_{\theta_{ij}(z)^{E}}
%+ \ \ \underbrace{\frac{\partial \Phi_{i}(z) / \Phi_{i}(z)}{\partial d_{ij}/d_{ij}}}_{\theta_{ii}(z)^{E}} \bigg \} \frac{z\lambda(z)}{\sum_{z}z\lambda(z)}
%\nonumber \\
% =& \ \ \frac{1}{\sigma}
%\end{align}
%where the first line follows from the definition of the micro elasticities and then that with log preferences $\omega_{ij}(z) = \lambda(z)$ because the level of consumption and
%
%
%
%\end{itemize}

\newpage

\bibliography{./bibtex/micro_price_bibtex}

\end{onehalfspacing}

\end{document} 